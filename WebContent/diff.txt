=== modified file '.classpath'
--- .classpath	2010-04-14 09:15:26 +0000
+++ .classpath	2010-09-29 10:08:18 +0000
@@ -88,5 +88,19 @@
 	<classpathentry kind="lib" path="C:/Workspace/libs/vinopedialibs/xml-apis-ext.jar"/>
 	<classpathentry kind="lib" path="C:/Program Files/Apache/Tomcat 5.5/common/lib/commons-el.jar"/>
 	<classpathentry kind="lib" path="C:/Program Files/Apache/Tomcat 5.5/common/lib/jasper-compiler.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/cobra-no-commons.jar" sourcepath="C:/Temp/Lobo/src/XAMJ_Project"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/lobo.jar" sourcepath="C:/Temp/Lobo/src/XAMJ_Project"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/lobo-pub.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/javafxc.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/javafxgui.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/javafxrt.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/javafx-swing.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/jlfgr-1_0.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/jmc.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/jweb-ext.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/primary.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/Scenario.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/websvc.jar"/>
+	<classpathentry kind="lib" path="C:/Temp/Lobo/ext/js.jar"/>
 	<classpathentry kind="output" path="WEB-INF/classes"/>
 </classpath>

=== modified file 'WEB-INF/EN-language.properties'
--- WEB-INF/EN-language.properties	2010-09-21 09:04:18 +0000
+++ WEB-INF/EN-language.properties	2010-09-22 11:46:21 +0000
@@ -18,7 +18,7 @@
 countryofretailer=Country of Retailer
 country=Country
 showwinesaddedinthelast=Show wines added in the last
-displaycurrency=Display currency
+displaycurrency=Currency
 currency=Currency
 suggestions=Suggestions
 sitetitle=vinopedia: Compare prices of wines

=== modified file 'WEB-INF/classes/com/freewinesearcher/batch/Coordinates.class'
Binary files WEB-INF/classes/com/freewinesearcher/batch/Coordinates.class	2009-09-29 10:20:01 +0000 and WEB-INF/classes/com/freewinesearcher/batch/Coordinates.class	2010-09-29 10:08:22 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/batch/CurrencyClient.class'
Binary files WEB-INF/classes/com/freewinesearcher/batch/CurrencyClient.class	2009-09-29 10:20:01 +0000 and WEB-INF/classes/com/freewinesearcher/batch/CurrencyClient.class	2010-09-29 10:08:22 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/batch/ProducersOld.class'
Binary files WEB-INF/classes/com/freewinesearcher/batch/ProducersOld.class	2010-05-03 15:10:31 +0000 and WEB-INF/classes/com/freewinesearcher/batch/ProducersOld.class	2010-09-29 10:08:22 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/batch/Spider.class'
Binary files WEB-INF/classes/com/freewinesearcher/batch/Spider.class	2010-09-21 09:04:18 +0000 and WEB-INF/classes/com/freewinesearcher/batch/Spider.class	2010-09-29 10:08:22 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/batch/XpathWineScraper.class'
Binary files WEB-INF/classes/com/freewinesearcher/batch/XpathWineScraper.class	2009-09-29 10:20:01 +0000 and WEB-INF/classes/com/freewinesearcher/batch/XpathWineScraper.class	2010-09-29 10:08:22 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Knownwines.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Knownwines.class	2010-02-14 15:11:41 +0000 and WEB-INF/classes/com/freewinesearcher/common/Knownwines.class	2010-09-29 10:08:22 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Webpage.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Webpage.class	2010-09-21 09:04:18 +0000 and WEB-INF/classes/com/freewinesearcher/common/Webpage.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Wine$bestDealComparator.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Wine$bestDealComparator.class	2010-03-16 08:48:38 +0000 and WEB-INF/classes/com/freewinesearcher/common/Wine$bestDealComparator.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Wine$pqratioComparator.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Wine$pqratioComparator.class	2010-03-16 08:48:38 +0000 and WEB-INF/classes/com/freewinesearcher/common/Wine$pqratioComparator.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Wine$priceComparator.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Wine$priceComparator.class	2010-03-16 08:48:38 +0000 and WEB-INF/classes/com/freewinesearcher/common/Wine$priceComparator.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Wine$ratingComparator.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Wine$ratingComparator.class	2010-03-16 08:48:38 +0000 and WEB-INF/classes/com/freewinesearcher/common/Wine$ratingComparator.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Wine$relativepriceComparator.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Wine$relativepriceComparator.class	2010-03-16 08:48:38 +0000 and WEB-INF/classes/com/freewinesearcher/common/Wine$relativepriceComparator.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Wine$vintageComparator.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Wine$vintageComparator.class	2010-03-16 08:48:38 +0000 and WEB-INF/classes/com/freewinesearcher/common/Wine$vintageComparator.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/freewinesearcher/common/Wine.class'
Binary files WEB-INF/classes/com/freewinesearcher/common/Wine.class	2010-03-16 08:48:38 +0000 and WEB-INF/classes/com/freewinesearcher/common/Wine.class	2010-09-29 10:08:21 +0000 differ
=== modified file 'WEB-INF/classes/com/searchasaservice/ai/Aitools.class'
Binary files WEB-INF/classes/com/searchasaservice/ai/Aitools.class	2010-09-21 09:04:18 +0000 and WEB-INF/classes/com/searchasaservice/ai/Aitools.class	2010-09-29 10:08:20 +0000 differ
=== modified file 'WEB-INF/classes/com/searchasaservice/ai/Recognizer.class'
Binary files WEB-INF/classes/com/searchasaservice/ai/Recognizer.class	2010-09-21 09:04:18 +0000 and WEB-INF/classes/com/searchasaservice/ai/Recognizer.class	2010-09-29 10:08:20 +0000 differ
=== modified file 'WEB-INF/classes/com/searchasaservice/parser/HTMLParser.class'
Binary files WEB-INF/classes/com/searchasaservice/parser/HTMLParser.class	2009-09-29 10:20:01 +0000 and WEB-INF/classes/com/searchasaservice/parser/HTMLParser.class	2010-09-29 10:08:20 +0000 differ
=== modified file 'WEB-INF/classes/com/searchasaservice/parser/xpathparser/Analyzer.class'
Binary files WEB-INF/classes/com/searchasaservice/parser/xpathparser/Analyzer.class	2010-04-14 09:15:26 +0000 and WEB-INF/classes/com/searchasaservice/parser/xpathparser/Analyzer.class	2010-09-30 08:55:40 +0000 differ
=== modified file 'WEB-INF/classes/com/searchasaservice/parser/xpathparser/XpathParser.class'
Binary files WEB-INF/classes/com/searchasaservice/parser/xpathparser/XpathParser.class	2009-09-29 10:20:01 +0000 and WEB-INF/classes/com/searchasaservice/parser/xpathparser/XpathParser.class	2010-09-29 10:08:20 +0000 differ
=== modified file 'WEB-INF/src/com/freewinesearcher/batch/Coordinates.java'
--- WEB-INF/src/com/freewinesearcher/batch/Coordinates.java	2009-08-01 13:25:27 +0000
+++ WEB-INF/src/com/freewinesearcher/batch/Coordinates.java	2010-09-24 13:10:36 +0000
@@ -307,7 +307,7 @@
 			String lat;
 			String acc;
 			String page;
-			address=Webroutines.URLEncode(Spider.unescape(address));
+			address=Webroutines.URLEncodeUTF8(Spider.unescape(address));
 			webpage.urlstring="http://local.yahooapis.com/MapsService/V1/geocode?appid=UBv0X4nV34HV8LAuLZ44PWUGyhAPLSrQeFK7rC02sutFo9c.mlZOZtYn3Pm0fdZDL1j0TQ--&location="+address;
 			webpage.readPage();
 			page=webpage.html;

=== modified file 'WEB-INF/src/com/freewinesearcher/batch/CurrencyClient.java'
--- WEB-INF/src/com/freewinesearcher/batch/CurrencyClient.java	2009-11-19 15:15:08 +0000
+++ WEB-INF/src/com/freewinesearcher/batch/CurrencyClient.java	2010-09-21 11:07:03 +0000
@@ -139,7 +139,7 @@
 		  if (!"EUR".equals(to)) rateto=Dbutil.readValueFromDB("Select rate from currency where currency='"+to+"';","rate");
 		  result=amount*Double.parseDouble(ratefrom)/Double.parseDouble(rateto);
 	  } catch (Exception e) {
-	    	Dbutil.logger.error("Problem calculating euro value. ", e);
+	    	Dbutil.logger.error("Problem calculating value for currency "+from+". ", e);
 	  }
 	  return result;
   }

=== modified file 'WEB-INF/src/com/freewinesearcher/batch/ProducersOld.java'
--- WEB-INF/src/com/freewinesearcher/batch/ProducersOld.java	2010-05-03 15:10:31 +0000
+++ WEB-INF/src/com/freewinesearcher/batch/ProducersOld.java	2010-09-23 10:16:25 +0000
@@ -53,9 +53,9 @@
 		HashSet<Integer> prod=new HashSet<Integer>();
 		try{
 			if (onlyratedwines){
-				query="select ph.* from kbproducers ph join knownwines kw on (ph.name=kw.producer) join ratedwines on (kw.id=ratedwines.knownwineid) where lat<"+lat2+" and lat>"+lat1+" and lon<"+lon2+" and lon>"+lon1+" and vintage>"+fromvintage+" group by ph.id order by lat;";
+				query="select ph.* from kbproducers ph join knownwines kw on (ph.name=kw.producer) join ratedwines on (kw.id=ratedwines.knownwineid) where lat<"+lat2+" and lat>"+lat1+" and lon<"+lon2+" and lon>"+lon1+" and vintage>"+fromvintage+" group by ph.id order by lat desc;";
 			} else {
-				query="select * from kbproducers where lat<"+lat2+" and lat>"+lat1+" and lon<"+lon2+" and lon>"+lon1+";";
+				query="select * from kbproducers where lat<"+lat2+" and lat>"+lat1+" and lon<"+lon2+" and lon>"+lon1+" order by lat desc;";
 			}
 			rs=Dbutil.selectQuery(query, con);
 			if (rs.last()){

=== modified file 'WEB-INF/src/com/freewinesearcher/batch/Spider.java'
--- WEB-INF/src/com/freewinesearcher/batch/Spider.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/freewinesearcher/batch/Spider.java	2010-09-28 09:14:37 +0000
@@ -109,6 +109,7 @@
 			String Headerregex="";
 			String Headerregexescaped="";
 			String Urltype="";
+			String shopurl="";
 			String Order="Leeg";
 			String tablescraper="";
 			String viewstate="";
@@ -150,6 +151,7 @@
 					ignorepagenotfound=rs.getBoolean("ignorepagenotfound");
 					followredirects=rs.getBoolean("followredirects");
 					Urltype=rs.getString("urltype");
+					shopurl=rs.getString("shopurl");
 					cookie=rs.getString("cookie");
 					minwait=rs.getInt("minwait");
 					maxwait=rs.getInt("maxwait");
@@ -196,7 +198,7 @@
 
 				try {
 					Urlregex = getUrlRegex();
-					xp=new XpathWineScraper(Baseurl, null, now, pricefactorex, pricefactorin, shopid, "");
+					xp=new XpathWineScraper(Baseurl, null, now, pricefactorex, pricefactorin, shopid, "",shopurl);
 					if (c!=null) xp.parsers=XpathParser.getXpathParsers(c, shopid);
 					// Update the status of all found records to Ready: all must be searched
 					updateUrlStatusses("","Delete");// Delete will only affect spidered URL's
@@ -294,11 +296,11 @@
 										if (xp.parsers!=null&&xp.parsers.size()>0){
 											wine=xp.scrape(Page, Url);
 										} else {
-											if (tablescraper.equals("0")){
-												wine=Wine.ScrapeWine(Page, Url, Regex,Headerregex, shopid, Order,now, pricefactorex, pricefactorin);
-											} else {
-												wine=TableScraper.ScrapeWine(Page, Baseurl,shopid, Headerregex, Url, tablescraper, now, pricefactorex, pricefactorin,auto);
-											}
+											//if (tablescraper.equals("0")){
+											//	wine=Wine.ScrapeWine(Page, Url, Regex,Headerregex, shopid, Order,now, pricefactorex, pricefactorin);
+											//} else {
+											wine=TableScraper.ScrapeWine(Page, Baseurl,shopid, Headerregex, Url, tablescraper, now, pricefactorex, pricefactorin,auto);
+											//}
 										}
 
 										if (shoptype==1){
@@ -1332,6 +1334,7 @@
 					positionoflastslash=parenturl.lastIndexOf("/");
 					if (positionoflastslash>-1){
 						paddedurl=parenturl.substring(0,positionoflastslash+1)+url;
+						
 					} else {					// no slash, so add it to the complete parent url
 						paddedurl=parenturl+"/"+url;
 					}	

=== modified file 'WEB-INF/src/com/freewinesearcher/batch/XpathWineScraper.java'
--- WEB-INF/src/com/freewinesearcher/batch/XpathWineScraper.java	2009-08-01 13:25:27 +0000
+++ WEB-INF/src/com/freewinesearcher/batch/XpathWineScraper.java	2010-09-28 09:10:22 +0000
@@ -13,6 +13,7 @@
 import com.freewinesearcher.common.Wine;
 import com.freewinesearcher.online.Webroutines;
 import com.searchasaservice.parser.HTMLParser;
+import com.searchasaservice.parser.LoboParser;
 import com.searchasaservice.parser.xpathparser.XpathParser;
 import com.searchasaservice.parser.xpathparser.Record;
 import com.searchasaservice.parser.xpathparser.Result;
@@ -22,6 +23,7 @@
 	String Page; 
 	String Baseurl; 
 	String Url; 
+	String shopurl;
 	int shopid;
 	Timestamp now; 
 	Double pricefactorex; 
@@ -33,9 +35,10 @@
 	
 	public XpathWineScraper(String baseurl, String country, Timestamp now,
 			Double pricefactorex, Double pricefactorin, int shopid,
-			String shopname) {
+			String shopname, String shopurl) {
 		super();
 		Baseurl = baseurl;
+		this.shopurl=shopurl;
 		this.country = country;
 		this.now = now;
 		this.pricefactorex = pricefactorex;
@@ -45,8 +48,9 @@
 	}
 	
 	public Wine[] scrape(String page, String url){
+		Url=url;
 		ArrayList<Wine> wine=new ArrayList<Wine>();
-		Document doc=new HTMLParser(page).document;
+		Document doc=LoboParser.parsePage(page).document;
 		try {
 			if (parsers != null) {
 				for (XpathParser parser : parsers) {
@@ -122,7 +126,7 @@
 		try {
 			int i=0;
 			for (Record record:result){
-				wines.add(new Wine (record,pricefactorex,pricefactorin,(Double)0.0,country,"","",0,now+"",false,null,shopid,shopname,"",Url,""));
+				wines.add(new Wine (record,pricefactorex,pricefactorin,(Double)0.0,country,"","",0,now+"",false,null,shopid,shopname,shopurl,Url,"",Baseurl));
 				i++;
 			}
 			
@@ -140,7 +144,7 @@
 			wines=new Wine[result.size()];
 			int i=0;
 			for (Record record:result){
-				wines[i]=new Wine (record,pricefactorex,pricefactorin,(Double)0.0,country,"","",0,now+"",false,null,shopid,shopname,"",Url,"");
+				wines[i]=new Wine (record,pricefactorex,pricefactorin,(Double)0.0,country,"","",0,now+"",false,null,shopid,shopname,"",Url,"",Baseurl);
 				i++;
 			}
 			

=== modified file 'WEB-INF/src/com/freewinesearcher/common/Configuration.java'
--- WEB-INF/src/com/freewinesearcher/common/Configuration.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/freewinesearcher/common/Configuration.java	2010-09-22 11:52:43 +0000
@@ -128,8 +128,8 @@
 	public static final String Facebookapplicationid="286925015234";
 	public static int partialknownwinesperiod=Integer.valueOf(FWSConfig.getProperty("partialknownwinesperiod", "3"));
 	public static int parallelrecognitionthreads=Integer.valueOf(FWSConfig.getProperty("parallelrecognitionthreads","1"));
-	public static final String staticprefix="http://static"+("DEV".equals(serverrole)?"test":"")+".vinopedia.com";
-	public static final String stylesheet=staticprefix+"/css/stylesheet3.css?version=21";
+	public static final String staticprefix="http://static"+("DEV".equals(serverrole)?"":"")+".vinopedia.com";
+	public static final String stylesheet=staticprefix+"/css/stylesheet3.css?version=22";
 	public static final String Cellartrackerusername="Vinopedia";
 	public static final String Cellartrackerpassword="a8a2ad25";
 	

=== modified file 'WEB-INF/src/com/freewinesearcher/common/Knownwines.java'
--- WEB-INF/src/com/freewinesearcher/common/Knownwines.java	2010-02-14 15:11:41 +0000
+++ WEB-INF/src/com/freewinesearcher/common/Knownwines.java	2010-09-23 12:34:19 +0000
@@ -2747,6 +2747,42 @@
 				}
 			}
 			
+			
+		} catch (Exception exc){
+			Dbutil.logger.error("Problem while looking up knownwines",exc);
+		} finally{
+			Dbutil.closeRs(rs);
+			Dbutil.closeConnection(con);
+		}
+		return alternatives;
+	}
+
+	public static ArrayList<String> getNewerAlternatives(String input){ 
+		ResultSet rs=null;
+		String[] inputarray=input.split("[ '-]");
+		String inputfulltext="";
+		NumberFormat knownwineformat  = new DecimalFormat("000000");	
+		Connection con=Dbutil.openNewConnection();
+		ArrayList<String> alternatives=new ArrayList<String>();
+		try{
+			for (int i=0;i<inputarray.length;i++){
+				inputfulltext=inputfulltext+" +"+inputarray[i];
+			}
+			String query="select *, match (wine,appellation) against ('"+Spider.SQLEscape(inputfulltext)+"') as score from knownwines where disabled=false and numberofwines>0 order by score desc, numberofwines desc limit 21;";
+			rs=Dbutil.selectQuery(query,con);
+			while (rs.next()){
+				if (rs.getInt("numberofwines")>0&&rs.getFloat("score")>5){
+					alternatives.add("<a href='"+Webroutines.winelink(rs.getString("wine"),0)+"'>"+rs.getString("wine")+"</a> (wine)");
+				}
+			}
+			query="select *, match (shopname) against ('+("+Spider.SQLEscape(inputfulltext).replaceAll("\\+", "")+")' in boolean mode) as score from shops where disabled=false having score>0 order by score desc limit 21;";
+			rs=Dbutil.selectQuery(query,con);
+			while (rs.next()){
+				if (rs.getFloat("score")>0){
+					alternatives.add("<a href='/store/"+Webroutines.URLEncode(Webroutines.removeAccents(rs.getString("shopname"))).replaceAll("%2F", "/")+"/'>"+rs.getString("shopname")+"</a> (store)");
+				}
+			}
+			
 		} catch (Exception exc){
 			Dbutil.logger.error("Problem while looking up knownwines",exc);
 		} finally{

=== modified file 'WEB-INF/src/com/freewinesearcher/common/Webpage.java'
--- WEB-INF/src/com/freewinesearcher/common/Webpage.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/freewinesearcher/common/Webpage.java	2010-09-27 16:19:17 +0000
@@ -34,7 +34,7 @@
 	public String type=""; 
 	public int responsecode=0;
 	public boolean badurl=false;
-	
+
 
 	public Webpage(){
 	}
@@ -90,7 +90,7 @@
 			} else {
 				trimmedurl=Spider.replaceString(trimmedurl, " ", "%20");
 				URL url =  null;
-				
+
 				HttpURLConnection urlcon=null;
 				//long lastmodified;
 				String inputLine;
@@ -104,7 +104,7 @@
 					badurl=true;
 					//throw new MalformedURLException();
 				}
-				
+
 				if (logging) Dbutil.logger.debug("Starting to get web page");
 
 				if (url!=null) while(succes==false&&attempt<maxattempts){
@@ -119,7 +119,7 @@
 						urlcon.setReadTimeout(Configuration.webpagetimeout);
 						urlcon.setRequestProperty("User-Agent",useragent);
 						urlcon.setInstanceFollowRedirects(followredirect);
-						
+
 						if (allowcookies&&(standardcookie+getCookie()).length()>0) urlcon.setRequestProperty("Cookie", standardcookie+getCookie());
 						if (postdata!=null&&!postdata.equals("")){
 							DataOutputStream    printout;
@@ -150,23 +150,23 @@
 						}
 						String[] cookieValarray;
 						String cookieval ="";
-						
+
 						if ((cookieval = urlcon.getHeaderField("Set-Cookie"))!=null) {
-							 
-								//Dbutil.logger.info(urlcon.getHeaderField(i));
-								cookieValarray = cookieval.split(";");
-								String cookieVal=cookieValarray[0];
-								try{
-									String key=(cookieVal.split("=")[0]);
-									String value=cookieVal.substring(key.length()+1);
-									FWSCookie thiscookie=new FWSCookie(key,value);
-									setCookie(thiscookie);
-								}catch (Exception e){
-									Dbutil.logger.info("Invalid cookie: "+cookieVal);
-								}
-
-
-							
+
+							//Dbutil.logger.info(urlcon.getHeaderField(i));
+							cookieValarray = cookieval.split(";");
+							String cookieVal=cookieValarray[0];
+							try{
+								String key=(cookieVal.split("=")[0]);
+								String value=cookieVal.substring(key.length()+1);
+								FWSCookie thiscookie=new FWSCookie(key,value);
+								setCookie(thiscookie);
+							}catch (Exception e){
+								Dbutil.logger.info("Invalid cookie: "+cookieVal);
+							}
+
+
+
 						}
 
 
@@ -181,7 +181,7 @@
 								sb.append("\n");
 							}
 							in.close();
-							
+
 						}
 						responsecode=urlcon.getResponseCode();
 						urlcon.disconnect();
@@ -223,13 +223,145 @@
 		}
 	}
 
+	public InputStream getAsInputStream(){
+		String trimmedurl=urlstring;
+		String test=null;
+		boolean pdf=false;
+
+		int attempt=0;
+		boolean succes=false;
+		if (postdata==null) postdata="";
+		String exceptionmessage="";
+		// If postdata has the form "GET&param1=Yes, then all GET params in URL will be added to the post parameters.
+		if (trimmedurl.indexOf("?", 0)>0&&postdata!=null&&postdata.startsWith("GET&")){
+			postdata=trimmedurl.substring(trimmedurl.indexOf("?", 0)+1)+"&"+postdata.substring(4);
+		}
+		if (postdata!=null&&postdata.startsWith("GET&")){
+			postdata=postdata.substring(4);
+		}
+		//	 If trimmedurl has the form "...GET&param1=Yes, then all params in URL after GET& will be POSTed
+		if (trimmedurl.contains("GET&")){
+			if (!postdata.equals("")) postdata=postdata+"&";
+			postdata=postdata+trimmedurl.substring(trimmedurl.indexOf("GET&")+4);
+			trimmedurl=trimmedurl.substring(0,trimmedurl.indexOf("GET&"));
+		}
+
+
+		trimmedurl=Spider.replaceString(trimmedurl, " ", "%20");
+		URL url =  null;
+
+		HttpURLConnection urlcon=null;
+		//long lastmodified;
+		String inputLine;
+		StringBuffer sb=new StringBuffer();
+		badurl=false;
+		try {
+			url = new URL(trimmedurl);
+		}
+		catch (Exception exc){
+			Dbutil.logger.warn("Foute URL "+trimmedurl);
+			badurl=true;
+			//throw new MalformedURLException();
+		}
+
+		if (logging) Dbutil.logger.debug("Starting to get web page");
+
+		if (url!=null) while(succes==false&&attempt<maxattempts){
+			try{
+				attempt++;
+				if (proxy==null){
+					urlcon = (HttpURLConnection)url.openConnection();
+				} else {
+					urlcon = (HttpURLConnection)url.openConnection(proxy);
+				}
+				urlcon.setConnectTimeout(Configuration.webpagetimeout);
+				urlcon.setReadTimeout(Configuration.webpagetimeout);
+				urlcon.setRequestProperty("User-Agent",useragent);
+				urlcon.setInstanceFollowRedirects(followredirect);
+
+				if (allowcookies&&(standardcookie+getCookie()).length()>0) urlcon.setRequestProperty("Cookie", standardcookie+getCookie());
+				if (postdata!=null&&!postdata.equals("")){
+					DataOutputStream    printout;
+					urlcon.setDoInput (true);
+					// Let the RTS know that we want to do output.
+					urlcon.setDoOutput (true);
+					// No caching, we want the real thing.
+					urlcon.setUseCaches (false);
+					// Specify the content type.
+					urlcon.setRequestProperty ("Content-Type", "application/x-www-form-urlencoded");
+					// Send POST output.
+					printout = new DataOutputStream (urlcon.getOutputStream ());
+
+					printout.writeBytes (postdata);
+					printout.flush ();
+					printout.close ();
+
+				}
+
+
+				//lastmodified=urlcon.getLastModified();
+				if (encoding == null||encoding.equals("")) {
+					encoding="ISO-8859-1";
+				}
+				if (!java.nio.charset.Charset.isSupported(encoding)){
+					//Dbutil.logger.info("Charset "+encoding+" is not supported for URL "+trimmedurl+", trying with ISO-8859-1");
+					encoding="ISO-8859-1";
+				}
+				String[] cookieValarray;
+				String cookieval ="";
+
+				if ((cookieval = urlcon.getHeaderField("Set-Cookie"))!=null) {
+
+					//Dbutil.logger.info(urlcon.getHeaderField(i));
+					cookieValarray = cookieval.split(";");
+					String cookieVal=cookieValarray[0];
+					try{
+						String key=(cookieVal.split("=")[0]);
+						String value=cookieVal.substring(key.length()+1);
+						FWSCookie thiscookie=new FWSCookie(key,value);
+						setCookie(thiscookie);
+					}catch (Exception e){
+						Dbutil.logger.info("Invalid cookie: "+cookieVal);
+					}
+
+
+
+				}
+
+
+			
+				return urlcon.getInputStream();
+			} catch (Exception exc){
+				//Dbutil.logger.error("",exc);
+				exceptionmessage=exc.toString();
+				if (!ignorepagenotfound){
+					if (logging) Dbutil.logger.debug("Cannot find web page, attempt "+attempt+ ", URL = "+trimmedurl,exc);
+				}
+				try {
+					if (attempt<maxattempts){
+						Thread.sleep(errorpause*1000);
+					}
+					responsecode=urlcon.getResponseCode();
+					urlcon.disconnect();
+				} catch (Exception e) {
+					if (logging) Dbutil.logger.debug("Web page problem. ",e);
+				}
+			}
+		}
+		return null;
+
+
+
+
+	}
+
 	public void readPageFromFile() {
 		StringBuffer Page=new StringBuffer();
 		String file=urlstring.substring(7);
 		try {
 			FileReader fstream = new FileReader(file);
 			BufferedReader in = new BufferedReader(fstream);
-			
+
 			while (in.ready()){
 				Page.append(in.readLine()+"\n");
 			}
@@ -307,7 +439,7 @@
 
 		}
 	}
-	
+
 	public static void main(String[] a){
 		Webpage webpage=new Webpage();
 		webpage.urlstring="http://www.wineoutlet.com/InventorySearch.aspx";

=== modified file 'WEB-INF/src/com/freewinesearcher/common/Wine.java'
--- WEB-INF/src/com/freewinesearcher/common/Wine.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/freewinesearcher/common/Wine.java	2010-09-28 08:58:13 +0000
@@ -364,7 +364,7 @@
 		String winebuilder, yearbuilder, pricebuilder;
 		String name = null, vintage = null;
 		float price = 0;
-		rareold=isRareOld(urlstring);	
+		rareold=false; //isRareOld(urlstring);	
 		winebuilder = order.split("/")[0];
 		yearbuilder = order.split("/")[1];
 		pricebuilder = order.split("/")[2];
@@ -521,7 +521,7 @@
 	public Wine(Record record,Double pricefactorex, Double pricefactorin,Double cpc, String country, String createDate, String id,
 			int knownwineid, String lastUpdated, boolean rareold,
 			ArrayList<Winerating> ratings, int shopId, String shopname,
-			String shopurl, String sourceUrl, String pictureurl) {
+			String shopurl, String sourceUrl, String pictureurl, String baseurl) {
 		super();
 		Name=(String)record.get("Producer");
 		if (Name==null) Name="";
@@ -566,7 +566,8 @@
 		ShopId = shopId;
 		Shopname = shopname;
 		Shopurl = shopurl;
-		SourceUrl = (String)record.get("Url");
+		SourceUrl=Spider.padUrl((String)record.get("Url"), sourceUrl, baseurl,shopurl);
+		SourceUrl=TableScraper.cleanUrl(SourceUrl);
 		this.pictureurl = pictureurl;
 	}
 	

=== modified file 'WEB-INF/src/com/freewinesearcher/online/PageHandler.java'
--- WEB-INF/src/com/freewinesearcher/online/PageHandler.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/freewinesearcher/online/PageHandler.java	2010-09-22 12:17:16 +0000
@@ -263,11 +263,25 @@
 			}
 			if (currency==null){
 				if (hostcountry!=null) {
-					if (hostcountry.equals("US")||hostcountry.equals("CA")) {
+					if (hostcountry.equals("US")||request.getLocale().getCountry().equals("US")) {
 						currency="USD";  
-					}else if (hostcountry.equals("UK")) {
-						currency="GBP";
-					} else	if (hostcountry.equals("CH")) currency="CHF";
+					}else if (hostcountry.equals("CA")||request.getLocale().getCountry().equals("CA")) {
+						currency="CAD";  
+					}else if (hostcountry.equals("AU")||request.getLocale().getCountry().equals("AU")) {
+						currency="AUD";  
+					}else if (hostcountry.equals("NZ")||request.getLocale().getCountry().equals("NZ")) {
+						currency="NZD";  
+					}else if (hostcountry.equals("HK")||request.getLocale().getCountry().equals("HK")) {
+						currency="HKD";  
+					}else if (hostcountry.equals("NO")||request.getLocale().getCountry().equals("NO")) {
+						currency="NOK";  
+					}else if (hostcountry.equals("DK")||request.getLocale().getCountry().equals("DK")) {
+						currency="DKK";  
+					}else if (hostcountry.equals("UK")||request.getLocale().getCountry().equals("UK")) {
+						currency="GBP";  
+					}else if (hostcountry.equals("CH")||request.getLocale().getCountry().equals("CH")) {
+						currency="CHF";  
+					}
 				}
 			}
 			if (currency==null) currency="EUR";

=== modified file 'WEB-INF/src/com/freewinesearcher/online/Webroutines.java'
--- WEB-INF/src/com/freewinesearcher/online/Webroutines.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/freewinesearcher/online/Webroutines.java	2010-09-29 09:45:03 +0000
@@ -161,8 +161,8 @@
 				if (!rs.next()){
 					Dbutil.closeRs(rs);
 					i=Dbutil.executeQuery(
-							"Insert into "+auto+"shops (shopname, shopurl, baseurl, urltype, countrycode, exvat, currency, email,address,disabled,vatnumber,invoiceaddress,invoiceemail,contactname,commercialcomment,staffelname,starttrial,startpaying) values ('"+
-							Spider.SQLEscape(shopname)+"','"+shopurl+"','"+url+"','"+type+"','"+country+"','"+vat+"','"+currency+"','"+email+"','"+Spider.SQLEscape(address)+"',"+disabled+",'"+Spider.SQLEscape(vatnumber)+"','"+Spider.SQLEscape(invoiceaddress)+"','"+Spider.SQLEscape(invoiceemail)+"','"+Spider.SQLEscape(contactname)+"','"+Spider.SQLEscape(commercialcomment)+"','"+Spider.SQLEscape(staffelname)+"','"+(starttrial)+"','"+(startpaying)+"');",con);
+							"Insert into "+auto+"shops (shopname, shopurl, baseurl, urltype, countrycode, exvat, currency, email,address,disabled,vatnumber,invoiceaddress,invoiceemail,contactname,commercialcomment,staffelname,starttrial,startpaying,description) values ('"+
+							Spider.SQLEscape(shopname)+"','"+shopurl+"','"+url+"','"+type+"','"+country+"','"+vat+"','"+currency+"','"+email+"','"+Spider.SQLEscape(address)+"',"+disabled+",'"+Spider.SQLEscape(vatnumber)+"','"+Spider.SQLEscape(invoiceaddress)+"','"+Spider.SQLEscape(invoiceemail)+"','"+Spider.SQLEscape(contactname)+"','"+Spider.SQLEscape(commercialcomment)+"','"+Spider.SQLEscape(staffelname)+"','"+(starttrial)+"','"+(startpaying)+"','');",con);
 
 					rs=Dbutil.selectQuery("select LAST_INSERT_ID() as shopid;", con);
 					rs.next();
@@ -3700,7 +3700,10 @@
 		}
 		try {
 			priceformatted=symbol+"&nbsp;"+format.format(price);
-		} catch (RuntimeException e) {
+			if ((format.format(price)+"").length()>7){
+				priceformatted="<font style='font-size:12px'>"+symbol+"&nbsp;"+format.format(price)+"</font>";
+			}
+		} catch (RuntimeException e) { 
 
 		}
 
@@ -4248,15 +4251,17 @@
 		ResultSet rs2 = null;
 		Connection con = Dbutil.openNewConnection();
 		try {
+			int n=Dbutil.readIntValueFromDB("select count(*) as num from  kbproducers  where priority>0 and address is null"+(country!=null&&!country.equals("")&&!country.equals("All")?" and country='"+Spider.SQLEscape(country)+"' ":"")+"; ", "num");
 			query = "select sel.*, group_concat(distinct(appellation)) as region from (select * from  kbproducers  where "+(retrieveid>0?"id="+retrieveid:"address is null")+(country!=null&&!country.equals("")&&!country.equals("All")?" and country='"+Spider.SQLEscape(country)+"' ":"")+" order by "+(reversepriority?"(priority=-1) desc,":"")+"priority desc limit 1) sel join knownwines on (sel.name=knownwines.producer) group by (name);";
 			rs2 = Dbutil.selectQuery(rs, query, con);
 			if (rs2.next()) {
 				id=rs2.getInt("id");
 				String name=rs2.getString("name");
 				String region=Dbutil.readValueFromDB("select group_concat(distinct(locale) SEPARATOR '<br/>') as region from knownwines where producer='"+Spider.SQLEscape(name)+"';","region");
+				sb.append(n+"<br/>");
 				sb.append("<h1>"+name+"</h1>");
 				sb.append(Dbutil.readIntValueFromDB("select count(*) as thecount from kbproducers where address is not null or priority=0;", "thecount")+"/45602<br/>");
-				sb.append("<a href='http://www.google.com/search?num=100&hl=en&q="+URLEncode(name)+"+winery' target='_blank'>Google this</a><br/>");
+				sb.append("<a href='http://www.google.com/search?num=100&hl=en&q="+URLEncode(name)+"' target='_blank'>Google this</a><br/>");
 				sb.append("<a href='http://ablegrape.com/search.jsp?lang=en&query="+URLEncode(name)+"' target='_blank'>AbleGrape this</a><br/>");
 				sb.append(region+"<br/>");
 				name=name.replaceAll("(?<! |^)-", " ");
@@ -5222,16 +5227,16 @@
 		String uniquename="";
 		String link;
 		String regionwhereclause="";
-		String countrywhereclause="";
+		String countryorderclause="";
 		Connection con=Dbutil.openNewConnection();
 		try{
 			if (!region.equals("")){
 				regionwhereclause=" and region in ("+Region.getRegionsAsIntList(region)+")";
 			}
 			if (!searchdata.getCountry().equals("")&&!searchdata.getCountry().equals("All")){
-				countrywhereclause=" and country in ('"+getCountries(searchdata.getCountry())+"','"+getCountries(getRegion(searchdata.getCountry()))+"')";
+				countryorderclause=", (country in ('"+getCountries(searchdata.getCountry())+"','"+getCountries(getRegion(searchdata.getCountry()))+"')) desc";
 			}
-			query="Select tips.*, knownwines.appellation, typeid,country from tips join knownwines on (tips.knownwineid=knownwines.id)  join wineview on (tips.wineid=wineview.id) natural left join winetypecoding where (lowestprice/nextprice>0.5) and lowestprice<=100 and tips.size=0.75 "+regionwhereclause+countrywhereclause+" order by (country='"+searchdata.getCountry()+"') desc,(lowestprice/nextprice) limit "+limit+";";
+			query="Select tips.*, knownwines.appellation, typeid,country from tips join knownwines on (tips.knownwineid=knownwines.id)  join wineview on (tips.wineid=wineview.id) natural left join winetypecoding where (lowestprice/nextprice>0.5) and lowestprice<=100 and tips.size=0.75 "+regionwhereclause+" order by (country='"+searchdata.getCountry()+"') desc"+countryorderclause+",(lowestprice/nextprice) limit "+limit+";";
 			rs=Dbutil.selectQuery(query, con);
 			int i=1;
 			while(rs.next()){
@@ -5471,8 +5476,12 @@
 		return result;
 	}
 	public static String getMostCommonUrl(int shopid, String auto){
-		return Dbutil.readValueFromDB("SELECT * from "+auto+"scrapelist where Shopid="+shopid+" and (urltype like '%Spidered%' or urltype like '%Fixed%') order by winesfound desc;", "url");
-	}
+		return Dbutil.readValueFromDB("SELECT * from "+auto+"scrapelist where Shopid="+shopid+" and (urltype like '%Spidered%' or urltype like '%Fixed%') order by winesfound desc,id;", "url");
+	}
+	public static String getMostCommonPostdata(int shopid, String auto){
+		return Dbutil.readValueFromDB("SELECT * from "+auto+"scrapelist where Shopid="+shopid+" and (urltype like '%Spidered%' or urltype like '%Fixed%') order by winesfound desc,id;", "postdata");
+	}
+	
 	public static String escape(String source) {
 		if (source==null)
 			return null;
@@ -5955,7 +5964,7 @@
 			if (lastpage>endpage) sb.append ("&hellip;<a href='"+thispage+"?keepdata=true&amp;offset="+(lastpage-1)*numberofrows+"'>"+lastpage+"</a>");
 			if (page<lastpage) sb.append ("<a href='"+thispage+"?keepdata=true&amp;offset="+((page)*numberofrows)+"'>&nbsp;&nbsp;&nbsp;"+t.get("next")+"</a>");
 			sb.append("</div></div>");
-			if (mappane.length()>0) sb.append(getRefineNarrow(wineset,t,thispage,searchdata));
+			if (true||mappane.length()>0) sb.append(getRefineNarrow(wineset,t,thispage,searchdata));
 			sb.append("</div><!--items-->"); //items
 			sb.append("</div>"+(pedia.length()>0?"\n<div class='pan' id='pedia'><div class='items' id='items2'><div class='page'>"+pedia+"</div></div><!--items--></div>":"")+(mappane.length()>0?"\n<div class='pan' id='map'><div class='items' id='items2'><div class='page'>"+mappane+"</div></div><!--items--></div>":"")); //panes
 			//sb.append("</div>\n</div>");
@@ -5966,20 +5975,14 @@
 		} else {
 			sb.append("<h2>"+t.get("noresultsfound")+" for '"+searchdata.getName()+"'</h2>");
 
-			if (wineset.knownwineid==0&&searchdata.getCountry().equals("")){
-				ArrayList<String> alternatives=com.freewinesearcher.common.Knownwines.getNewAlternatives(searchdata.getName());
+			if (wineset.knownwineid==0){
+				ArrayList<String> alternatives=com.freewinesearcher.common.Knownwines.getNewerAlternatives(searchdata.getName());
 				if (alternatives.size()>0){	
 					sb.append("<div class='alternatives'>");
 					sb.append("<h2>"+t.get("alternatives")+"</h2>");
-					sb.append("<div class='alternativesh'><div class='left'></div><div class='winename'>Wine</div><div class='region'>Region</div><div class='hits'>Results</div></div>");
-					sb.append("<table class=\"alternatives\">");
-					for (int i=0;i<alternatives.size();i=i+4){
-						sb.append("<tr");						
-						if ((i/4)%2==1){sb.append(" class=\"odd\"");}
-						sb.append("><td class='winename'><a href='/wine/"+Webroutines.URLEncode(alternatives.get(i+2))+"'>"+alternatives.get(i)+ "</a></td><td class='region'>"+alternatives.get(i+1)+"</td><td class='number'>"+alternatives.get(i+3)+"</td></tr>");
+					for (int i=0;i<alternatives.size();i++){
+						sb.append(alternatives.get(i)+"<br/>");
 					}
-					sb.append("</table>");
-					sb.append("<div class='alternativesf'><div class='left'></div><div class='right'></div></div>");
 					//sb.append("<div class='alternatives'>");
 				}
 			}
@@ -6209,8 +6212,25 @@
 			sb.append("</select><div class='text'>"+t.get("size")+"</div><select name='size'  onchange='javascript:document.getElementById(\"refineform\").submit();'><option value=\"All\""+(searchdata.getSize()==null||searchdata.getSize()==(float)0?(" selected=\"selected\""):"")+">"+t.get("all")+"</option>");
 			for (Float size:wineset.sizes){
 				sb.append("<option value=\""+size+"\""+(searchdata.getSize().equals(size)?(" selected=\"selected\""):"")+">"+Webroutines.formatSize(size)+"</option>");
-			}
-			sb.append("</select><div class='currency'>"+t.get("displaycurrency")+"<input type=\"radio\" name=\"currency\" value=\"EUR\"  onchange='javascript:document.getElementById(\"refineform\").submit();' "+(searchdata.getCurrency().equals("EUR")||searchdata.getCurrency().equals("")?(" checked=\"checked\""):"")+" />&euro;&nbsp;<input type=\"radio\" name=\"currency\" value=\"GBP\"  onchange='javascript:document.getElementById(\"refineform\").submit();' "+(searchdata.getCurrency().equals("GBP")?(" checked=\"checked\""):"")+" />&#163;&nbsp;<input type=\"radio\" name=\"currency\" value=\"USD\"  onchange='javascript:document.getElementById(\"refineform\").submit();' "+(searchdata.getCurrency().equals("USD")?(" checked=\"checked\""):"")+" />$&nbsp;<input type=\"radio\" name=\"currency\" value=\"CHF\"  onchange='javascript:document.getElementById(\"refineform\").submit();' "+(searchdata.getCurrency().equals("CHF")?(" checked=\"checked\""):"")+" /><font size='1'>CHF</font></div><input type='hidden' name='keepdata' value='true'/></form><div class='refiner sprite-refiner sprite'></div>");
+			} 
+			sb.append("</select><div class='text'>"+t.get("displaycurrency")+"</div><select name=\"currency\" onchange='javascript:document.getElementById(\"refineform\").submit();'>");
+			sb.append("<option value=\"EUR\""+(searchdata.getCurrency().equals("EUR")?" selected=\"selected\"":"")+">Euro</option>");
+			sb.append("<option value=\"USD\""+(searchdata.getCurrency().equals("USD")?" selected=\"selected\"":"")+">US Dollar</option>");
+			sb.append("<option value=\"CAD\""+(searchdata.getCurrency().equals("CAD")?" selected=\"selected\"":"")+">Canadian Dollar</option>");
+			sb.append("<option value=\"GBP\""+(searchdata.getCurrency().equals("GBP")?" selected=\"selected\"":"")+">Britisch Pound</option>");
+			sb.append("<option value=\"CHF\""+(searchdata.getCurrency().equals("CHF")?" selected=\"selected\"":"")+">Swiss Frank</option>");
+			sb.append("<option value=\"AUD\""+(searchdata.getCurrency().equals("AUD")?" selected=\"selected\"":"")+">Australian Dollar</option>");
+			sb.append("<option value=\"NZD\""+(searchdata.getCurrency().equals("NZD")?" selected=\"selected\"":"")+">NZ Dollar</option>");
+			sb.append("<option value=\"SGD\""+(searchdata.getCurrency().equals("SGD")?" selected=\"selected\"":"")+">Singapore Dollar</option>");
+			sb.append("<option value=\"CNY\""+(searchdata.getCurrency().equals("CNY")?" selected=\"selected\"":"")+">Yuan Renminbi</option>");
+			sb.append("<option value=\"HKD\""+(searchdata.getCurrency().equals("HKD")?" selected=\"selected\"":"")+">Hong Kong Dollar</option>");
+			sb.append("<option value=\"JPY\""+(searchdata.getCurrency().equals("JPY")?" selected=\"selected\"":"")+">Yen</option>");
+			sb.append("<option value=\"SEK\""+(searchdata.getCurrency().equals("SEK")?" selected=\"selected\"":"")+">Swedish Krona</option>");
+			sb.append("<option value=\"NOK\""+(searchdata.getCurrency().equals("NOK")?" selected=\"selected\"":"")+">Norwegian Krone</option>");
+			sb.append("<option value=\"DKK\""+(searchdata.getCurrency().equals("DKK")?" selected=\"selected\"":"")+">Danish Krone</option>");
+			sb.append("<option value=\"ZAR\""+(searchdata.getCurrency().equals("ZAR")?" selected=\"selected\"":"")+">SA Rand</option>");
+			
+			sb.append("</select><input type='hidden' name='keepdata' value='true'/></form><div class='refiner sprite-refiner sprite'></div>");
 			sb.append("<img class='greengo' src='"+Configuration.cdnprefix+"/css2/greengo.jpg' onclick='document.getElementById(\"refineform\").submit()' alt='Go'/></div>");
 		}
 		return sb.toString();

=== modified file 'WEB-INF/src/com/freewinesearcher/online/WineAdvice.java'
--- WEB-INF/src/com/freewinesearcher/online/WineAdvice.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/freewinesearcher/online/WineAdvice.java	2010-09-21 09:47:48 +0000
@@ -454,9 +454,9 @@
 					html.append("<span class='cc' onclick='javascript:setRegionbyvalue(&quot;"+kw.getProperties().get("locale").split(", ")[q].replace("'", "&apos;")+"&quot;);'>"+kw.getProperties().get("locale").split(", ")[q]+"</span>"+(q<kw.getProperties().get("locale").split(", ").length-1?" &raquo; ":""));
 				}
 				html.append("</div>");
-				html.append("<div class='gt'><span class='"+(type[1].toLowerCase().contains("white")?"sprite2 sprite2-grapewhite":"sprite2 sprite2-grapered")+"'><span class='cc' onclick='javascript:setGrape(&quot;"+kw.getProperties().get("grapes")+"&quot;);'>"+kw.getProperties().get("grapes")+"</span>");
-				html.append("<img src='/images/transparent.gif' class='sprite2 sprite2-"+type[0].replaceAll(".jpg", "")+"' alt='"+type[1]+"'/>"+type[1]+"</span></div>");
-				html.append("<div class='sprite2 sprite2-chateau'>"+kw.getProperties().get("producer")+"</div>");
+				html.append("<div class='gt'><span class='"+(type[1].toLowerCase().contains("white")?"sprite sprite-grapewhite":"sprite sprite-grapered")+"'><span class='cc' onclick='javascript:setGrape(&quot;"+kw.getProperties().get("grapes")+"&quot;);'>"+kw.getProperties().get("grapes")+"</span>");
+				html.append("<img src='/images/transparent.gif' class='sprite sprite-"+type[0].replaceAll(".jpg", "")+"' alt='"+type[1]+"'/>"+type[1]+"</span></div>");
+				html.append("<div class='sprite sprite-chateau'>"+kw.getProperties().get("producer")+"</div>");
 				html.append("</div>");
 				html.append("<div class='ras'>");
 				for (Winerating r:w.Ratings){
@@ -468,7 +468,7 @@
 				//html.append("<div class='pr'><div class='pre'>"+Webroutines.formatPrice(w.priceeuroex, w.PriceEuroEx, "EUR", "IN")+"</div>");
 				//html.append("<div class='pra'>"+Webroutines.formatPrice(w.PriceEuroIn, w.PriceEuroEx, "USD", "IN")+"</div>");
 				//html.append("</div>");
-				html.append("<div class='act'><div class='sprite2 sprite2-magnglass'><a href='/wine/"+Webroutines.URLEncode((w.Name+" "+w.Vintage).trim())+"'  target='_blank'>"+Webroutines.formatPrice(w.PriceEuroIn, w.PriceEuroEx, currency, "EX")+"</a></div>");
+				html.append("<div class='act'><div class='sprite sprite-magnglass'><a href='/wine/"+Webroutines.URLEncode((w.Name+" "+w.Vintage).trim())+"'  target='_blank'>"+Webroutines.formatPrice(w.PriceEuroIn, w.PriceEuroEx, currency, "EX")+"</a></div>");
 				//html.append("<div class='wish'>Wishlist</div>");
 				html.append("</div></div>");
 				if ((i+1)%resultsperpage==0||i+1==wine.length){
@@ -1041,9 +1041,9 @@
 					html.append("<span class='cc' onclick='javascript:setRegionbyvalue(&quot;"+kw.getProperties().get("locale").split(", ")[q]+"&quot;);'>"+kw.getProperties().get("locale").split(", ")[q]+"</span>"+(q<kw.getProperties().get("locale").split(", ").length-1?" &raquo; ":""));
 				}
 				html.append("</div>");
-				html.append("<div class='gt'><span class='sprite2 sprite2-"+(type[1].toLowerCase().contains("white")?"grapewhite":"grapered")+"'><span class='cc' onclick='javascript:setGrape(&quot;"+kw.getProperties().get("grapes")+"&quot;);'>"+kw.getProperties().get("grapes")+"</span>");
+				html.append("<div class='gt'><span class='sprite sprite-"+(type[1].toLowerCase().contains("white")?"grapewhite":"grapered")+"'><span class='cc' onclick='javascript:setGrape(&quot;"+kw.getProperties().get("grapes")+"&quot;);'>"+kw.getProperties().get("grapes")+"</span>");
 				html.append("<img src='/images/"+type[0]+"' alt='"+type[1]+"'/>"+type[1]+"</span></div>");
-				html.append("<div class='sprite2 sprite2-chateau'>"+kw.getProperties().get("producer")+"</div>");
+				html.append("<div class='sprite sprite-zchateau'>"+kw.getProperties().get("producer")+"</div>");
 				int n=Dbutil.readIntValueFromDB("select n as thecount from bestprices where knownwineid="+w.Knownwineid+" and vintage="+w.Vintage+" and continent='"+continent+"';", "thecount");
 				if (n>1) html.append("<div class='offerings'>Market price is based on <a href='/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(kw.name))+(w.Vintage.equals("0")?"":"?vintage="+w.Vintage)+"&amp;country="+continent+"' >"+n+" offers</a> for this wine</div>");
 

=== modified file 'WEB-INF/src/com/searchasaservice/ai/Aitools.java'
--- WEB-INF/src/com/searchasaservice/ai/Aitools.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/searchasaservice/ai/Aitools.java	2010-09-27 14:30:48 +0000
@@ -1632,6 +1632,34 @@
 		}
 
 	}
+	
+	public static void fixKnownwine(int knownwineid){
+		String query="delete from aiitems where id="+knownwineid;
+		Dbutil.executeQuery(query);
+		query="insert into aiitems (tenant,itemid,productgroupid,itemdescription,itemregexexcl,probability) select 1,id,1,wine,'',bottles from kbknownwines where id="+knownwineid;
+		Dbutil.executeQuery(query);
+		query="insert ignore into aiproperties (propertydescription,typeid,tenant) select producer,1,1 from knownwines where knownwineid="+knownwineid+";";
+		Dbutil.executeQuery(query);
+		
+		String desc=Dbutil.readValueFromDB("select distinct(cuvee) as cuvee from knownwines where id="+knownwineid, "cuvee");
+		desc=filterPunctuation(desc);
+		String[] terms=desc.split(" +");
+		for (String term:terms){
+			term=filterTermCuvee(term);
+			query="insert ignore into aiproperties(tenant,propertydescription,typeid) values ("+1+",'"+term+"',4);";
+			Dbutil.executeQuery(query);
+			
+		}
+		desc=Dbutil.readValueFromDB("select distinct(vineyard) as vineyard from knownwines where id="+knownwineid, "vineyard");
+		desc=filterPunctuation(desc);
+		terms=desc.split(" +");
+		for (String term:terms){
+			term=filterTermCuvee(term);
+			query="insert ignore into aiproperties(tenant,propertydescription,typeid) values ("+1+",'"+term+"',4);";
+			Dbutil.executeQuery(query);
+		}
+		
+	}
 
 	public static void main(String[] args){
 		Wijnzoeker wijnzoeker=new Wijnzoeker();

=== modified file 'WEB-INF/src/com/searchasaservice/ai/Recognizer.java'
--- WEB-INF/src/com/searchasaservice/ai/Recognizer.java	2010-09-21 09:04:18 +0000
+++ WEB-INF/src/com/searchasaservice/ai/Recognizer.java	2010-09-24 13:20:13 +0000
@@ -2376,6 +2376,7 @@
 			Dbutil.executeQuery("insert into airecords(tenant,id,description,itemid) select "+tenant+","+idfield+","+lookupfield+",0 from "+table+(skipmanualknownwineid?" where manualknownwineid=0":"")+" order by "+idfield+";",temptablecon);
 		} else {
 			Dbutil.executeQuery("insert into airecords(tenant,id,description,itemid) select "+tenant+","+idfield+","+lookupfield+",0 from "+table+" where "+resultfield+"=0"+timeclause+(skipmanualknownwineid?" and manualknownwineid=0":"")+" order by "+idfield+";",temptablecon);
+			
 		}
 	}
 
@@ -2435,6 +2436,7 @@
 		rec.refreshAll=refreshall;
 		rec.history=history;
 		rec.fillAiRecords();
+		if (history>0) Dbutil.executeQuery("insert ignore into airecords(tenant,id,description,itemid) select 1,id,name,0 from wines where manualknownwineid=-2 order by id;");
 		rec.getProperties(0);
 		rec.getPropertiesConsolidated();
 		rec.restart();
@@ -2450,6 +2452,7 @@
 			Dbutil.renewTable("materializedadvice");
 			Knownwines.filterTooCheapKnownwines(5, 5);
 			Dbutil.renewTable("materializedadvice");
+			Dbutil.executeQuery("update wines set manualknownwineid=0 where manualknownwineid=-2;");
 			Dbutil.logger.info("Finished job to recognize wines");
 		} else {
 			Dbutil.logger.error("Problem while recognizing knownwines");

=== modified file 'WEB-INF/src/com/searchasaservice/parser/HTMLParser.java'
--- WEB-INF/src/com/searchasaservice/parser/HTMLParser.java	2009-08-01 13:25:27 +0000
+++ WEB-INF/src/com/searchasaservice/parser/HTMLParser.java	2010-09-27 19:37:59 +0000
@@ -36,6 +36,7 @@
 	public String url="http://www.roelvin.eu/wijnenwijn.php";
 
 	public HTMLParser(String html){
+		Thread.currentThread().dumpStack();
 		// First remove any xmlns as it will confuse the parser
 		html=html.replaceAll("(^|\\s)xmlns(:[^=\"]+)?=\"[^\"]*\""," ");
 		html=html.replaceAll("(?<=</?)\\w+:","");

=== modified file 'WEB-INF/src/com/searchasaservice/parser/XpathParser.java'
--- WEB-INF/src/com/searchasaservice/parser/XpathParser.java	2009-10-18 16:05:57 +0000
+++ WEB-INF/src/com/searchasaservice/parser/XpathParser.java	2010-09-27 16:56:49 +0000
@@ -348,7 +348,7 @@
 			DOMSource source = new DOMSource(n);
 			trans.transform(source, result);
 			xmlString = sw.toString();
-
+			
 		} catch (Exception e) {
 			Dbutil.logger.error("Problem: ", e);
 		}

=== modified file 'WEB-INF/src/com/searchasaservice/parser/xpathparser/Analyzer.java'
--- WEB-INF/src/com/searchasaservice/parser/xpathparser/Analyzer.java	2009-08-01 13:25:27 +0000
+++ WEB-INF/src/com/searchasaservice/parser/xpathparser/Analyzer.java	2010-09-30 08:55:40 +0000
@@ -17,7 +17,9 @@
 import com.freewinesearcher.batch.Spider;
 import com.freewinesearcher.common.*;
 import com.searchasaservice.ai.AiContentHandler;
+//import com.searchasaservice.parser.HTMLParser;
 import com.searchasaservice.parser.HTMLParser;
+import com.searchasaservice.parser.LoboParser;
 
 
 import net.sf.saxon.dom.DOMNodeList;
@@ -69,6 +71,10 @@
 		url=urlstr;
 
 	}
+	public void setPostdata(String postdata){
+		this.postdata=postdata;
+
+	}
 
 
 	public static Analyzer getAnalyzer(Context c,int shopid, int row){
@@ -565,7 +571,7 @@
 					}
 				}
 			} else {
-				Dbutil.logger.info("Could not find any items with the original path!");
+				Dbutil.logger.info("Could not find any items with the original path! "+itemxpath+" "+origxpath);
 			}
 
 
@@ -811,7 +817,7 @@
 				if (node.getAttribute("id") != null&&node.getAttribute("id")!="")
 					id = "[@id='" + node.getAttribute("id") + "']";
 				String classname = "";
-				if (node.getAttribute("class") != "")
+				if (node.getAttribute("class") != null&&node.getAttribute("class") != "")
 					classname = "[@class='" + node.getAttribute("class") + "']";
 				String nodename=node.getNodeName();
 				if (nodename.contains(":")) nodename="*[local-name()='"+nodename.split(":")[1]+"']";
@@ -835,7 +841,7 @@
 							+ nl.getLength() + " nodes that match "
 							+ node.getNodeName() + id + classname);
 					Dbutil.logger.info("Regex="+reg);
-					Dbutil.logger.info("Parent node XML:"+getNodeAsXML(node.getParentNode()));
+					//Dbutil.logger.info("Parent node XML:"+getNodeAsXML(node.getParentNode()));
 				}
 				String order = "[" + n + "]";
 				path = "/" + nodename + id + classname + order + path;
@@ -903,7 +909,7 @@
 			NodeList ni = (NodeList) exp.evaluate(workdocument,
 					XPathConstants.NODESET);
 			for (int i = 0; i < ni.getLength(); i++) {
-				if (ni.item(i).compareDocumentPosition(node)==20) {
+				if (ni.item(i).compareDocumentPosition(node)>0) {
 					return getRelXpath(node, ni.item(i));
 				} 
 			}
@@ -952,7 +958,7 @@
 				if (node.getAttribute("id") != null&&node.getAttribute("id")!="")
 					id = "[@id='" + node.getAttribute("id") + "']";
 				String classname = "";
-				if (node.getAttribute("class") != "")
+				if (node.getAttribute("class") != null&&node.getAttribute("class") != "")
 					classname = "[@class='" + node.getAttribute("class") + "']";
 				String reg="child::" + node.getNodeName() + id + classname;
 				XPathFactory xpf=XPathFactory.newInstance();
@@ -969,7 +975,7 @@
 							+ nl.getLength() + " nodes that match "
 							+ node.getNodeName() + id + classname);
 					Dbutil.logger.info("reg:"+reg);
-					Dbutil.logger.info("Parent node XML:"+getNodeAsXML(node.getParentNode()));
+					//Dbutil.logger.info("Parent node XML:"+getNodeAsXML(node.getParentNode()));
 				}
 				String order = "[" + n + "]";
 				path = "/" + node.getNodeName() + id + classname + order + path;
@@ -1326,8 +1332,10 @@
 			//Dbutil.logger.info("Analizing "+newurl);
 			frames.remove(newurl);
 			if (!newurl.equals("Existing document")){
-				String page=HTMLParser.getPage(newurl);
-				HTMLParser p=new HTMLParser(page);
+				//String page=HTMLParser.getPage(newurl);
+				//HTMLParser p=new HTMLParser(page);
+				LoboParser p=new LoboParser(newurl);
+				//String page=getNodeAsXML(p.document);
 				originaldocument=p.document;
 				tagDocument(originaldocument);
 				document=taggeddocument;
@@ -1343,7 +1351,7 @@
 	
 	public Result analyseDocument(int numberofitemstoanalyze, int mandatoryitem) throws Exception{
 
-		boolean log=false;
+		boolean log=true;
 		LinkedHashSet<String> frames=new LinkedHashSet<String>();
 		ArrayList<ArrayList<String>> fieldpaths=new ArrayList<ArrayList<String>>();
 		try{
@@ -1358,10 +1366,11 @@
 			progress=progressInt+"%...";
 			if (document==null) {
 				getUrls(url);
-				String page=HTMLParser.getPage(url);
+				//LoboParser p=new LoboParser(url);
+				HTMLParser p=new HTMLParser(url);
+				String page=getNodeAsXML(p.document);
 				frames.add("Existing document");
 				frames.addAll(getFrameUrls(page,url));
-				HTMLParser p=new HTMLParser(page);
 				originaldocument=p.document;
 				tagDocument(originaldocument);
 				document=taggeddocument;
@@ -1406,7 +1415,7 @@
 					}
 				}
 			}
-				
+				if(log) Dbutil.logger.info(f(0).xpath);
 			if (f(0).xpath.indexOf("[*]")==-1){
 				return null;
 			} else {

=== modified file 'WEB-INF/src/com/searchasaservice/parser/xpathparser/XpathParser.java'
--- WEB-INF/src/com/searchasaservice/parser/xpathparser/XpathParser.java	2009-08-01 13:25:27 +0000
+++ WEB-INF/src/com/searchasaservice/parser/xpathparser/XpathParser.java	2010-09-28 09:59:26 +0000
@@ -14,6 +14,7 @@
 
 import javax.xml.xpath.*;
 
+import com.freewinesearcher.batch.Spider;
 import com.freewinesearcher.common.*;
 
 import java.sql.Connection;
@@ -32,6 +33,7 @@
 	public XpathParserConfig config=new XpathParserConfig();
 	public Document document;
 	public String url="";
+	public String postdata="";
 	public int shopid;
 	long id;
 	
@@ -78,15 +80,22 @@
 	public long save(Context c){
 		if(shopid>0){
 		try {
+			//Dbutil.executeQuery("delete from xpathobjects where tenant="+c.tenant+" and shopid="+shopid+";");
 			id = Serializer.writeJavaObject("xpathobjects",c.tenant, shopid, id, config.getUID() , config);
-			return id;
+			Dbutil.executeQuery("delete from scrapelist where shopid="+shopid+" and url='"+Spider.SQLEscape(url)+"' and postdata='"+Spider.SQLEscape(postdata)+"';");
+			int hashcode=(url+postdata).hashCode();
+			int i = Dbutil.executeQuery(
+					"Insert into scrapelist (Url, Postdata, Headerregex, regex, scrapeorder,parenturl,Shopid, URLType, tablescraper, Status,hashcode) " +
+					"values ('"+Spider.SQLEscape(url)+"', '"+Spider.SQLEscape(postdata)+"', '', '','','', '"+shopid+"', 'Master', '0', 'Ready',"+hashcode+");");
+			if (i>0) return id;
+			return 0;
 		} catch (Exception e) {
 			Dbutil.logger.error("Problem: ", e);
 		}
 		} else {
 			Dbutil.logger.error("Could not save xpathparser because shopid=0");
 		}
-		return id;
+		return 0;
 	}
 
 	/*private static Node getNodeFromRelXpath(String xpath, Node ref){

=== modified file 'WEB-INF/urlrewrite.xml'
--- WEB-INF/urlrewrite.xml	2010-09-21 09:04:18 +0000
+++ WEB-INF/urlrewrite.xml	2010-09-23 07:57:03 +0000
@@ -22,9 +22,17 @@
 	<rule>
 		<name>Redirect to www.</name>
 		<condition name="host" operator="notequal">^(www|test|static|statictest).vinopedia.com</condition>
+		<condition type="query-string" operator="notequal">^$</condition>
 		<from>^(.*)$</from>
 		<to type="permanent-redirect">https://www.vinopedia.com$1?%{query-string}</to>
 	</rule>	
+	<rule>
+		<name>Redirect to www.</name>
+		<condition name="host" operator="notequal">^(www|test|static|statictest).vinopedia.com</condition>
+		<condition type="query-string" operator="equal">^$</condition>
+		<from>^(.*)$</from>
+		<to type="permanent-redirect">https://www.vinopedia.com$1</to>
+	</rule>	
     <rule>
 		<name>Redirect to www. for non static content</name>
 		<condition name="host" operator="equal">^(static|statictest).vinopedia.com</condition>

=== modified file 'admin/salesdashboard.jsp'
--- admin/salesdashboard.jsp	2010-09-21 09:04:18 +0000
+++ admin/salesdashboard.jsp	2010-09-22 10:02:37 +0000
@@ -91,6 +91,21 @@
 <%=Webroutines.query2table("select date(date) as Date,wineprice as 'Order value'  from logging where type like 'Sent%' and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and shopid="+shop+" order by date desc ;", true, false)%><br/>
 Wines displayed:
 <%out.write(Webroutines.query2table("select concat(wines.name,CAST(if(logging.vintage>0,logging.vintage,'') AS CHAR)) as Wine,price as `Price on site`,format(priceeuroex,2) as `Price in euro ex. VAT`,count(*) as Views, format(count(*) * priceeuroex,2)  as `Total value` from logging join wines on (logging.wineid=wines.id) where logging.shopid="+shopid+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0 group by wineid,wines.vintage order by Views desc;", true, false));%><br/>
+
+<% float dollar=Float.parseFloat(Dbutil.readValueFromDB("select * from currency where currency='USD'","rate")); %>
+<br/><br/>
+<%=Dbutil.readValueFromDB("select count(distinct(ip)) as visitors from logging where shopid="+shop+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"')  and bot=0;","visitors") %> unique visitors have viewed the store page.<br/>
+<%=Dbutil.readValueFromDB("select count(*) as visitors from logging where shopid="+shop+" and type not like '%wineinfo%' and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0;","visitors") %> views of the store page.<br/>
+<%=Dbutil.readValueFromDB("select count(*) as visitors from logging where shopid="+shop+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0 and wineid>0;","visitors") %> wines were selected with a total value of US$ <%=Dbutil.readValueFromDB("select format(sum(priceeuroex/"+dollar+"),2) as value from logging join wines on (logging.wineid=wines.id) where logging.shopid="+shop+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0;","value") %> ex. sales tax.<br/>
+<% 
+//<%=Dbutil.readValueFromDB("select count(*) as visitors from logging where shopid="+shop+" and type = 'Link Clicked' and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0;","visitors") % > clicks to the web site of the store.<br/>*/
+%>
+<%=Dbutil.readValueFromDB("select count(*) as n from wines where shopid="+shop+";","n") %> wines in store, listed since <%=Dbutil.readValueFromDB("select date(min(createdate)) as startdate from history where shopid="+shop+";","startdate") %>.<br/>
+<br/>
+Orders placed: 
+<%=Webroutines.query2table("select date(date) as Date,wineprice/"+dollar+" as 'Order value'  from logging where type like 'Sent%' and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and shopid="+shop+" order by date desc ;", true, false)%><br/>
+Wines displayed:
+<%out.write(Webroutines.query2table("select concat(wines.name,CAST(if(logging.vintage>0,logging.vintage,'') AS CHAR)) as Wine,price as `Price on site`,format(priceeuroex/"+dollar+",2) as `Price in US$ ex. sales tax`,count(*) as Views, format(count(*) * priceeuroex/"+dollar+",2)  as `Total value` from logging join wines on (logging.wineid=wines.id) where logging.shopid="+shopid+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0 group by wineid,wines.vintage order by Views desc;", true, false));%><br/>
 <% } %>
 
 

=== modified file 'admin/visitingguide.jsp'
--- admin/visitingguide.jsp	2010-05-03 15:10:31 +0000
+++ admin/visitingguide.jsp	2010-09-23 10:23:45 +0000
@@ -8,9 +8,10 @@
 	
 	%>
 
-<%@page import="com.freewinesearcher.common.Configuration"%><html>
+<%@page import="com.freewinesearcher.common.Configuration"%><%@ page contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%><html>
 <head>
-<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
+<%@ include file="/header2.jsp" %>
+<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
 
 
 </head>
@@ -59,6 +60,11 @@
       	customicon.transparent = "/images/icons/empty.png";
       	customicon.infoWindowAnchor = new GPoint(18,18 );
       	customicon.imageMap=[0,0,0,35,35,35,35,0,0,0];
+      	var invicon = new GIcon();
+		invicon.image = "/images/transparent.gif";
+		invicon.iconSize = new GSize(0, 0);
+	  	invicon.shadowSize = new GSize(0, 0);
+	  	invicon.iconAnchor = new GPoint(0, 0);
 		
 		
   		// Add markers
@@ -67,7 +73,7 @@
   	out.write("var gmarkeroptions;\n"); 
   	out.write("var bounds = new GLatLngBounds;");
   		for (int i=0;i<producers.name.size();i++){
-	  			out.write("marker=new GMarker(new GLatLng("+producers.lat.get(i)+","+producers.lon.get(i)+"),{title:\""+producers.name.get(i).replace("'","&apos;").replace("\"","&apos;")+"\""+(producers.accuracy.get(i)<5?",icon:customicon":"")+"});\n");
+	  			out.write("marker=new LabeledMarker(new GLatLng("+producers.lat.get(i)+","+producers.lon.get(i)+"),{title:\""+producers.name.get(i).replace("'","&apos;").replace("\"","&apos;")+"\",labelText:\""+(i+1)+"\",labelClass:\"regionpoi\",icon:invicon,labelOffset:new GSize(-5, -10)});\n");
 	  			//out.write("marker=new GMarker(new GLatLng("+shop.lat+","+shop.lon+"),mOpts);\n");
 	  			out.write("bounds.extend(new GLatLng("+producers.lat.get(i)+","+producers.lon.get(i)+"));");
 	  			out.write("GEvent.addListener(marker, 'click', function() {  window.location.hash='producer"+(i+1)+"'; });");
@@ -89,7 +95,7 @@
     </script>
     <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=<%=Configuration.GoogleApiKey%>"
       type="text/javascript"></script>
-
+<script type="text/javascript" src="/js/googlemaps/labeled_marker.js"></script>
     <script type="text/javascript">load();</script>
 	<script type="text/javascript">
 	function refreshdata(){

=== modified file 'contact.jsp'
--- contact.jsp	2010-09-21 09:04:18 +0000
+++ contact.jsp	2010-09-22 10:50:40 +0000
@@ -71,7 +71,7 @@
 <h1>Contact us</h1>
 <FORM ACTION="contact.jsp" METHOD="POST">
 What do you think of our site? Did you experience any problems? Got any suggestions or comments? We love to hear from you! If you are a selling wines and would like to get listed on Vinopedia.com, please <a href='retailers.jsp'>sign up here</a>.<br/><br/>
-Note: Vinopedia is a search engine for wine and does not sell wine directly or negotiate deals. If you would like to order wine, please do so using our store page or contact the store directly. <br/>
+Note: <b style='color:red'>Vinopedia is a search engine for wine, we do not sell wine</b> directly or negotiate deals. If you see a wine on our site that you would like to buy or that you need more information about, please contact the seller/store directly. We will not answer any inquiries about price/availability/shipment.<br/>
 <br/>
     <TABLE>
 		<TR><TD>Name</TD><TD><INPUT TYPE="TEXT" NAME="name" value="<%=name %>" size=50></TD></TR>

=== modified file 'css/stylesheet3.css'
--- css/stylesheet3.css	2010-09-21 09:04:18 +0000
+++ css/stylesheet3.css	2010-09-21 09:49:33 +0000
@@ -388,11 +388,11 @@
 .wa img.wrlabel.bottom:hover{bottom:10px;}
 .wa div{position:relative;margin-bottom:4px;border-style:none;}
 .detail{float:left;padding-left:70px;width:350px;}
-span.sprite2-grapered{float:left;padding-left:25px;}
-span.sprite2-grapewhite{float:left;padding-left:25px;}
+span.sprite-grapered{float:left;padding-left:25px;}
+span.sprite-grapewhite{float:left;padding-left:25px;}
 .gt img{vertical-align:middle;margin-left:10px;margin-right:5px;margin-bottom:5px;width:12px;height:18px;}
 span.wt img{margin-right:5px;}
-div.sprite2-chateau{padding-top:2px;clear:both;padding-left:25px;}
+div.sprite-zchateau{padding-top:2px;clear:both;padding-left:25px;}
 .ras{float:left;width:90px;min-height:50px;}
 div.au, div.au a{clear:both;float:left;width:40px;background: #aaaaaa;color:white;text-align:center;margin-bottom:2px;}
 div.po, div.po a{float:left;width:46px;background: #f3f4d5;text-align:center;margin-bottom:2px;}
@@ -401,9 +401,9 @@
 .pre{text-align:right;padding-right:30px;background:url(http://vinopedia.appspot.com/images/europe.jpg)  no-repeat; background-position:right;}
 .pra{text-align:right;padding-right:30px;background:url(http://vinopedia.appspot.com/images/usa.jpg)  no-repeat; background-position:right;}
 div.act{float:right;height:50px;}
-div.sprite2-magnglass{padding-left:25px;height:17px;text-align:right;}
-div.sprite2-magnglass a{color:#5f5f5f;cursor:pointer;}
-div.sprite2-magnglass a:hover{text-decoration:underline;}
+div.sprite-magnglass{padding-left:25px;height:17px;text-align:right;}
+div.sprite-magnglass a{color:#5f5f5f;cursor:pointer;}
+div.sprite-magnglass a:hover{text-decoration:underline;}
 div.wish{background: url(http://vinopedia.appspot.com/images/plus.jpg) no-repeat;padding-left:25px;}
 div.waline {width:604px;;position:relative; clear:left;float:left;height:0px;border-style:solid;border-width:1px;border-bottom-style:none;border-color:#999999;padding-right:10px;border-collapse:separate;}
 #next1,#next2,#next3,#next4,#prev1,#prev2,#prev3,#prev4{cursor:pointer;background: url(http://vinopedia.appspot.com/images/button.jpg) no-repeat;text-align:center;color:white;width:76px;height:22px;margin:10px;padding-top:3px;font-family:arial;}
@@ -879,8 +879,8 @@
 .ui-slider li span.ui-widget-content,.ui-slider dd span.ui-widget-content{border-right:0;border-left-width:1px;border-left-style:solid;border-top:0;border-bottom:0;}
 .ui-slider .first .ui-slider-tic,.ui-slider .last .ui-slider-tic{display:none;}
 
-.sprite{background: url(sprite.png) no-repeat top left;}
-.sprite2{background: url(/css/sprite3.png) no-repeat top left;}
+
+.sprite{background: url(sprite4.png) no-repeat top left;}
 .spriter{background: url(http://vinopedia.appspot.com/css/spriter.png) repeat-x top left;}
 .sprite-language{width:22px;height:13px;margin-left:5px;}
 
@@ -889,99 +889,95 @@
 .spriter-resulth { background-position: 0 -65px; } 
 .spriter-vintagee { background-position: 0 -98px; } 
 .spriter-vintageo { background-position: 0 -127px; }
-.sprite-arrowgreen { background-position: 0 0; } 
-.sprite-at { background-position: 0 -56px; } 
-.sprite-be { background-position: 0 -116px; } 
-.sprite-bg { background-position: 0 -176px; } 
-.sprite-ca { background-position: 0 -236px; } 
-.sprite-ch { background-position: 0 -296px; } 
-.sprite-champagne18 { background-position: 0 -356px; } 
-.sprite-chateau { background-position: 0 -424px; } 
-.sprite-cy { background-position: 0 -486px; } 
-.sprite-cz { background-position: 0 -546px; } 
-.sprite-de { background-position: 0 -606px; } 
-.sprite-dessert18 { background-position: 0 -666px; } 
-.sprite-dglassdessert { background-position: 0 -734px; } 
-.sprite-dglassno { background-position: 0 -866px; } 
-.sprite-dglassport { background-position: 0 -998px; } 
-.sprite-dglassred { background-position: 0 -1130px; } 
-.sprite-dglassrose { background-position: 0 -1262px; } 
-.sprite-dglasssparkling { background-position: 0 -1394px; } 
-.sprite-dglasswhite { background-position: 0 -1526px; } 
-.sprite-dk { background-position: 0 -1658px; } 
-.sprite-dutch { background-position: 0 -1718px; } 
-.sprite-ee { background-position: 0 -1781px; } 
-.sprite-empty18 { background-position: 0 -1841px; } 
-.sprite-en { background-position: 0 -1909px; } 
-.sprite-en { background-position: -122px 0; } 
-.sprite-english { background-position: -122px -63px; } 
-.sprite-es { background-position: -122px -126px; } 
-.sprite-fi { background-position: -122px -186px; } 
-.sprite-fr { background-position: -122px -246px; } 
-.sprite-french { background-position: -122px -306px; } 
-.sprite-gb { background-position: -122px -369px; } 
-.sprite-glassdessert { background-position: -122px -429px; } 
-.sprite-glassno { background-position: -122px -561px; } 
-.sprite-glassport { background-position: -122px -693px; } 
-.sprite-glassred { background-position: -122px -825px; } 
-.sprite-glassrose { background-position: -122px -957px; } 
-.sprite-glasssparkling { background-position: -122px -1089px; } 
-.sprite-glasswhite { background-position: -122px -1221px; } 
-.sprite-gosmall { background-position: -122px -1353px; } 
-.sprite-gr { background-position: -122px -1431px; } 
-.sprite-grapered { background-position: -122px -1491px; } 
-.sprite-grapewhite { background-position: -122px -1553px; } 
-.sprite-greengo { background-position: -122px -1615px; } 
-.sprite-hu { background-position: -122px -1692px; } 
-.sprite-ie { background-position: -122px -1752px; } 
-.sprite-indicator { background-position: -122px -1812px; } 
-.sprite-it { background-position: -122px -1878px; } 
-.sprite-lt { background-position: -122px -1938px; } 
-.sprite-lu { background-position: -244px 0; } 
-.sprite-lv { background-position: -244px -60px; } 
-.sprite-magnglass { background-position: -244px -120px; } 
-.sprite-mt { background-position: -244px -186px; } 
-.sprite-nl { background-position: -244px -246px; } 
-.sprite-pl { background-position: -244px -306px; } 
-.sprite-port18 { background-position: -244px -366px; } 
-.sprite-pt { background-position: -244px -434px; } 
-.sprite-red18 { background-position: -244px -494px; } 
-.sprite-refinel { background-position: -244px -562px; } 
-.sprite-refiner { background-position: -244px -643px; } 
-.sprite-resultfl { background-position: -244px -724px; } 
-.sprite-resultfr { background-position: -244px -806px; } 
-.sprite-resulthl { background-position: -244px -888px; } 
-.sprite-resulthlstr { background-position: -244px -970px; } 
-.sprite-resulthr { background-position: -244px -1052px; } 
-.sprite-rose18 { background-position: -244px -1134px; } 
-.sprite-roundauthore { background-position: -244px -1202px; } 
-.sprite-roundauthoro { background-position: -244px -1276px; } 
-.sprite-roundrratingee { background-position: -244px -1350px; } 
-.sprite-roundrratingeo { background-position: -244px -1424px; } 
-.sprite-roundrratingoe { background-position: -244px -1498px; } 
-.sprite-roundrratingoo { background-position: -244px -1572px; } 
-.sprite-roundrvintagee { background-position: -244px -1646px; } 
-.sprite-roundrvintageo { background-position: -244px -1724px; } 
-.sprite-roundwine { background-position: -244px -1802px; } 
-.sprite-se { background-position: -244px -1924px; } 
-.sprite-searchgo { background-position: -374px 0; } 
-.sprite-si { background-position: -374px -86px; } 
-.sprite-sk { background-position: -374px -146px; } 
-.sprite-sortasc { background-position: -374px -206px; } 
-.sprite-sortdesc { background-position: -374px -269px; } 
-.sprite-spinner { background-position: -374px -332px; } 
-.sprite-us { background-position: -374px -398px; } 
-.sprite-white18 { background-position: -374px -458px; } 
 
-.sprite2-champagne18 { background-position: 0 0;  } 
-.sprite2-chateau { background-position: 0 -68px;  } 
-.sprite2-close { background-position: 0 -130px;  } 
-.sprite2-dessert18 { background-position: 0 -193px;  } 
-.sprite2-empty18 { background-position: 0 -261px;  } 
-.sprite2-grapered { background-position: 0 -329px;  } 
-.sprite2-grapewhite { background-position: 0 -391px;  } 
-.sprite2-magnglass { background-position: 0 -453px;  } 
-.sprite2-port18 { background-position: 0 -519px;  } 
-.sprite2-red18 { background-position: 0 -587px;  } 
-.sprite2-rose18 { background-position: 0 -655px;  } 
-.sprite2-white18 { background-position: 0 -723px;  } 
+.sprite-aaaatransparent{ background-position: 0 0;  } 
+.sprite-arrowgreen{ background-position: 0 -51px;  } 
+.sprite-at{ background-position: 0 -107px;  } 
+.sprite-au{ background-position: 0 -167px;  } 
+.sprite-be{ background-position: 0 -229px;  } 
+.sprite-bg{ background-position: 0 -289px;  } 
+.sprite-ca{ background-position: 0 -349px;  } 
+.sprite-ch{ background-position: 0 -409px;  } 
+.sprite-champagne18{ background-position: 0 -469px;  } 
+.sprite-close{ background-position: 0 -537px;  } 
+.sprite-cn{ background-position: 0 -600px;  } 
+.sprite-cy{ background-position: 0 -662px;  } 
+.sprite-cz{ background-position: 0 -722px;  } 
+.sprite-de{ background-position: 0 -782px;  } 
+.sprite-dessert18{ background-position: 0 -842px;  } 
+.sprite-dglassdessert{ background-position: 0 -910px;  } 
+.sprite-dglassno{ background-position: 0 -1042px;  } 
+.sprite-dglassport{ background-position: 0 -1174px;  } 
+.sprite-dglassred{ background-position: 0 -1306px;  } 
+.sprite-dglassrose{ background-position: 0 -1438px;  } 
+.sprite-dglasssparkling{ background-position: 0 -1570px;  } 
+.sprite-dglasswhite{ background-position: 0 -1702px;  } 
+.sprite-dk{ background-position: 0 -1834px;  } 
+.sprite-dutch{ background-position: 0 -1894px;  } 
+.sprite-ee{ background-position: -122px 0;  } 
+.sprite-empty18{ background-position: -122px -60px;  } 
+.sprite-en{ background-position: -122px -128px;  } 
+.sprite-en{ background-position: -122px -188px;  } 
+.sprite-english{ background-position: -122px -251px;  } 
+.sprite-es{ background-position: -122px -314px;  } 
+.sprite-fi{ background-position: -122px -374px;  } 
+.sprite-fr{ background-position: -122px -434px;  } 
+.sprite-french{ background-position: -122px -494px;  } 
+.sprite-gb{ background-position: -122px -557px;  } 
+.sprite-glassdessert{ background-position: -122px -617px;  } 
+.sprite-glassno{ background-position: -122px -749px;  } 
+.sprite-glassport{ background-position: -122px -881px;  } 
+.sprite-glassred{ background-position: -122px -1013px;  } 
+.sprite-glassrose{ background-position: -122px -1145px;  } 
+.sprite-glasssparkling{ background-position: -122px -1277px;  } 
+.sprite-glasswhite{ background-position: -122px -1409px;  } 
+.sprite-gosmall{ background-position: -122px -1541px;  } 
+.sprite-gr{ background-position: -122px -1619px;  } 
+.sprite-grapered{ background-position: -122px -1679px;  } 
+.sprite-grapewhite{ background-position: -122px -1741px;  } 
+.sprite-greengo{ background-position: -122px -1803px;  } 
+.sprite-hk{ background-position: -122px -1880px;  } 
+.sprite-hu{ background-position: -122px -1940px;  } 
+.sprite-ie{ background-position: -244px 0;  } 
+.sprite-it{ background-position: -244px -60px;  } 
+.sprite-jp{ background-position: -244px -120px;  } 
+.sprite-lt{ background-position: -244px -180px;  } 
+.sprite-lu{ background-position: -244px -240px;  } 
+.sprite-lv{ background-position: -244px -300px;  } 
+.sprite-magnglass{ background-position: -244px -360px;  } 
+.sprite-mt{ background-position: -244px -426px;  } 
+.sprite-nl{ background-position: -244px -486px;  } 
+.sprite-no{ background-position: -244px -546px;  } 
+.sprite-nz{ background-position: -244px -606px;  } 
+.sprite-pl{ background-position: -244px -666px;  } 
+.sprite-port18{ background-position: -244px -726px;  } 
+.sprite-pt{ background-position: -244px -794px;  } 
+.sprite-red18{ background-position: -244px -854px;  } 
+.sprite-refinel{ background-position: -244px -922px;  } 
+.sprite-refiner{ background-position: -244px -1003px;  } 
+.sprite-resultfl{ background-position: -244px -1084px;  } 
+.sprite-resultfr{ background-position: -244px -1166px;  } 
+.sprite-resulthl{ background-position: -244px -1248px;  } 
+.sprite-resulthlstr{ background-position: -244px -1330px;  } 
+.sprite-resulthr{ background-position: -244px -1412px;  } 
+.sprite-rose18{ background-position: -244px -1494px;  } 
+.sprite-roundauthore{ background-position: -244px -1562px;  } 
+.sprite-roundauthoro{ background-position: -244px -1636px;  } 
+.sprite-roundrratingee{ background-position: -244px -1710px;  } 
+.sprite-roundrratingeo{ background-position: -244px -1784px;  } 
+.sprite-roundrratingoe{ background-position: -244px -1858px;  } 
+.sprite-roundrratingoo{ background-position: -244px -1932px;  } 
+.sprite-roundrvintagee{ background-position: -366px 0;  } 
+.sprite-roundrvintageo{ background-position: -366px -78px;  } 
+.sprite-roundwine{ background-position: -366px -156px;  } 
+.sprite-se{ background-position: -366px -278px;  } 
+.sprite-searchgo{ background-position: -366px -338px;  } 
+.sprite-sg{ background-position: -366px -424px;  } 
+.sprite-si{ background-position: -366px -484px;  } 
+.sprite-sk{ background-position: -366px -544px;  } 
+.sprite-sortasc{ background-position: -366px -604px;  } 
+.sprite-sortdesc{ background-position: -366px -667px;  } 
+.sprite-us{ background-position: -366px -730px;  } 
+.sprite-white18{ background-position: -366px -790px;  } 
+.sprite-za{ background-position: -366px -858px;  } 
+.sprite-zchateau{ background-position: -366px -918px;  } 

=== modified file 'css2/searchgo.png'
Binary files css2/searchgo.png	2009-08-01 13:25:27 +0000 and css2/searchgo.png	2010-09-21 10:30:50 +0000 differ
=== modified file 'header2.jsp'
--- header2.jsp	2010-09-21 09:04:18 +0000
+++ header2.jsp	2010-09-22 16:09:20 +0000
@@ -14,6 +14,7 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {

=== modified file 'index.jsp'
--- index.jsp	2010-09-21 09:04:18 +0000
+++ index.jsp	2010-09-22 13:37:11 +0000
@@ -120,8 +120,9 @@
 		<div id='mobile'><a href='<%=(PageHandler.getInstance(request,response).s!=null&&PageHandler.getInstance(request,response).s.wineset.knownwineid>0)?"/mwine/":"/m"+(PageHandler.getInstance(request,response).searchdata.getName().length()>2?"?name=":"")%><%=(PageHandler.getInstance(request,response).searchdata.getName().length()>2?Webroutines.URLEncode(Webroutines.removeAccents(PageHandler.getInstance(request,response).searchdata.getName()))+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage="+PageHandler.getInstance(request,response).searchdata.getVintage():"").trim():"")%>'>Mobile access</a><a href='/nf/wine-guide/' rel='nofollow'>Wine Guide</a><a href='/settings/index.jsp' rel='nofollow'>PriceAlerts</a><a href='/retailers.jsp'>Getting listed</a><a href='/about.jsp' rel='nofollow'>About us</a><a href='/links.jsp'>Links</a><a href='/publishers.jsp' rel='nofollow'>For web site owners</a><%if (request.getRemoteUser()!=null) {%><a href='/settings/index.jsp?logoff=true'>Log off</a><%} %></div>&nbsp;</div></div>
 		<%@ include file="/snippets/bigsearchbar.jsp" %>
 		<div class='textpage'>
+		<div style='border:3px dashed #4d0027;padding:10px;padding-top:0px;'><h2><font style='color:black;font-size:22px;' face='times, times new roman'>Breaking news! FINANCIAL TIMES: </font></h2><img src='/images/Jancis_Robinson.jpg' alt='Jancis Robinson' style='float:left;padding-right:10px;'/><h2>&#8220;Perhaps the most attractive, user-friendly competitor is Vinopedia.com&#8221;</h2>Jancis Robinson, in an article on Wine Search Engines in the <a href='http://www.ft.com/cms/s/2/121122dc-c1ea-11df-9d90-00144feab49a.html' target='_blank'>Financial Times</a>. Thank you, Jancis, this is the stuff that keeps us going!<br/>"Perhaps the most attractive, user-friendly competitor is Vinopedia.com, set up by Dutch wine lovers Jeroen Starrenburg and Jasper Hammink, who quit their jobs in IT to build a site that locates prices and stockists of 1.6m different wines (the current tally) but also incorporates individual wine ratings (from American wine magazine Wine Spectator). One particularly useful feature is that they identify wines whose prices have dropped most significantly recently and showcase them on their home page." Read the full artice in the <a href='http://www.ft.com/cms/s/2/121122dc-c1ea-11df-9d90-00144feab49a.html' target='_blank'>Financial Times</a> or the <a href='http://www.jancisrobinson.com/articles/a201009173.html' target='_blank'>Purple pages</a>.</div>
 		<h1>Compare online wine prices with vino<font color='black'>pedia</font></h1>
-		Vinopedia.com is a wine search engine that helps you to buy wine online. We compare the price lists of wine stores throughout the US, Canada and Europe, show you who is selling your favorite wine and who is the cheapest in the market. Just type (part) of a wine name in the search box to see how it works.<br/>We also give you background information of each wine, such as ratings, and you can use our <a href='/wine-guide/'>wine buying guide</a> to discover the best wines from a region or a grape variety, based on price and quality.<br/><br/>
+		<br/>Vinopedia.com is a wine search engine that helps you to buy wine online. We compare the price lists of wine stores world wide, show you who is selling your favorite wine and who is the cheapest in the market. Just type (part) of a wine name in the search box to see how it works.<br/>We also give you background information of each wine, such as ratings, and you can use our <a href='/wine-guide/'>wine buying guide</a> to discover the best wines from a region or a grape variety, based on price and quality.<br/><br/>
 		<%=Webroutines.getConfigKey("systemmessage")%>
 		<h2><a href='/heatmap.jsp'>What is happening around you?</a></h2>This is new functionality where we show a map of wine stores close to you and interesting new wines they got in the last week.
 				<%@ include file="/snippets/tips.jsp" %>

=== modified file 'moderator/analyzer.jsp'
--- moderator/analyzer.jsp	2009-08-01 13:25:27 +0000
+++ moderator/analyzer.jsp	2010-09-28 10:10:34 +0000
@@ -18,7 +18,7 @@
 	import="com.searchasaservice.parser.xpathparser.XpathParser"
 	import="com.searchasaservice.parser.xpathparser.XpathParserConfig"
 	import="com.searchasaservice.parser.xpathparser.Analyzer"
-	import="com.searchasaservice.parser.HTMLParser"
+	import="com.searchasaservice.parser.LoboParser"
 %><html>
 <head>
 <title>URL Analyzer</title>
@@ -32,9 +32,11 @@
 <body>
 <div id="dark"></div>
 <jsp:include page="moderatorlinks.jsp" />
-<script type="text/javascript" src="/js/Dojo/dojo/dojo.js"
-	djconfig="parseOnLoad: true">
+<script type="text/javascript" src="http://www.google.com/jsapi?key=<%=Configuration.GoogleApiKey%>"></script>
+<script type="text/javascript">
+google.load("dojo", "1.5");
 </script>
+
 <script type="text/javascript" src="scraper.js">
 </script>
 <script type="text/javascript">
@@ -88,7 +90,10 @@
 	if (actie != null && actie.equals("retrieve")) {
 		if (shopid>0){
 		an = Analyzer.getAnalyzer(c,shopid,row);
-		if (url.equals("")) url=Webroutines.getMostCommonUrl(shopid,auto);
+		if (url.equals("")) {
+			url=Webroutines.getMostCommonUrl(shopid,auto);
+			postdata=Webroutines.getMostCommonPostdata(shopid,auto);
+		}
 		URL u=null;
 		try{
 			u=new URL(url);
@@ -97,13 +102,15 @@
 			message+="Invalid url, please correct it.<br/>";
 		} else {
 		if (an!=null&&!"".equals(url)) {
+			an.url=url;
+			an.postdata=postdata;
 			%>
 			<script type="text/javascript">
 			greytext="Please wait, retrieving information on the page";
 			dograyOut(true);
 			</script><%
 			c.an=an;
-			c.an.document=new HTMLParser(HTMLParser.getPage(url)).document;
+			c.an.document=new LoboParser(url).document;
 			c.an.originaldocument=c.an.document;
 			c.an.tagDocument(c.an.document);
 			c.an.document=c.an.taggeddocument;
@@ -170,7 +177,7 @@
 <input type="button" name="submitButton" value="New Analyzer" onClick="javascript:submitForm('analyze',document.formOne)">
 <input type="button" name="submitButton" value="Edit existing Analyzer" onClick="javascript:submitForm('retrieve',document.formOne)">
 </form>
-<a href='analyzer.jsp?actie=analyze&amp;url=http://localhost.vinopedia.com:6001/testshop.jsp'>Analyze testshop</a>
+<a href='analyzer.jsp?actie=analyze&amp;url=https://test.vinopedia.com/testshop.jsp'>Analyze testshop</a>
 <% 
 if (actie!=null&&actie.equals("retrieve")&&shopid>0&&an==null){
 	if (shopid>0){
@@ -191,6 +198,7 @@
 			an=null;
 			an=new Analyzer(xppc);
 			an.setUrl(url);
+			an.setPostdata(postdata);
 			an.shopid=shopid;
 		} catch (Exception e){
 			message+="Could not create a parser: "+e.getMessage();

=== modified file 'moderator/scraper.js'
--- moderator/scraper.js	2009-08-01 13:25:27 +0000
+++ moderator/scraper.js	2010-09-28 09:57:46 +0000
@@ -315,6 +315,8 @@
 }
 var field=0;
 function editfield(f){
+	greytext="<img src='/images/spinner.gif' alt='wait'/>";
+	dograyOut(true);
 	field=f;
 	kw.url="xpathparser.jsp?action=clearHighlights";
 	dojo.xhrGet(kw);
@@ -324,9 +326,13 @@
 	hideedit();
 	captureEvents();	
 	document.getElementsByTagName("body")[0].onmouseover='this.style.cursor="move"';
+	dograyOut(false);
+	
 }
 
 function undoeditfield(){
+	greytext="<img src='/images/spinner.gif' alt='wait'/>";
+	dograyOut(true);
 	cancelcaptureEvents();	
 	kw.url="xpathparser.jsp?action=undonewPath";
 	dojo.xhrGet(kw);
@@ -334,9 +340,13 @@
 	document.getElementById('undoeditfield'+field).innerHTML="";
 	document.getElementById('saveeditfield'+field).innerHTML="";
 	showedit();
+	dograyOut(false);
+	
 }
 
 function saveeditfield(){
+	greytext="<img src='/images/spinner.gif' alt='wait'/>";
+	dograyOut(true);
 	cancelcaptureEvents();	
 	kw.url="xpathparser.jsp?action=savenewPath";
 	dojo.xhrGet(kw);
@@ -345,6 +355,7 @@
 	document.getElementById('saveeditfield'+field).innerHTML="";
 	refreshColors();
 	showedit();
+	dograyOut(false);
 }
 
 function hideedit(){
@@ -380,22 +391,22 @@
 
 	} else {
 		var tag=targ.getAttribute("fwscounter");
+		greytext="<img src='/images/spinner.gif' alt='wait'/>";
+		dograyOut(true);
 		kw.url="xpathparser.jsp?action=newPath&counter="+tag+"&field="+field;
 		dojo.xhrGet(kw);
+		
 		document.getElementById('targetdocument').innerHTML=resp;
+		dograyOut(false);
+		
 	}
 }
 function makeDrag(){
-	var m = new dojo.dnd.Moveable("analysisplaceholder",{handle: "handle"});
+	$(function() {
+		$( "#analysisplaceholder" ).draggable();
+	});
 	
-
-	dojo.subscribe("/dnd/move/start", function(mover){ 
-		console.debug("Start move", mover); 	
-	});
-	dojo.subscribe("/dnd/move/stop", function(mover){ 
-		console.debug("Stop move", mover); 	
-	});
-	//var m=dijit.placeOnScreen(document.getElementById("analysisplaceholder"),800,400,50);
+//var m=dijit.placeOnScreen(document.getElementById("analysisplaceholder"),800,400,50);
 }
 
 function savexp(){

=== modified file 'moderator/scraper.jsp'
--- moderator/scraper.jsp	2009-08-01 13:25:27 +0000
+++ moderator/scraper.jsp	2010-09-28 10:13:39 +0000
@@ -1,4 +1,4 @@
-<%@ page 
+<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%><%@ page 
 	import="java.util.ArrayList" 
 	import="java.util.List"
 	import="java.util.Iterator" import="java.util.ListIterator"
@@ -7,6 +7,7 @@
 	import="com.freewinesearcher.common.Wineset"
 	import="com.freewinesearcher.common.Context"
 	import="com.freewinesearcher.common.Webpage"
+	import="com.freewinesearcher.common.Configuration"
 	import="com.freewinesearcher.batch.Spider"
 	import="com.freewinesearcher.online.Webroutines"
 	import="com.freewinesearcher.batch.TableScraper"
@@ -28,13 +29,20 @@
 		
 %>
 <html><head>
+
+<script type="text/javascript" src="http://www.google.com/jsapi?key=<%=Configuration.GoogleApiKey%>"></script>
+<script type="text/javascript">
+google.load("dojo", "1.5");
+google.load("jquery", "1.4.2");
+google.load("jqueryui", "1.8.5");
+</script>
+
 <% out.write(XpathParser.getNodeAsXML(c.an.getNodeFromxpath("//head")));%>
-<script type="text/javascript" src="/js/Dojo/dojo/dojo.js"
-	djconfig="parseOnLoad: true">
-</script>
+
 <script type="text/javascript" src="scraper.js">
 </script>
 <body>
+<div id="dark"></div>
 <div class="moveable" id='analysisplaceholder' style='background-color:#ffffff;text-align:left;position:fixed;top:200px;right:50px;width:250px;z-index:9;border-style:solid;border-width:2px;'>
 <div id="handle" style='background-color:blue;color:white;font-family: Arial,sans-serif;font-size: 13px;' onmouseover='this.style.cursor="move"'>
 Analysis (click to drag)</div>
@@ -45,7 +53,7 @@
 %>
 </table><table>
 <tr><td onclick='javascript:savexp();' onmouseover="document.body.style.cursor='pointer'" onmouseout="document.body.style.cursor='default'" style="color:blue;text-decoration:underline"><div class='fwseditfield' id='fwssave'>Save configuration</div></td></tr>
-<tr><td><a href='showwines.jsp' target="_blank"> Show result</a></td></tr>
+
 </table>
 </div>
 </div>	

=== modified file 'moderator/xpathparser.jsp'
--- moderator/xpathparser.jsp	2009-08-01 13:25:27 +0000
+++ moderator/xpathparser.jsp	2010-09-28 10:11:42 +0000
@@ -40,8 +40,8 @@
 				}
 			} else {
 				session.setAttribute("savexp",true);
-				out.write("not yet saved");
-				Dbutil.logger.info("notsaved");
+				out.write("notsaved");
+				//Dbutil.logger.info("notsaved");
 				
 			}
 		}

=== modified file 'snippets/bigsearchbar.jsp'
--- snippets/bigsearchbar.jsp	2010-09-21 09:04:18 +0000
+++ snippets/bigsearchbar.jsp	2010-09-21 10:46:45 +0000
@@ -12,7 +12,7 @@
 		<h1>The world's most powerful search engine for wine</h1>
 		<form action='<%=PageHandler.getInstance(request,response).searchpage%>' method="post" id="searchform" name="searchform"><input type="hidden" name="dosearch" value="true" /><input class='searchinput' id='name' type='text' name="name" value="<%=Webroutines.escape(PageHandler.getInstance(request,response).searchdata.getName())%>" size="25"  /></form>
 		<div class='explanation'>Enter a wine, store, region or producer name and search in <%=Dbutil.readIntValueFromDB("Select count(*) as thecount from wines","thecount")%> wine offers, or try our <a style='text-decoration:underline;' href='/wine-guide/'>wine guide</a>.</div>
-		<input type='image' class='searchgo' src='<%=Configuration.cdnprefix%>/css2/searchgo.png' onclick='document.getElementById("searchform").submit()' alt='Search'/>
+		<input type='image' class='sprite sprite-searchgo searchgo' src='/images/transparent.gif' onclick='document.getElementById("searchform").submit()' alt='Search'/>
 </div>
 </div>
 

=== modified file 'storelocatordemo.jsp'
--- storelocatordemo.jsp	2010-09-21 09:04:18 +0000
+++ storelocatordemo.jsp	2010-09-29 09:45:08 +0000
@@ -20,7 +20,7 @@
 The widget is extremely simple and easy to use. We detect the location of the visitor and show all nearby retailers that carry your wine. When a visitor clicks on a store, we show which of your wines they have in stock. <br/>
 By zooming out or dragging the map, they can look at availability in other locations.
 <h2>Give it a try!</h2>
-The box below is how it will appear on your web site.<br/><br/>
+The box below is how it will appear on your web site. Use the zoom function to see the availability of your wines in Europe, the USA, Australia etc.<br/><br/>
 <div id='storelocator' style='border:1px solid black;width:900px;height:500px;'>Loading store locator from <a href='https://www.vinopedia.com/winery/<%=Webroutines.URLEncodeUTF8Normalized(sl.producername).replaceAll("%2F", "/").replace("&", "&amp;") %>' target='_blank' id='vplink'>Vinopedia.com</a>
 <noscript><h4><font color='red'>Javascript in currently disabled in your browser. In order to use the store locator you need to enable Javascript. </font></h4></noscript>
 <script src='http://<%=(Configuration.serverrole.equals("DEV")?"test":"www") %>.vinopedia.com/js/injectstorelocator.jsp?id=<%=sl.getProducer() %>' ></script></div>

=== modified file 'testshop.jsp'
--- testshop.jsp	2009-08-01 13:25:27 +0000
+++ testshop.jsp	2010-09-27 16:47:07 +0000
@@ -31,7 +31,7 @@
 
 <tr><td><a href="https://www.vinopedia.com/wine/leoville las cases">Leoville las Cases</a></td><td>1990</td><td>St. Julien</td><td>120,00</td></tr>
 <tr><td><a href="/wine/leoville las cases">Leoville las Cases</a></td><td>1991</td><td>St. Julien</td><td>40,00</td></tr>
-<tr><td>Rieussec</td><td>2001</td><td>Sauternes</td><td>150,00</td></tr>
+<tr><td>Rieussec</td><td>2001</td><td>Sauternes</td><td>&euro; 150,00</td></tr>
 <tr><td>Leoville las Cases</td><td>1993</td><td>St. Julien</td><td>300,00</td></tr>
 <tr><td>Leoville las Cases</td><td>1994</td><td>St. Julien</td><td>500,00</td></tr>
 </table></body></html>
\ No newline at end of file

=== modified file 'vinopedia.build'
--- vinopedia.build	2010-09-21 09:04:18 +0000
+++ vinopedia.build	2010-09-23 12:45:40 +0000
@@ -1,3 +1,3 @@
 #Build Number for ANT. Do not edit!
-#Thu Aug 26 12:35:45 CEST 2010
-build.number=613
+#Thu Sep 23 14:45:40 CEST 2010
+build.number=627

=== modified file 'work/org/apache/jsp/admin/salesdashboard_jsp.java'
--- work/org/apache/jsp/admin/salesdashboard_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/admin/salesdashboard_jsp.java	2010-09-22 10:02:39 +0000
@@ -14,14 +14,18 @@
 import com.freewinesearcher.common.Knownwines;
 import com.freewinesearcher.common.Dbutil;
 import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
 import com.freewinesearcher.online.Ad;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Configuration;
 import java.util.HashSet;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.online.Webroutines;
 import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.common.Configuration;
 import java.text.SimpleDateFormat;
+import com.freewinesearcher.common.Configuration;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.common.Dbutil;
 
@@ -85,10 +89,6 @@
       out.write('\r');
       out.write('\n');
  
-response.setHeader("Cache-Control","max-age=3600"); //HTTP 1.1
-//response.setHeader("Pragma","no-cache"); //HTTP 1.0
-response.setDateHeader ("Expires", 0); //prevents caching at the proxy server
-
 
 //if (request.getServerName().toLowerCase().contains("searchasaservice")&&!request.getServletPath().toLowerCase().contains("searchasaservice")) {
 	//	response.sendRedirect("/searchasaservice.jsp");
@@ -103,6 +103,11 @@
 	} else {
 		querystring="?"+querystring;
 	}
+	if (originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/wine-guide/")||originalurl.contains("/region/")){
+		response.setHeader("Cache-Control","max-age=3600");} //HTTP 1.1
+		//response.setHeader("Pragma","no-cache"); //HTTP 1.0
+		response.setDateHeader ("Expires", 0); //prevents caching at the proxy server
+
 	if (PageHandler.getInstance(request,response).abuse){
 		response.setStatus(403);
 		
@@ -123,17 +128,35 @@
 		response.setHeader( "Connection", "close" );
 		return; 
 	}
-	if (originalurl.contains("/wine/")&&((!Webroutines.getRegexPatternValue("([^%_-]\\d\\d\\d\\d)$",originalurl).equals("")&&!querystring.contains("vintage"))||originalurl.contains("%20")||!Webroutines.removeAccents(request.getParameter("name")).equals(request.getParameter("name")))){
+	if (originalurl.contains("https://")&&request.getRemoteUser()==null&&(originalurl.contains("/wine/")||originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/region/"))){
+		String newurl=originalurl.replace("https://","http://");
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	//(!Webroutines.getRegexPatternValue("([^%_-]\\d\\d\\d\\d)$",originalurl).equals("")&&!querystring.contains("vintage"))
+	if (originalurl.contains("/wine/")&&(originalurl.contains("%20")||!Webroutines.removeAccents(request.getParameter("name")).equals(request.getParameter("name")))){
 		String originalvintage=Webroutines.getRegexPatternValue("(?:%20| |\\+)(\\d\\d\\d\\d)$",originalurl);
 		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
 		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")))+(querystring.length()>1?querystring:"");
-		if (originalvintage.length()>0) redurl=redurl.replaceAll("\\+"+originalvintage,"")+(querystring.length()>0?"&":"?")+"vintage="+originalvintage;
-		response.setStatus(301);
-		response.setHeader( "Location", redurl);
-		response.setHeader( "Connection", "close" );
-		return;
-	}
-	
+		if (originalvintage.length()>0) redurl=redurl.replaceAll("\\+"+originalvintage,"")+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	if (originalurl.contains("/wine/")&&querystring.startsWith("?vintage")&&querystring.length()==13){
+		String originalvintage=Webroutines.getRegexPatternValue("(\\d\\d\\d\\d)$",querystring);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")));
+		if (originalvintage.length()>0) redurl=redurl+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	 
 
 	if (request.getParameter("logoff") != null) {
     response.sendRedirect("/logout.jsp");
@@ -158,9 +181,9 @@
       out.write("\r\n");
       out.write("\r\n");
       out.write("\r\n");
-      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"/css/");
+      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"");
       out.print(Configuration.stylesheet );
-      out.write("\" />\r\n");
+      out.write("\" />  \r\n");
 } else {
       out.write("\r\n");
       out.write("<link rel=\"stylesheet\" type=\"text/css\" media=\"print\" href=\"/print.css\" />\r\n");
@@ -183,8 +206,12 @@
       out.write("<meta name=\"robots\" content=\"index,follow\" />\r\n");
  } 
       out.write("\r\n");
-      out.write("<link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\" />\r\n");
-      out.write("<script type=\"text/javascript\" src=\"/js/combinedjs.js?version=5\"></script>\r\n");
+      out.write("<link rel=\"icon\" type=\"image/png\" href=\"");
+      out.print(Configuration.staticprefix );
+      out.write("/favicon.png\" /> \r\n");
+      out.write("<script type=\"text/javascript\" src=\"");
+      out.print(Configuration.staticprefix);
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
       out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
       out.write('\r');
       out.write('\n');
@@ -213,12 +240,17 @@
       out.write('\n');
  //PageHandler p=(PageHandler)request.getAttribute("pagehandler");
       out.write("\r\n");
-      out.write("<div class='topbar'>\r\n");
-      out.write("<div class='topbarcontent'>\r\n");
-      out.write("<div id='mobile'><a href='");
+      out.write(" \r\n");
+      out.write("<div class='topbar spriter spriter-refine'>\r\n");
+      out.write("<div class='topbarcontent'><img src='");
+      out.print(Configuration.staticprefix );
+      out.write("/css/sprite.png' style='display:none;width:1px;height:1px' alt=''/><img src='");
+      out.print(Configuration.cdnprefix );
+      out.write("/css/spriter.png' style='display:none;width:1px;height:1px' alt=''/>\r\n");
+      out.write("<div id='mobile'><a rel='nofollow' href='/nf");
       out.print((PageHandler.getInstance(request,response).s!=null&&PageHandler.getInstance(request,response).s.wineset.knownwineid>0)?"/mwine/":"/m"+(PageHandler.getInstance(request,response).searchdata.getName().length()>2?"?name=":""));
       out.print((PageHandler.getInstance(request,response).searchdata.getName().length()>2?Webroutines.URLEncode(Webroutines.removeAccents(PageHandler.getInstance(request,response).searchdata.getName()))+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage="+PageHandler.getInstance(request,response).searchdata.getVintage():"").trim():""));
-      out.write("'>Mobile access</a><a href='/wine-guide/'>Wine Guide</a><a href='/settings/index.jsp'>PriceAlerts</a><a href='/retailers.jsp'>Getting listed</a><a href='/about.jsp'>About us</a><a href='/links.jsp'>Links</a><a href='/publishers.jsp'>For web site owners</a>");
+      out.write("'>Mobile access</a><a href='/nf/wine-guide/' rel='nofollow'>Wine Guide</a><a href='/settings/index.jsp' rel='nofollow'>PriceAlerts</a><a href='/retailers.jsp' rel='nofollow'>Getting listed</a><a href='/about.jsp' rel='nofollow'>About us</a><a href='/links.jsp' rel='nofollow'>Links</a><a href='/publishers.jsp' rel='nofollow'>For web site owners</a>");
 if (request.getRemoteUser()!=null) {
       out.write("<a href='/settings/index.jsp?logoff=true'>Log off</a>");
 } 
@@ -247,7 +279,9 @@
       out.write("\r\n");
       out.write("\r\n");
       out.write("<div class='logoandsearch' id='logoandsearch'>\r\n");
-      out.write("\t\t<div class='logo'><a href=\"/\"><img src='/css2/logo.png' alt='Home page'/></a></div>\r\n");
+      out.write("\t\t<div class='logo'><a href=\"/\"><img src='");
+      out.print(Configuration.cdnprefix);
+      out.write("/css2/logo.png' alt='Home page'/></a></div>\r\n");
       out.write("\t\t<div class='search'>\r\n");
       out.write("\t\t<div class='findwine'>");
       out.print(PageHandler.getInstance(request,response).t.get("searchwine"));
@@ -325,6 +359,9 @@
       out.write("<a href=\"");
       out.print( response.encodeURL("/admin/salesdashboard.jsp"));
       out.write("\">Sales dashboard</a><br/>\r\n");
+      out.write("<a href=\"");
+      out.print( response.encodeURL("/admin/financedashboard.jsp"));
+      out.write("\">Finance dashboard</a><br/>\r\n");
       out.write('\r');
       out.write('\n');
   	String shopid = request.getParameter("shopid");
@@ -427,13 +464,41 @@
       out.write("Wines displayed:\r\n");
 out.write(Webroutines.query2table("select concat(wines.name,CAST(if(logging.vintage>0,logging.vintage,'') AS CHAR)) as Wine,price as `Price on site`,format(priceeuroex,2) as `Price in euro ex. VAT`,count(*) as Views, format(count(*) * priceeuroex,2)  as `Total value` from logging join wines on (logging.wineid=wines.id) where logging.shopid="+shopid+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0 group by wineid,wines.vintage order by Views desc;", true, false));
       out.write("<br/>\r\n");
- } 
-      out.write("\r\n");
-      out.write("\r\n");
-      out.write("\r\n");
-      out.write("\r\n");
+      out.write("\r\n");
+ float dollar=Float.parseFloat(Dbutil.readValueFromDB("select * from currency where currency='USD'","rate")); 
+      out.write("\r\n");
+      out.write("<br/><br/>\r\n");
+      out.print(Dbutil.readValueFromDB("select count(distinct(ip)) as visitors from logging where shopid="+shop+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"')  and bot=0;","visitors") );
+      out.write(" unique visitors have viewed the store page.<br/>\r\n");
+      out.print(Dbutil.readValueFromDB("select count(*) as visitors from logging where shopid="+shop+" and type not like '%wineinfo%' and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0;","visitors") );
+      out.write(" views of the store page.<br/>\r\n");
+      out.print(Dbutil.readValueFromDB("select count(*) as visitors from logging where shopid="+shop+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0 and wineid>0;","visitors") );
+      out.write(" wines were selected with a total value of US$ ");
+      out.print(Dbutil.readValueFromDB("select format(sum(priceeuroex/"+dollar+"),2) as value from logging join wines on (logging.wineid=wines.id) where logging.shopid="+shop+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0;","value") );
+      out.write(" ex. sales tax.<br/>\r\n");
+ 
+//<%=Dbutil.readValueFromDB("select count(*) as visitors from logging where shopid="+shop+" and type = 'Link Clicked' and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0;","visitors") % > clicks to the web site of the store.<br/>*/
+
       out.write('\r');
       out.write('\n');
+      out.print(Dbutil.readValueFromDB("select count(*) as n from wines where shopid="+shop+";","n") );
+      out.write(" wines in store, listed since ");
+      out.print(Dbutil.readValueFromDB("select date(min(createdate)) as startdate from history where shopid="+shop+";","startdate") );
+      out.write(".<br/>\r\n");
+      out.write("<br/>\r\n");
+      out.write("Orders placed: \r\n");
+      out.print(Webroutines.query2table("select date(date) as Date,wineprice/"+dollar+" as 'Order value'  from logging where type like 'Sent%' and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and shopid="+shop+" order by date desc ;", true, false));
+      out.write("<br/>\r\n");
+      out.write("Wines displayed:\r\n");
+out.write(Webroutines.query2table("select concat(wines.name,CAST(if(logging.vintage>0,logging.vintage,'') AS CHAR)) as Wine,price as `Price on site`,format(priceeuroex/"+dollar+",2) as `Price in US$ ex. sales tax`,count(*) as Views, format(count(*) * priceeuroex/"+dollar+",2)  as `Total value` from logging join wines on (logging.wineid=wines.id) where logging.shopid="+shopid+" and date between date('"+startdate.toString().substring(0,10)+"') and date('"+enddate.toString().substring(0,10)+"') and bot=0 group by wineid,wines.vintage order by Views desc;", true, false));
+      out.write("<br/>\r\n");
+ } 
+      out.write("\r\n");
+      out.write("\r\n");
+      out.write("\r\n");
+      out.write("\r\n");
+      out.write("\r\n");
+      out.write("\r\n");
  
 	PageHandler.getInstance(request,response).getLogger().logaction();
 	session.setAttribute("lasturl",PageHandler.getInstance(request,response).thispage);
@@ -470,10 +535,16 @@
       out.write("window.google_analytics_uacct = \"UA-1788182-2\";\r\n");
       out.print(PageHandler.getInstance(request,response).GAtracking);
       out.write("\r\n");
+      out.write("pageTracker._setDomainName('");
+      out.print(("DEV".equals(Configuration.serverrole)?"test":"www"));
+      out.write(".vinopedia.com');\r\n");
       out.write("pageTracker._trackPageview();\r\n");
       out.write("</script>\t\t\t\r\n");
 PageHandler.getInstance(request,response).firstrequest=false;
 PageHandler.getInstance(request,response).cleanup();
+//for (Cookie cookie:request.getCookies()) {
+//	if (cookie.getName().equals("wineid")||cookie.getName().equals("sort")||cookie.getName().equals("vintage")) {cookie.setMaxAge(0);response.addCookie(cookie);}
+//}
  
       out.write('	');
       out.write("\t\r\n");

=== modified file 'work/org/apache/jsp/admin/visitingguide_jsp.class'
Binary files work/org/apache/jsp/admin/visitingguide_jsp.class	2010-05-03 15:10:31 +0000 and work/org/apache/jsp/admin/visitingguide_jsp.class	2010-09-29 10:08:24 +0000 differ
=== modified file 'work/org/apache/jsp/admin/visitingguide_jsp.java'
--- work/org/apache/jsp/admin/visitingguide_jsp.java	2010-05-03 15:10:31 +0000
+++ work/org/apache/jsp/admin/visitingguide_jsp.java	2010-09-23 10:23:47 +0000
@@ -10,12 +10,24 @@
 import com.freewinesearcher.batch.ProducersOld;
 import java.util.ArrayList;
 import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.common.Knownwines;
+import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
 
 public final class visitingguide_jsp extends org.apache.jasper.runtime.HttpJspBase
     implements org.apache.jasper.runtime.JspSourceDependent {
 
   private static java.util.List _jspx_dependants;
 
+  static {
+    _jspx_dependants = new java.util.ArrayList(2);
+    _jspx_dependants.add("/header2.jsp");
+    _jspx_dependants.add("/snippets/jsincludes.jsp");
+  }
+
   public Object getDependants() {
     return _jspx_dependants;
   }
@@ -36,7 +48,7 @@
 
     try {
       _jspxFactory = JspFactory.getDefaultFactory();
-      response.setContentType("text/html");
+      response.setContentType("text/html; charset=ISO-8859-1");
       pageContext = _jspxFactory.getPageContext(this, request, response,
       			null, true, 8192, true);
       _jspx_page_context = pageContext;
@@ -50,7 +62,142 @@
       out.write("\r\n");
       out.write("<html>\r\n");
       out.write("<head>\r\n");
-      out.write("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\r\n");
+      out.write('\r');
+      out.write('\n');
+ 
+
+//if (request.getServerName().toLowerCase().contains("searchasaservice")&&!request.getServletPath().toLowerCase().contains("searchasaservice")) {
+	//	response.sendRedirect("/searchasaservice.jsp");
+	//	return;
+	//}
+	String originalurl=(String)request.getAttribute("originalURL");
+	if (originalurl==null) originalurl="";	
+ 
+	String querystring=(String)request.getAttribute("originalQueryString");
+	
+	if (querystring==null||querystring.equals("")) {
+		querystring="";	
+	} else {
+		querystring="?"+querystring;
+	}
+	if (originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/wine-guide/")||originalurl.contains("/region/")){
+		response.setHeader("Cache-Control","max-age=3600");} //HTTP 1.1
+		//response.setHeader("Pragma","no-cache"); //HTTP 1.0
+		response.setDateHeader ("Expires", 0); //prevents caching at the proxy server
+
+	if (PageHandler.getInstance(request,response).abuse){
+		response.setStatus(403);
+		
+      out.write('\r');
+      out.write('\n');
+      if (true) {
+        _jspx_page_context.forward("abuse.jsp");
+        return;
+      }
+
+		return;
+	}
+	if (originalurl.contains("/region/")&&(originalurl.contains(" ")||originalurl.contains("%20")||!originalurl.endsWith("/"))){
+		String newurl=originalurl.replaceAll(" ","+").replaceAll("%20","+");
+		if (!newurl.endsWith("/")) newurl+="/";
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	if (originalurl.contains("https://")&&request.getRemoteUser()==null&&(originalurl.contains("/wine/")||originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/region/"))){
+		String newurl=originalurl.replace("https://","http://");
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	//(!Webroutines.getRegexPatternValue("([^%_-]\\d\\d\\d\\d)$",originalurl).equals("")&&!querystring.contains("vintage"))
+	if (originalurl.contains("/wine/")&&(originalurl.contains("%20")||!Webroutines.removeAccents(request.getParameter("name")).equals(request.getParameter("name")))){
+		String originalvintage=Webroutines.getRegexPatternValue("(?:%20| |\\+)(\\d\\d\\d\\d)$",originalurl);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")))+(querystring.length()>1?querystring:"");
+		if (originalvintage.length()>0) redurl=redurl.replaceAll("\\+"+originalvintage,"")+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	if (originalurl.contains("/wine/")&&querystring.startsWith("?vintage")&&querystring.length()==13){
+		String originalvintage=Webroutines.getRegexPatternValue("(\\d\\d\\d\\d)$",querystring);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")));
+		if (originalvintage.length()>0) redurl=redurl+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	 
+
+	if (request.getParameter("logoff") != null) {
+    response.sendRedirect("/logout.jsp");
+    return;
+  }
+
+	if (originalurl.contains("freewinesearcher")&&!originalurl.contains("wine2/")){
+		String newurl=originalurl.replace("freewinesearcher","vinopedia")+querystring;
+		session.setAttribute("fws","true");
+		response.setStatus(301);
+		response.setHeader( "Location", newurl );
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	
+	if (!PageHandler.getInstance(request,response).block&&!PageHandler.getInstance(request,response).abuse){
+
+      out.write("\r\n");
+      out.write("<!-- google_ad_section_start -->\r\n");
+      out.write("\r\n");
+	if (!"Y".equals(Webroutines.filterUserInput(request.getParameter("print")))){
+      out.write("\r\n");
+      out.write("\r\n");
+      out.write("\r\n");
+      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"");
+      out.print(Configuration.stylesheet );
+      out.write("\" />  \r\n");
+} else {
+      out.write("\r\n");
+      out.write("<link rel=\"stylesheet\" type=\"text/css\" media=\"print\" href=\"/print.css\" />\r\n");
+} 
+      out.write("\r\n");
+      out.write("\r\n");
+      out.write("<!-- google_ad_section_end -->\r\n");
+      out.write("<meta http-equiv=\"Content-Type\" content=\"text/html;charset=ISO-8859-1\" />\r\n");
+ if ((originalurl.contains("/index.jsp")&&!originalurl.contains("wine-guide")&&!originalurl.contains("/store/")||originalurl.contains("/external.jsp")||originalurl.contains("/winelinks.jsp"))){ 
+
+      out.write("<meta name=\"robots\" content=\"noindex,nofollow\" />\r\n");
+ } else if (originalurl.contains("/wine2")){
+		
+      out.write("<meta name=\"robots\" content=\"noindex,nofollow\" />\r\n");
+	} else if (originalurl.contains("topwines")) {
+
+      out.write("<meta name=\"robots\" content=\"noindex,follow\" />\r\n");
+	} else {	
+
+      out.write("<meta name=\"robots\" content=\"index,follow\" />\r\n");
+ } 
+      out.write("\r\n");
+      out.write("<link rel=\"icon\" type=\"image/png\" href=\"");
+      out.print(Configuration.staticprefix );
+      out.write("/favicon.png\" /> \r\n");
+      out.write("<script type=\"text/javascript\" src=\"");
+      out.print(Configuration.staticprefix);
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
+      out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
+      out.write('\r');
+      out.write('\n');
+      out.write(' ');
+} 
+      out.write('\r');
+      out.write('\n');
+      out.write("\r\n");
+      out.write("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\">\r\n");
       out.write("\r\n");
       out.write("\r\n");
       out.write("</head>\r\n");
@@ -112,6 +259,11 @@
       out.write("      \tcustomicon.transparent = \"/images/icons/empty.png\";\r\n");
       out.write("      \tcustomicon.infoWindowAnchor = new GPoint(18,18 );\r\n");
       out.write("      \tcustomicon.imageMap=[0,0,0,35,35,35,35,0,0,0];\r\n");
+      out.write("      \tvar invicon = new GIcon();\r\n");
+      out.write("\t\tinvicon.image = \"/images/transparent.gif\";\r\n");
+      out.write("\t\tinvicon.iconSize = new GSize(0, 0);\r\n");
+      out.write("\t  \tinvicon.shadowSize = new GSize(0, 0);\r\n");
+      out.write("\t  \tinvicon.iconAnchor = new GPoint(0, 0);\r\n");
       out.write("\t\t\r\n");
       out.write("\t\t\r\n");
       out.write("  \t\t// Add markers\r\n");
@@ -121,7 +273,7 @@
   	out.write("var gmarkeroptions;\n"); 
   	out.write("var bounds = new GLatLngBounds;");
   		for (int i=0;i<producers.name.size();i++){
-	  			out.write("marker=new GMarker(new GLatLng("+producers.lat.get(i)+","+producers.lon.get(i)+"),{title:\""+producers.name.get(i).replace("'","&apos;").replace("\"","&apos;")+"\""+(producers.accuracy.get(i)<5?",icon:customicon":"")+"});\n");
+	  			out.write("marker=new LabeledMarker(new GLatLng("+producers.lat.get(i)+","+producers.lon.get(i)+"),{title:\""+producers.name.get(i).replace("'","&apos;").replace("\"","&apos;")+"\",labelText:\""+(i+1)+"\",labelClass:\"regionpoi\",icon:invicon,labelOffset:new GSize(-5, -10)});\n");
 	  			//out.write("marker=new GMarker(new GLatLng("+shop.lat+","+shop.lon+"),mOpts);\n");
 	  			out.write("bounds.extend(new GLatLng("+producers.lat.get(i)+","+producers.lon.get(i)+"));");
 	  			out.write("GEvent.addListener(marker, 'click', function() {  window.location.hash='producer"+(i+1)+"'; });");
@@ -148,7 +300,7 @@
       out.print(Configuration.GoogleApiKey);
       out.write("\"\r\n");
       out.write("      type=\"text/javascript\"></script>\r\n");
-      out.write("\r\n");
+      out.write("<script type=\"text/javascript\" src=\"/js/googlemaps/labeled_marker.js\"></script>\r\n");
       out.write("    <script type=\"text/javascript\">load();</script>\r\n");
       out.write("\t<script type=\"text/javascript\">\r\n");
       out.write("\tfunction refreshdata(){\r\n");

=== modified file 'work/org/apache/jsp/contact_jsp.class'
Binary files work/org/apache/jsp/contact_jsp.class	2010-09-21 09:04:18 +0000 and work/org/apache/jsp/contact_jsp.class	2010-09-29 10:08:24 +0000 differ
=== modified file 'work/org/apache/jsp/contact_jsp.java'
--- work/org/apache/jsp/contact_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/contact_jsp.java	2010-09-22 10:50:41 +0000
@@ -14,10 +14,13 @@
 import com.freewinesearcher.online.Ad;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Configuration;
 import java.util.HashSet;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.online.Webroutines;
 import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.common.Dbutil;
 
@@ -126,12 +129,17 @@
       out.write('\n');
  //PageHandler p=(PageHandler)request.getAttribute("pagehandler");
       out.write("\r\n");
-      out.write("<div class='topbar'>\r\n");
-      out.write("<div class='topbarcontent'>\r\n");
-      out.write("<div id='mobile'><a href='");
+      out.write(" \r\n");
+      out.write("<div class='topbar spriter spriter-refine'>\r\n");
+      out.write("<div class='topbarcontent'><img src='");
+      out.print(Configuration.staticprefix );
+      out.write("/css/sprite.png' style='display:none;width:1px;height:1px' alt=''/><img src='");
+      out.print(Configuration.cdnprefix );
+      out.write("/css/spriter.png' style='display:none;width:1px;height:1px' alt=''/>\r\n");
+      out.write("<div id='mobile'><a rel='nofollow' href='/nf");
       out.print((PageHandler.getInstance(request,response).s!=null&&PageHandler.getInstance(request,response).s.wineset.knownwineid>0)?"/mwine/":"/m"+(PageHandler.getInstance(request,response).searchdata.getName().length()>2?"?name=":""));
       out.print((PageHandler.getInstance(request,response).searchdata.getName().length()>2?Webroutines.URLEncode(Webroutines.removeAccents(PageHandler.getInstance(request,response).searchdata.getName()))+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage="+PageHandler.getInstance(request,response).searchdata.getVintage():"").trim():""));
-      out.write("'>Mobile access</a><a href='/wine-guide/'>Wine Guide</a><a href='/settings/index.jsp'>PriceAlerts</a><a href='/retailers.jsp'>Getting listed</a><a href='/about.jsp'>About us</a><a href='/links.jsp'>Links</a><a href='/publishers.jsp'>For web site owners</a>");
+      out.write("'>Mobile access</a><a href='/nf/wine-guide/' rel='nofollow'>Wine Guide</a><a href='/settings/index.jsp' rel='nofollow'>PriceAlerts</a><a href='/retailers.jsp' rel='nofollow'>Getting listed</a><a href='/about.jsp' rel='nofollow'>About us</a><a href='/links.jsp' rel='nofollow'>Links</a><a href='/publishers.jsp' rel='nofollow'>For web site owners</a>");
 if (request.getRemoteUser()!=null) {
       out.write("<a href='/settings/index.jsp?logoff=true'>Log off</a>");
 } 
@@ -160,7 +168,9 @@
       out.write("\r\n");
       out.write("\r\n");
       out.write("<div class='logoandsearch' id='logoandsearch'>\r\n");
-      out.write("\t\t<div class='logo'><a href=\"/\"><img src='/css2/logo.png' alt='Home page'/></a></div>\r\n");
+      out.write("\t\t<div class='logo'><a href=\"/\"><img src='");
+      out.print(Configuration.cdnprefix);
+      out.write("/css2/logo.png' alt='Home page'/></a></div>\r\n");
       out.write("\t\t<div class='search'>\r\n");
       out.write("\t\t<div class='findwine'>");
       out.print(PageHandler.getInstance(request,response).t.get("searchwine"));
@@ -244,7 +254,7 @@
       out.write("<h1>Contact us</h1>\r\n");
       out.write("<FORM ACTION=\"contact.jsp\" METHOD=\"POST\">\r\n");
       out.write("What do you think of our site? Did you experience any problems? Got any suggestions or comments? We love to hear from you! If you are a selling wines and would like to get listed on Vinopedia.com, please <a href='retailers.jsp'>sign up here</a>.<br/><br/>\r\n");
-      out.write("Note: Vinopedia is a search engine for wine and does not sell wine directly or negotiate deals. If you would like to order wine, please do so using our store page or contact the store directly. <br/>\r\n");
+      out.write("Note: <b style='color:red'>Vinopedia is a search engine for wine, we do not sell wine</b> directly or negotiate deals. If you see a wine on our site that you would like to buy or that you need more information about, please contact the seller/store directly. We will not answer any inquiries about price/availability/shipment.<br/>\r\n");
       out.write("<br/>\r\n");
       out.write("    <TABLE>\r\n");
       out.write("\t\t<TR><TD>Name</TD><TD><INPUT TYPE=\"TEXT\" NAME=\"name\" value=\"");
@@ -273,8 +283,8 @@
 } 
       out.write("\r\n");
       out.write("\r\n");
-      out.write('\r');
-      out.write('\n');
+      out.write("\r\n");
+      out.write("\r\n");
  
 	PageHandler.getInstance(request,response).getLogger().logaction();
 	session.setAttribute("lasturl",PageHandler.getInstance(request,response).thispage);
@@ -311,10 +321,16 @@
       out.write("window.google_analytics_uacct = \"UA-1788182-2\";\r\n");
       out.print(PageHandler.getInstance(request,response).GAtracking);
       out.write("\r\n");
+      out.write("pageTracker._setDomainName('");
+      out.print(("DEV".equals(Configuration.serverrole)?"test":"www"));
+      out.write(".vinopedia.com');\r\n");
       out.write("pageTracker._trackPageview();\r\n");
       out.write("</script>\t\t\t\r\n");
 PageHandler.getInstance(request,response).firstrequest=false;
 PageHandler.getInstance(request,response).cleanup();
+//for (Cookie cookie:request.getCookies()) {
+//	if (cookie.getName().equals("wineid")||cookie.getName().equals("sort")||cookie.getName().equals("vintage")) {cookie.setMaxAge(0);response.addCookie(cookie);}
+//}
  
       out.write('	');
       out.write("\t\r\n");

=== modified file 'work/org/apache/jsp/header2_jsp.class'
Binary files work/org/apache/jsp/header2_jsp.class	2010-09-21 09:04:18 +0000 and work/org/apache/jsp/header2_jsp.class	2010-09-29 10:08:24 +0000 differ
=== modified file 'work/org/apache/jsp/header2_jsp.java'
--- work/org/apache/jsp/header2_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/header2_jsp.java	2010-09-27 15:02:25 +0000
@@ -62,6 +62,7 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {

=== modified file 'work/org/apache/jsp/header_jsp.java'
--- work/org/apache/jsp/header_jsp.java	2010-04-13 10:13:17 +0000
+++ work/org/apache/jsp/header_jsp.java	2010-09-22 09:50:39 +0000
@@ -8,6 +8,8 @@
 import com.freewinesearcher.common.Knownwines;
 import com.freewinesearcher.common.Dbutil;
 import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
 
 public final class header_jsp extends org.apache.jasper.runtime.HttpJspBase
     implements org.apache.jasper.runtime.JspSourceDependent {
@@ -53,10 +55,6 @@
       out.write('\r');
       out.write('\n');
  
-response.setHeader("Cache-Control","no-cache"); //HTTP 1.1
-response.setHeader("Pragma","no-cache"); //HTTP 1.0
-response.setDateHeader ("Expires", 0); //prevents caching at the proxy server
-
 
 //if (request.getServerName().toLowerCase().contains("searchasaservice")&&!request.getServletPath().toLowerCase().contains("searchasaservice")) {
 	//	response.sendRedirect("/searchasaservice.jsp");
@@ -71,6 +69,11 @@
 	} else {
 		querystring="?"+querystring;
 	}
+	if (originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/wine-guide/")||originalurl.contains("/region/")){
+		response.setHeader("Cache-Control","max-age=3600");} //HTTP 1.1
+		//response.setHeader("Pragma","no-cache"); //HTTP 1.0
+		response.setDateHeader ("Expires", 0); //prevents caching at the proxy server
+
 	if (PageHandler.getInstance(request,response).abuse){
 		response.setStatus(403);
 		
@@ -89,19 +92,37 @@
 		response.setStatus(301);
 		response.setHeader( "Location", newurl);
 		response.setHeader( "Connection", "close" );
-		return;
-	}
-	if (originalurl.contains("/wine/")&&((!Webroutines.getRegexPatternValue("(\\d\\d\\d\\d)$",originalurl).equals("")&&!querystring.contains("vintage"))||originalurl.contains("%20")||!Webroutines.removeAccents(request.getParameter("name")).equals(request.getParameter("name")))){
+		return; 
+	}
+	if (originalurl.contains("https://")&&request.getRemoteUser()==null&&(originalurl.contains("/wine/")||originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/region/"))){
+		String newurl=originalurl.replace("https://","http://");
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	//(!Webroutines.getRegexPatternValue("([^%_-]\\d\\d\\d\\d)$",originalurl).equals("")&&!querystring.contains("vintage"))
+	if (originalurl.contains("/wine/")&&(originalurl.contains("%20")||!Webroutines.removeAccents(request.getParameter("name")).equals(request.getParameter("name")))){
 		String originalvintage=Webroutines.getRegexPatternValue("(?:%20| |\\+)(\\d\\d\\d\\d)$",originalurl);
 		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
 		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")))+(querystring.length()>1?querystring:"");
-		if (originalvintage.length()>0) redurl=redurl.replaceAll("\\+"+originalvintage,"")+(querystring.length()>0?"&":"?")+"vintage="+originalvintage;
-		response.setStatus(301);
-		response.setHeader( "Location", redurl);
-		response.setHeader( "Connection", "close" );
-		return;
-	}
-	
+		if (originalvintage.length()>0) redurl=redurl.replaceAll("\\+"+originalvintage,"")+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	if (originalurl.contains("/wine/")&&querystring.startsWith("?vintage")&&querystring.length()==13){
+		String originalvintage=Webroutines.getRegexPatternValue("(\\d\\d\\d\\d)$",querystring);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")));
+		if (originalvintage.length()>0) redurl=redurl+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	 
 
 	if (request.getParameter("logoff") != null) {
     response.sendRedirect("/logout.jsp");
@@ -126,9 +147,9 @@
       out.write("\r\n");
       out.write("\r\n");
       out.write("\r\n");
-      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"/css/");
+      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"");
       out.print(Configuration.stylesheet );
-      out.write("\" />\r\n");
+      out.write("\" />  \r\n");
 } else {
       out.write("\r\n");
       out.write("<link rel=\"stylesheet\" type=\"text/css\" media=\"print\" href=\"/print.css\" />\r\n");
@@ -137,7 +158,7 @@
       out.write("\r\n");
       out.write("<!-- google_ad_section_end -->\r\n");
       out.write("<meta http-equiv=\"Content-Type\" content=\"text/html;charset=ISO-8859-1\" />\r\n");
- if (originalurl.contains("/index.jsp")&&!originalurl.contains("wine-guide")&&!originalurl.contains("/store/")){ 
+ if ((originalurl.contains("/index.jsp")&&!originalurl.contains("wine-guide")&&!originalurl.contains("/store/")||originalurl.contains("/external.jsp")||originalurl.contains("/winelinks.jsp"))){ 
 
       out.write("<meta name=\"robots\" content=\"noindex,nofollow\" />\r\n");
  } else if (originalurl.contains("/wine2")){
@@ -151,8 +172,12 @@
       out.write("<meta name=\"robots\" content=\"index,follow\" />\r\n");
  } 
       out.write("\r\n");
-      out.write("<link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\" />\r\n");
-      out.write("<script type=\"text/javascript\" src=\"/js/combinedjs.js?version=3\"></script>\r\n");
+      out.write("<link rel=\"icon\" type=\"image/png\" href=\"");
+      out.print(Configuration.staticprefix );
+      out.write("/favicon.png\" /> \r\n");
+      out.write("<script type=\"text/javascript\" src=\"");
+      out.print(Configuration.staticprefix);
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
       out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
       out.write('\r');
       out.write('\n');
@@ -162,7 +187,9 @@
       out.write('\n');
       out.write('\r');
       out.write('\n');
-      out.write("<script type=\"text/javascript\" src=\"/js/combinedjs.js?version=3\"></script>\r\n");
+      out.write("<script type=\"text/javascript\" src=\"");
+      out.print(Configuration.staticprefix);
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
       out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
       out.write('\r');
       out.write('\n');

=== modified file 'work/org/apache/jsp/heatmap_jsp.java'
--- work/org/apache/jsp/heatmap_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/heatmap_jsp.java	2010-09-21 10:47:49 +0000
@@ -222,7 +222,7 @@
       out.write("/favicon.png\" /> \r\n");
       out.write("<script type=\"text/javascript\" src=\"");
       out.print(Configuration.staticprefix);
-      out.write("/js/combinedjs.js?version=13\"></script>\r\n");
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
       out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
       out.write('\r');
       out.write('\n');

=== modified file 'work/org/apache/jsp/index_jsp.java'
--- work/org/apache/jsp/index_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/index_jsp.java	2010-09-22 16:18:10 +0000
@@ -204,6 +204,7 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {
@@ -404,16 +405,15 @@
       out.write("\t\t<div class='explanation'>Enter a wine, store, region or producer name and search in ");
       out.print(Dbutil.readIntValueFromDB("Select count(*) as thecount from wines","thecount"));
       out.write(" wine offers, or try our <a style='text-decoration:underline;' href='/wine-guide/'>wine guide</a>.</div>\r\n");
-      out.write("\t\t<input type='image' class='searchgo' src='");
-      out.print(Configuration.cdnprefix);
-      out.write("/css2/searchgo.png' onclick='document.getElementById(\"searchform\").submit()' alt='Search'/>\r\n");
+      out.write("\t\t<input type='image' class='sprite sprite-searchgo searchgo' src='/images/transparent.gif' onclick='document.getElementById(\"searchform\").submit()' alt='Search'/>\r\n");
       out.write("</div>\r\n");
       out.write("</div>\r\n");
       out.write("\r\n");
       out.write("\r\n");
       out.write("\t\t<div class='textpage'>\r\n");
+      out.write("\t\t<div style='border:3px dashed #4d0027;padding:10px;padding-top:0px;'><h2><font style='color:black;font-size:22px;' face='times, times new roman'>Breaking news! FINANCIAL TIMES: </font></h2><img src='/images/Jancis_Robinson.jpg' alt='Jancis Robinson' style='float:left;padding-right:10px;'/><h2>&#8220;Perhaps the most attractive, user-friendly competitor is Vinopedia.com&#8221;</h2>Jancis Robinson, in an article on Wine Search Engines in the <a href='http://www.ft.com/cms/s/2/121122dc-c1ea-11df-9d90-00144feab49a.html' target='_blank'>Financial Times</a>. Thank you, Jancis, this is the stuff that keeps us going!<br/>\"Perhaps the most attractive, user-friendly competitor is Vinopedia.com, set up by Dutch wine lovers Jeroen Starrenburg and Jasper Hammink, who quit their jobs in IT to build a site that locates prices and stockists of 1.6m different wines (the current tally) but also incorporates individual wine ratings (from American wine magazine Wine Spectator). One particularly useful feature is that they identify wines whose prices have dropped most significantly recently and showcase them on their home page.\" Read the full artice in the <a href='http://www.ft.com/cms/s/2/121122dc-c1ea-11df-9d90-00144feab49a.html' target='_blank'>Financial Times</a> or the <a href='http://www.jancisrobinson.com/articles/a201009173.html' target='_blank'>Purple pages</a>.</div>\r\n");
       out.write("\t\t<h1>Compare online wine prices with vino<font color='black'>pedia</font></h1>\r\n");
-      out.write("\t\tVinopedia.com is a wine search engine that helps you to buy wine online. We compare the price lists of wine stores throughout the US, Canada and Europe, show you who is selling your favorite wine and who is the cheapest in the market. Just type (part) of a wine name in the search box to see how it works.<br/>We also give you background information of each wine, such as ratings, and you can use our <a href='/wine-guide/'>wine buying guide</a> to discover the best wines from a region or a grape variety, based on price and quality.<br/><br/>\r\n");
+      out.write("\t\t<br/>Vinopedia.com is a wine search engine that helps you to buy wine online. We compare the price lists of wine stores world wide, show you who is selling your favorite wine and who is the cheapest in the market. Just type (part) of a wine name in the search box to see how it works.<br/>We also give you background information of each wine, such as ratings, and you can use our <a href='/wine-guide/'>wine buying guide</a> to discover the best wines from a region or a grape variety, based on price and quality.<br/><br/>\r\n");
       out.write("\t\t");
       out.print(Webroutines.getConfigKey("systemmessage"));
       out.write("\r\n");

=== modified file 'work/org/apache/jsp/moderator/analyzer_jsp.class'
Binary files work/org/apache/jsp/moderator/analyzer_jsp.class	2010-04-14 09:15:26 +0000 and work/org/apache/jsp/moderator/analyzer_jsp.class	2010-09-29 10:08:24 +0000 differ
=== modified file 'work/org/apache/jsp/moderator/analyzer_jsp.java'
--- work/org/apache/jsp/moderator/analyzer_jsp.java	2010-02-14 15:11:41 +0000
+++ work/org/apache/jsp/moderator/analyzer_jsp.java	2010-09-28 10:10:44 +0000
@@ -26,18 +26,22 @@
 import com.searchasaservice.parser.xpathparser.XpathParser;
 import com.searchasaservice.parser.xpathparser.XpathParserConfig;
 import com.searchasaservice.parser.xpathparser.Analyzer;
-import com.searchasaservice.parser.HTMLParser;
+import com.searchasaservice.parser.LoboParser;
 import com.freewinesearcher.online.Webroutines;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.common.Knownwines;
 import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
 import com.freewinesearcher.online.Ad;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Configuration;
 import java.util.HashSet;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.online.Webroutines;
 import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.common.Configuration;
 
 public final class analyzer_jsp extends org.apache.jasper.runtime.HttpJspBase
     implements org.apache.jasper.runtime.JspSourceDependent {
@@ -91,8 +95,9 @@
       out.write('\n');
       out.write('\r');
       out.write('\n');
+ 
 
-	//if (request.getServerName().toLowerCase().contains("searchasaservice")&&!request.getServletPath().toLowerCase().contains("searchasaservice")) {
+//if (request.getServerName().toLowerCase().contains("searchasaservice")&&!request.getServletPath().toLowerCase().contains("searchasaservice")) {
 	//	response.sendRedirect("/searchasaservice.jsp");
 	//	return;
 	//}
@@ -100,19 +105,22 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {
 		querystring="?"+querystring;
 	}
-	
+	if (originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/wine-guide/")||originalurl.contains("/region/")){
+		response.setHeader("Cache-Control","max-age=3600");} //HTTP 1.1
+		//response.setHeader("Pragma","no-cache"); //HTTP 1.0
+		response.setDateHeader ("Expires", 0); //prevents caching at the proxy server
 
-	if (request.getParameter("logoff") != null) {
-    response.sendRedirect("/logout.jsp");
-    return;
-  }
 	if (PageHandler.getInstance(request,response).abuse){
+		response.setStatus(403);
 		
+      out.write('\r');
+      out.write('\n');
       if (true) {
         _jspx_page_context.forward("abuse.jsp");
         return;
@@ -120,10 +128,49 @@
 
 		return;
 	}
-	if (PageHandler.getInstance(request,response).block){
-		out.print("An error occurred at line: 17 in the jsp file: /index.jsp");
-		return;
-	}
+	if (originalurl.contains("/region/")&&(originalurl.contains(" ")||originalurl.contains("%20")||!originalurl.endsWith("/"))){
+		String newurl=originalurl.replaceAll(" ","+").replaceAll("%20","+");
+		if (!newurl.endsWith("/")) newurl+="/";
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	if (originalurl.contains("https://")&&request.getRemoteUser()==null&&(originalurl.contains("/wine/")||originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/region/"))){
+		String newurl=originalurl.replace("https://","http://");
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	//(!Webroutines.getRegexPatternValue("([^%_-]\\d\\d\\d\\d)$",originalurl).equals("")&&!querystring.contains("vintage"))
+	if (originalurl.contains("/wine/")&&(originalurl.contains("%20")||!Webroutines.removeAccents(request.getParameter("name")).equals(request.getParameter("name")))){
+		String originalvintage=Webroutines.getRegexPatternValue("(?:%20| |\\+)(\\d\\d\\d\\d)$",originalurl);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")))+(querystring.length()>1?querystring:"");
+		if (originalvintage.length()>0) redurl=redurl.replaceAll("\\+"+originalvintage,"")+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	if (originalurl.contains("/wine/")&&querystring.startsWith("?vintage")&&querystring.length()==13){
+		String originalvintage=Webroutines.getRegexPatternValue("(\\d\\d\\d\\d)$",querystring);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")));
+		if (originalvintage.length()>0) redurl=redurl+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	 
+
+	if (request.getParameter("logoff") != null) {
+    response.sendRedirect("/logout.jsp");
+    return;
+  }
+
 	if (originalurl.contains("freewinesearcher")&&!originalurl.contains("wine2/")){
 		String newurl=originalurl.replace("freewinesearcher","vinopedia")+querystring;
 		session.setAttribute("fws","true");
@@ -137,41 +184,14 @@
 
       out.write("\r\n");
       out.write("<!-- google_ad_section_start -->\r\n");
-
-	String headerwinename="";
-	if (PageHandler.getInstance(request,response).s!=null&&PageHandler.getInstance(request,response).s.wineset!=null) headerwinename=Webroutines.escape(PageHandler.getInstance(request,response).s.wineset.knownwineid>0?Knownwines.getKnownWineName(PageHandler.getInstance(request,response).s.wineset.knownwineid):PageHandler.getInstance(request,response).searchdata.getName()).replaceAll("^\\d\\d\\d\\d\\d\\d ", "");
-	if (!PageHandler.getInstance(request,response).searchdata.getName().equals("")) {
-		out.print("<meta name=\"keywords\" content=\"");
-		for (int i=0;i<headerwinename.split("\\s+").length;i++){
-			out.print(headerwinename.split("\\s+")[i]+", ");
-		}
-		out.print("buy "+headerwinename+", wine ratings, buy wine online, price, compare prices\" />");
-	} else {
-		out.print("<meta name=\"keywords\" content=\"wine, search, wines, searcher, free wine searcher, wine searcher,port, compare, wine comparison, buy, buying, shopping, shop, precio, price, prices, prijs, prijzen, preis, prix, free, crawler, Bordeaux, Bourgogne, Burgundy, Grand Cru, Premier Cru, primeur, chateau, wijn vergelijken, wijn, wijn prijs, zoeken, zoeker, kopen, vente, achat, acheter, vin, acheter du vin, Wein, kaufen, suchen, vino, buscar\" />");
-	}
-if ("NL".equals(PageHandler.getInstance(request,response).searchdata.getLanguage())){
-	if (!headerwinename.equals("")&&PageHandler.getInstance(request,response).s!=null) {
-		out.write("<meta name=\"description\" content=\""+PageHandler.getInstance(request,response).t.get("pricecomparisonfor")+" "+headerwinename+" ("+PageHandler.getInstance(request,response).s.wineset.records+" aanbiedingen gevonden)\" />");
-	} else {
-		out.write("<meta name=\"description\" content=\"De meest complete gratis prijsvergelijkingssite van wijnen in Europa.\" />");
-	}
-
- } else {if (!headerwinename.equals("")&&PageHandler.getInstance(request,response).s!=null) { 
-		out.print("<meta name=\"description\" content=\""+PageHandler.getInstance(request,response).t.get("pricecomparisonfor")+" "+headerwinename+" ("+PageHandler.getInstance(request,response).s.wineset.records+" wine prices found)\" />");
-	} else {
-		out.print("<meta name=\"description\" content=\"Vinopedia is a free price comparison engine for millions of wines world wide. Find your favorite wine for the best price.\" />");
-	} 
-	
- }
-	
-
-      out.write('\r');
-      out.write('\n');
+      out.write("\r\n");
 	if (!"Y".equals(Webroutines.filterUserInput(request.getParameter("print")))){
       out.write("\r\n");
       out.write("\r\n");
       out.write("\r\n");
-      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"/css/stylesheet2.css?version=18\" />\r\n");
+      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"");
+      out.print(Configuration.stylesheet );
+      out.write("\" />  \r\n");
 } else {
       out.write("\r\n");
       out.write("<link rel=\"stylesheet\" type=\"text/css\" media=\"print\" href=\"/print.css\" />\r\n");
@@ -180,18 +200,13 @@
       out.write("\r\n");
       out.write("<!-- google_ad_section_end -->\r\n");
       out.write("<meta http-equiv=\"Content-Type\" content=\"text/html;charset=ISO-8859-1\" />\r\n");
- if (originalurl.contains("/index.jsp")&&!originalurl.contains("wine-guide")){ 
+ if ((originalurl.contains("/index.jsp")&&!originalurl.contains("wine-guide")&&!originalurl.contains("/store/")||originalurl.contains("/external.jsp")||originalurl.contains("/winelinks.jsp"))){ 
 
       out.write("<meta name=\"robots\" content=\"noindex,nofollow\" />\r\n");
- } else if (originalurl.contains("/wine")&&!originalurl.contains("wine-guide")) {
-		if (!originalurl.contains("lang-EN")&&!originalurl.contains("lang-FR")&&!originalurl.contains("/wine2")&&originalurl.replaceAll("\\d\\d\\d\\d\\d\\d","").equals(originalurl.replaceAll("\\d\\d\\d\\d\\d\\d","").replaceAll("\\d\\d\\d\\d",""))){
-		
-      out.write("<meta name=\"robots\" content=\"index,follow\" />\r\n");
- 		} else {
+ } else if (originalurl.contains("/wine2")){
 		
       out.write("<meta name=\"robots\" content=\"noindex,nofollow\" />\r\n");
-		}
-   	} else if (originalurl.contains("topwines")) {
+	} else if (originalurl.contains("topwines")) {
 
       out.write("<meta name=\"robots\" content=\"noindex,follow\" />\r\n");
 	} else {	
@@ -199,8 +214,12 @@
       out.write("<meta name=\"robots\" content=\"index,follow\" />\r\n");
  } 
       out.write("\r\n");
-      out.write("<link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\" />\r\n");
-      out.write("<script type=\"text/javascript\" src=\"/js/combinedjs.js?version=2\"></script>\r\n");
+      out.write("<link rel=\"icon\" type=\"image/png\" href=\"");
+      out.print(Configuration.staticprefix );
+      out.write("/favicon.png\" /> \r\n");
+      out.write("<script type=\"text/javascript\" src=\"");
+      out.print(Configuration.staticprefix);
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
       out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
       out.write('\r');
       out.write('\n');
@@ -227,30 +246,36 @@
       out.write('\n');
  //PageHandler p=(PageHandler)request.getAttribute("pagehandler");
       out.write("\r\n");
-      out.write("<div class='topbar'>\r\n");
-      out.write("<div class='topbarcontent'>\r\n");
-      out.write("<div id='mobile'><a href='");
+      out.write(" \r\n");
+      out.write("<div class='topbar spriter spriter-refine'>\r\n");
+      out.write("<div class='topbarcontent'><img src='");
+      out.print(Configuration.staticprefix );
+      out.write("/css/sprite.png' style='display:none;width:1px;height:1px' alt=''/><img src='");
+      out.print(Configuration.cdnprefix );
+      out.write("/css/spriter.png' style='display:none;width:1px;height:1px' alt=''/>\r\n");
+      out.write("<div id='mobile'><a rel='nofollow' href='/nf");
       out.print((PageHandler.getInstance(request,response).s!=null&&PageHandler.getInstance(request,response).s.wineset.knownwineid>0)?"/mwine/":"/m"+(PageHandler.getInstance(request,response).searchdata.getName().length()>2?"?name=":""));
-      out.print((PageHandler.getInstance(request,response).searchdata.getName().length()>2?Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName())+" "+PageHandler.getInstance(request,response).searchdata.getVintage():"").trim());
-      out.write("'>Mobile access</a><a href='/settings/index.jsp'>PriceAlerts</a><a href='/retailers.jsp'>Getting listed</a><a href='/support.jsp'>Support us</a><a href='/links.jsp'>Links</a><a href='/publishers.jsp'>For web site owners</a>");
+      out.print((PageHandler.getInstance(request,response).searchdata.getName().length()>2?Webroutines.URLEncode(Webroutines.removeAccents(PageHandler.getInstance(request,response).searchdata.getName()))+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage="+PageHandler.getInstance(request,response).searchdata.getVintage():"").trim():""));
+      out.write("'>Mobile access</a><a href='/nf/wine-guide/' rel='nofollow'>Wine Guide</a><a href='/settings/index.jsp' rel='nofollow'>PriceAlerts</a><a href='/retailers.jsp' rel='nofollow'>Getting listed</a><a href='/about.jsp' rel='nofollow'>About us</a><a href='/links.jsp' rel='nofollow'>Links</a><a href='/publishers.jsp' rel='nofollow'>For web site owners</a>");
 if (request.getRemoteUser()!=null) {
       out.write("<a href='/settings/index.jsp?logoff=true'>Log off</a>");
 } 
       out.write("</div>\r\n");
+      out.write("<!-- \r\n");
       out.write("<div id='language'>");
       out.print(PageHandler.getInstance(request,response).t.get("language"));
-      out.write(": <a href='/lang-EN/wine/");
-      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'",
-							"&apos;")
-							+ " " + PageHandler.getInstance(request,response).searchdata.getVintage()));
-      out.write("'><img src=\"/images/flags/english.gif\" alt=\"English\" /></a>&nbsp;<a href='/lang-FR/wine/");
-      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'",
-							"&apos;")) + " " + PageHandler.getInstance(request,response).searchdata.getVintage());
-      out.write("'><img src=\"/images/flags/french.gif\" alt=\"Français\" /></a>&nbsp;<a href='/lang-NL/wine/");
-      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'",
-							"&apos;")
-							+ " " + PageHandler.getInstance(request,response).searchdata.getVintage()));
-      out.write("'><img src=\"/images/flags/dutch.gif\" alt=\"Nederlands\" /></a></div>\r\n");
+      out.write(": \r\n");
+      out.write("<a href='/lang-EN/wine/");
+      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'","&apos;")+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage=" + PageHandler.getInstance(request,response).searchdata.getVintage():"")));
+      out.write("'><img alt='English' src='/images/transparent.gif' class='sprite sprite-language sprite-english'/></a>\r\n");
+      out.write("<a href='/lang-FR/wine/");
+      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'","&apos;")+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage=" + PageHandler.getInstance(request,response).searchdata.getVintage():"")));
+      out.write("'><img alt='Français' src='/images/transparent.gif' class='sprite sprite-language sprite-french'/></a>\r\n");
+      out.write("<a href='/lang-NL/wine/");
+      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'","&apos;")+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage=" + PageHandler.getInstance(request,response).searchdata.getVintage():"")));
+      out.write("'><img alt='Nederlands' src='/images/transparent.gif' class='sprite sprite-language sprite-dutch'/></a>\r\n");
+      out.write("</div>\r\n");
+      out.write(" -->\r\n");
       out.write("&nbsp;\r\n");
       out.write("</div>\r\n");
       out.write("</div>");
@@ -260,20 +285,22 @@
       out.write("\r\n");
       out.write("\r\n");
       out.write("<div class='logoandsearch' id='logoandsearch'>\r\n");
-      out.write("\t\t<div class='logo'><a href=\"/\"><img src='/css2/logo.png' alt='Home page'/></a></div>\r\n");
+      out.write("\t\t<div class='logo'><a href=\"/\"><img src='");
+      out.print(Configuration.cdnprefix);
+      out.write("/css2/logo.png' alt='Home page'/></a></div>\r\n");
       out.write("\t\t<div class='search'>\r\n");
       out.write("\t\t<div class='findwine'>");
       out.print(PageHandler.getInstance(request,response).t.get("searchwine"));
       out.write("</div>\r\n");
       out.write("\t\t\t");
-// <img class='searchgosmall' src='/css2/gosmall.jpg' onclick='document.getElementById("searchform").submit()' alt='Search'/>
+// <img class='searchgosmall' alt='Search' src='/css2/gosmall.jpg' onclick='document.getElementById("searchform").submit()' />
       out.write("\r\n");
       out.write("\t\t\t<form action='");
       out.print(PageHandler.getInstance(request,response).searchpage);
-      out.write("' method=\"post\" id=\"searchform\" name=\"searchform\"><input type=\"hidden\" name=\"dosearch\" value=\"true\" /><input class='searchinput' id='name' type='text' autocomplete=\"off\" name=\"name\" value=\"");
+      out.write("' method=\"post\" id=\"searchform\" name=\"searchform\"><input type=\"hidden\" name=\"dosearch\" value=\"true\" /><input class='searchinput' id='name' type='text' name=\"name\" value=\"");
       out.print(Webroutines.escape((PageHandler.getInstance(request,response).searchdata.getName()+" "+PageHandler.getInstance(request,response).searchdata.getVintage()).trim()));
       out.write("\" size=\"25\" /></form>\r\n");
-      out.write("\t\t\t<div class='sprite sprite-gosmall searchgosmall' onclick='document.getElementById(\"searchform\").submit()' alt='Search'></div>\r\n");
+      out.write("\t\t\t<div class='sprite sprite-gosmall searchgosmall' onclick='document.getElementById(\"searchform\").submit()' ></div>\r\n");
       out.write("\t\t</div>\r\n");
       out.write("</div>\r\n");
       out.write('\r');
@@ -311,9 +338,13 @@
       out.write("<div id=\"dark\"></div>\r\n");
       org.apache.jasper.runtime.JspRuntimeLibrary.include(request, response, "moderatorlinks.jsp", out, false);
       out.write("\r\n");
-      out.write("<script type=\"text/javascript\" src=\"/js/Dojo/dojo/dojo.js\"\r\n");
-      out.write("\tdjconfig=\"parseOnLoad: true\">\r\n");
+      out.write("<script type=\"text/javascript\" src=\"http://www.google.com/jsapi?key=");
+      out.print(Configuration.GoogleApiKey);
+      out.write("\"></script>\r\n");
+      out.write("<script type=\"text/javascript\">\r\n");
+      out.write("google.load(\"dojo\", \"1.5\");\r\n");
       out.write("</script>\r\n");
+      out.write("\r\n");
       out.write("<script type=\"text/javascript\" src=\"scraper.js\">\r\n");
       out.write("</script>\r\n");
       out.write("<script type=\"text/javascript\">\r\n");
@@ -367,7 +398,10 @@
 	if (actie != null && actie.equals("retrieve")) {
 		if (shopid>0){
 		an = Analyzer.getAnalyzer(c,shopid,row);
-		if (url.equals("")) url=Webroutines.getMostCommonUrl(shopid,auto);
+		if (url.equals("")) {
+			url=Webroutines.getMostCommonUrl(shopid,auto);
+			postdata=Webroutines.getMostCommonPostdata(shopid,auto);
+		}
 		URL u=null;
 		try{
 			u=new URL(url);
@@ -376,6 +410,8 @@
 			message+="Invalid url, please correct it.<br/>";
 		} else {
 		if (an!=null&&!"".equals(url)) {
+			an.url=url;
+			an.postdata=postdata;
 			
       out.write("\r\n");
       out.write("\t\t\t<script type=\"text/javascript\">\r\n");
@@ -384,7 +420,7 @@
       out.write("\t\t\t</script>");
 
 			c.an=an;
-			c.an.document=new HTMLParser(HTMLParser.getPage(url)).document;
+			c.an.document=new LoboParser(url).document;
 			c.an.originaldocument=c.an.document;
 			c.an.tagDocument(c.an.document);
 			c.an.document=c.an.taggeddocument;
@@ -482,7 +518,7 @@
       out.write("<input type=\"button\" name=\"submitButton\" value=\"New Analyzer\" onClick=\"javascript:submitForm('analyze',document.formOne)\">\r\n");
       out.write("<input type=\"button\" name=\"submitButton\" value=\"Edit existing Analyzer\" onClick=\"javascript:submitForm('retrieve',document.formOne)\">\r\n");
       out.write("</form>\r\n");
-      out.write("<a href='analyzer.jsp?actie=analyze&amp;url=http://localhost.vinopedia.com:6001/testshop.jsp'>Analyze testshop</a>\r\n");
+      out.write("<a href='analyzer.jsp?actie=analyze&amp;url=https://test.vinopedia.com/testshop.jsp'>Analyze testshop</a>\r\n");
  
 if (actie!=null&&actie.equals("retrieve")&&shopid>0&&an==null){
 	if (shopid>0){
@@ -503,6 +539,7 @@
 			an=null;
 			an=new Analyzer(xppc);
 			an.setUrl(url);
+			an.setPostdata(postdata);
 			an.shopid=shopid;
 		} catch (Exception e){
 			message+="Could not create a parser: "+e.getMessage();

=== modified file 'work/org/apache/jsp/moderator/index_jsp.class'
Binary files work/org/apache/jsp/moderator/index_jsp.class	2010-09-21 09:04:18 +0000 and work/org/apache/jsp/moderator/index_jsp.class	2010-09-29 10:08:24 +0000 differ
=== modified file 'work/org/apache/jsp/moderator/index_jsp.java'
--- work/org/apache/jsp/moderator/index_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/moderator/index_jsp.java	2010-09-27 15:02:14 +0000
@@ -82,6 +82,7 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {

=== modified file 'work/org/apache/jsp/moderator/scraper_jsp.class'
Binary files work/org/apache/jsp/moderator/scraper_jsp.class	2009-09-29 10:20:01 +0000 and work/org/apache/jsp/moderator/scraper_jsp.class	2010-09-29 10:08:23 +0000 differ
=== modified file 'work/org/apache/jsp/moderator/scraper_jsp.java'
--- work/org/apache/jsp/moderator/scraper_jsp.java	2009-08-01 13:25:27 +0000
+++ work/org/apache/jsp/moderator/scraper_jsp.java	2010-09-28 10:13:52 +0000
@@ -15,6 +15,7 @@
 import com.freewinesearcher.common.Wineset;
 import com.freewinesearcher.common.Context;
 import com.freewinesearcher.common.Webpage;
+import com.freewinesearcher.common.Configuration;
 import com.freewinesearcher.batch.Spider;
 import com.freewinesearcher.online.Webroutines;
 import com.freewinesearcher.batch.TableScraper;
@@ -49,7 +50,7 @@
 
     try {
       _jspxFactory = JspFactory.getDefaultFactory();
-      response.setContentType("text/html");
+      response.setContentType("text/html; charset=UTF-8");
       pageContext = _jspxFactory.getPageContext(this, request, response,
       			null, true, 8192, true);
       _jspx_page_context = pageContext;
@@ -73,14 +74,23 @@
 
       out.write("\r\n");
       out.write("<html><head>\r\n");
+      out.write("\r\n");
+      out.write("<script type=\"text/javascript\" src=\"http://www.google.com/jsapi?key=");
+      out.print(Configuration.GoogleApiKey);
+      out.write("\"></script>\r\n");
+      out.write("<script type=\"text/javascript\">\r\n");
+      out.write("google.load(\"dojo\", \"1.5\");\r\n");
+      out.write("google.load(\"jquery\", \"1.4.2\");\r\n");
+      out.write("google.load(\"jqueryui\", \"1.8.5\");\r\n");
+      out.write("</script>\r\n");
+      out.write("\r\n");
  out.write(XpathParser.getNodeAsXML(c.an.getNodeFromxpath("//head")));
       out.write("\r\n");
-      out.write("<script type=\"text/javascript\" src=\"/js/Dojo/dojo/dojo.js\"\r\n");
-      out.write("\tdjconfig=\"parseOnLoad: true\">\r\n");
-      out.write("</script>\r\n");
+      out.write("\r\n");
       out.write("<script type=\"text/javascript\" src=\"scraper.js\">\r\n");
       out.write("</script>\r\n");
       out.write("<body>\r\n");
+      out.write("<div id=\"dark\"></div>\r\n");
       out.write("<div class=\"moveable\" id='analysisplaceholder' style='background-color:#ffffff;text-align:left;position:fixed;top:200px;right:50px;width:250px;z-index:9;border-style:solid;border-width:2px;'>\r\n");
       out.write("<div id=\"handle\" style='background-color:blue;color:white;font-family: Arial,sans-serif;font-size: 13px;' onmouseover='this.style.cursor=\"move\"'>\r\n");
       out.write("Analysis (click to drag)</div>\r\n");
@@ -92,7 +102,7 @@
       out.write("\r\n");
       out.write("</table><table>\r\n");
       out.write("<tr><td onclick='javascript:savexp();' onmouseover=\"document.body.style.cursor='pointer'\" onmouseout=\"document.body.style.cursor='default'\" style=\"color:blue;text-decoration:underline\"><div class='fwseditfield' id='fwssave'>Save configuration</div></td></tr>\r\n");
-      out.write("<tr><td><a href='showwines.jsp' target=\"_blank\"> Show result</a></td></tr>\r\n");
+      out.write("\r\n");
       out.write("</table>\r\n");
       out.write("</div>\r\n");
       out.write("</div>\t\r\n");

=== modified file 'work/org/apache/jsp/moderator/showwines_jsp.class'
Binary files work/org/apache/jsp/moderator/showwines_jsp.class	2010-09-21 09:04:18 +0000 and work/org/apache/jsp/moderator/showwines_jsp.class	2010-09-29 10:08:23 +0000 differ
=== modified file 'work/org/apache/jsp/moderator/showwines_jsp.java'
--- work/org/apache/jsp/moderator/showwines_jsp.java	2010-02-14 15:11:41 +0000
+++ work/org/apache/jsp/moderator/showwines_jsp.java	2010-09-27 15:08:04 +0000
@@ -22,24 +22,33 @@
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.common.Knownwines;
 import com.freewinesearcher.common.Dbutil;
-import com.freewinesearcher.online.PageHandler;
-import com.freewinesearcher.online.Webroutines;
-import com.freewinesearcher.online.PageHandler;
-import com.freewinesearcher.online.Webroutines;
-import com.freewinesearcher.online.PageHandler;
-import com.freewinesearcher.online.Webroutines;
-import com.freewinesearcher.online.PageHandler;
-import com.freewinesearcher.online.Webroutines;
-import com.freewinesearcher.online.PageHandler;
-import com.freewinesearcher.online.Webroutines;
-import com.freewinesearcher.online.PageHandler;
-import com.freewinesearcher.common.Dbutil;
-import com.freewinesearcher.online.PageHandler;
-import com.freewinesearcher.online.Webroutines;
-import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.online.PageHandler;
+import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Dbutil;
+import com.freewinesearcher.common.Configuration;
 import java.util.ArrayList;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.online.Webroutines;
+import com.freewinesearcher.common.Configuration;
+import com.freewinesearcher.common.Configuration;
 import com.freewinesearcher.online.PageHandler;
 import com.freewinesearcher.common.Dbutil;
 
@@ -169,8 +178,9 @@
       out.write('\n');
       out.write('\r');
       out.write('\n');
+ 
 
-	//if (request.getServerName().toLowerCase().contains("searchasaservice")&&!request.getServletPath().toLowerCase().contains("searchasaservice")) {
+//if (request.getServerName().toLowerCase().contains("searchasaservice")&&!request.getServletPath().toLowerCase().contains("searchasaservice")) {
 	//	response.sendRedirect("/searchasaservice.jsp");
 	//	return;
 	//}
@@ -178,19 +188,22 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {
 		querystring="?"+querystring;
 	}
-	
+	if (originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/wine-guide/")||originalurl.contains("/region/")){
+		response.setHeader("Cache-Control","max-age=3600");} //HTTP 1.1
+		//response.setHeader("Pragma","no-cache"); //HTTP 1.0
+		response.setDateHeader ("Expires", 0); //prevents caching at the proxy server
 
-	if (request.getParameter("logoff") != null) {
-    response.sendRedirect("/logout.jsp");
-    return;
-  }
 	if (PageHandler.getInstance(request,response).abuse){
+		response.setStatus(403);
 		
+      out.write('\r');
+      out.write('\n');
       if (true) {
         _jspx_page_context.forward("abuse.jsp");
         return;
@@ -198,10 +211,49 @@
 
 		return;
 	}
-	if (PageHandler.getInstance(request,response).block){
-		out.print("An error occurred at line: 17 in the jsp file: /index.jsp");
-		return;
-	}
+	if (originalurl.contains("/region/")&&(originalurl.contains(" ")||originalurl.contains("%20")||!originalurl.endsWith("/"))){
+		String newurl=originalurl.replaceAll(" ","+").replaceAll("%20","+");
+		if (!newurl.endsWith("/")) newurl+="/";
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	if (originalurl.contains("https://")&&request.getRemoteUser()==null&&(originalurl.contains("/wine/")||originalurl.contains("/winery/")||originalurl.contains("/store/")||originalurl.contains("/region/"))){
+		String newurl=originalurl.replace("https://","http://");
+		response.setStatus(301);
+		response.setHeader( "Location", newurl);
+		response.setHeader( "Connection", "close" );
+		return; 
+	}
+	//(!Webroutines.getRegexPatternValue("([^%_-]\\d\\d\\d\\d)$",originalurl).equals("")&&!querystring.contains("vintage"))
+	if (originalurl.contains("/wine/")&&(originalurl.contains("%20")||!Webroutines.removeAccents(request.getParameter("name")).equals(request.getParameter("name")))){
+		String originalvintage=Webroutines.getRegexPatternValue("(?:%20| |\\+)(\\d\\d\\d\\d)$",originalurl);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")))+(querystring.length()>1?querystring:"");
+		if (originalvintage.length()>0) redurl=redurl.replaceAll("\\+"+originalvintage,"")+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	if (originalurl.contains("/wine/")&&querystring.startsWith("?vintage")&&querystring.length()==13){
+		String originalvintage=Webroutines.getRegexPatternValue("(\\d\\d\\d\\d)$",querystring);
+		if (request.getHeader("Referrer")!=null&&request.getHeader("Referrer").contains("vinopedia")) Dbutil.logger.info("URL "+originalurl+" found on "+request.getHeader("Referrer"));
+		String redurl="/wine/"+Webroutines.URLEncode(Webroutines.removeAccents(request.getParameter("name")));
+		if (originalvintage.length()>0) redurl=redurl+"+"+originalvintage;
+		response.setStatus(301);
+		response.setHeader( "Location", redurl);
+		response.setHeader( "Connection", "close" );
+		return;
+	}
+	 
+
+	if (request.getParameter("logoff") != null) {
+    response.sendRedirect("/logout.jsp");
+    return;
+  }
+
 	if (originalurl.contains("freewinesearcher")&&!originalurl.contains("wine2/")){
 		String newurl=originalurl.replace("freewinesearcher","vinopedia")+querystring;
 		session.setAttribute("fws","true");
@@ -215,41 +267,14 @@
 
       out.write("\r\n");
       out.write("<!-- google_ad_section_start -->\r\n");
-
-	String headerwinename="";
-	if (PageHandler.getInstance(request,response).s!=null&&PageHandler.getInstance(request,response).s.wineset!=null) headerwinename=Webroutines.escape(PageHandler.getInstance(request,response).s.wineset.knownwineid>0?Knownwines.getKnownWineName(PageHandler.getInstance(request,response).s.wineset.knownwineid):PageHandler.getInstance(request,response).searchdata.getName()).replaceAll("^\\d\\d\\d\\d\\d\\d ", "");
-	if (!PageHandler.getInstance(request,response).searchdata.getName().equals("")) {
-		out.print("<meta name=\"keywords\" content=\"");
-		for (int i=0;i<headerwinename.split("\\s+").length;i++){
-			out.print(headerwinename.split("\\s+")[i]+", ");
-		}
-		out.print("buy "+headerwinename+", wine ratings, buy wine online, price, compare prices\" />");
-	} else {
-		out.print("<meta name=\"keywords\" content=\"wine, search, wines, searcher, free wine searcher, wine searcher,port, compare, wine comparison, buy, buying, shopping, shop, precio, price, prices, prijs, prijzen, preis, prix, free, crawler, Bordeaux, Bourgogne, Burgundy, Grand Cru, Premier Cru, primeur, chateau, wijn vergelijken, wijn, wijn prijs, zoeken, zoeker, kopen, vente, achat, acheter, vin, acheter du vin, Wein, kaufen, suchen, vino, buscar\" />");
-	}
-if ("NL".equals(PageHandler.getInstance(request,response).searchdata.getLanguage())){
-	if (!headerwinename.equals("")&&PageHandler.getInstance(request,response).s!=null) {
-		out.write("<meta name=\"description\" content=\""+PageHandler.getInstance(request,response).t.get("pricecomparisonfor")+" "+headerwinename+" ("+PageHandler.getInstance(request,response).s.wineset.records+" aanbiedingen gevonden)\" />");
-	} else {
-		out.write("<meta name=\"description\" content=\"De meest complete gratis prijsvergelijkingssite van wijnen in Europa.\" />");
-	}
-
- } else {if (!headerwinename.equals("")&&PageHandler.getInstance(request,response).s!=null) { 
-		out.print("<meta name=\"description\" content=\""+PageHandler.getInstance(request,response).t.get("pricecomparisonfor")+" "+headerwinename+" ("+PageHandler.getInstance(request,response).s.wineset.records+" wine prices found)\" />");
-	} else {
-		out.print("<meta name=\"description\" content=\"Vinopedia is a free price comparison engine for millions of wines world wide. Find your favorite wine for the best price.\" />");
-	} 
-	
- }
-	
-
-      out.write('\r');
-      out.write('\n');
+      out.write("\r\n");
 	if (!"Y".equals(Webroutines.filterUserInput(request.getParameter("print")))){
       out.write("\r\n");
       out.write("\r\n");
       out.write("\r\n");
-      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"/css/stylesheet2.css?version=18\" />\r\n");
+      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"");
+      out.print(Configuration.stylesheet );
+      out.write("\" />  \r\n");
 } else {
       out.write("\r\n");
       out.write("<link rel=\"stylesheet\" type=\"text/css\" media=\"print\" href=\"/print.css\" />\r\n");
@@ -258,18 +283,13 @@
       out.write("\r\n");
       out.write("<!-- google_ad_section_end -->\r\n");
       out.write("<meta http-equiv=\"Content-Type\" content=\"text/html;charset=ISO-8859-1\" />\r\n");
- if (originalurl.contains("/index.jsp")&&!originalurl.contains("wine-guide")){ 
+ if ((originalurl.contains("/index.jsp")&&!originalurl.contains("wine-guide")&&!originalurl.contains("/store/")||originalurl.contains("/external.jsp")||originalurl.contains("/winelinks.jsp"))){ 
 
       out.write("<meta name=\"robots\" content=\"noindex,nofollow\" />\r\n");
- } else if (originalurl.contains("/wine")&&!originalurl.contains("wine-guide")) {
-		if (!originalurl.contains("lang-EN")&&!originalurl.contains("lang-FR")&&!originalurl.contains("/wine2")&&originalurl.replaceAll("\\d\\d\\d\\d\\d\\d","").equals(originalurl.replaceAll("\\d\\d\\d\\d\\d\\d","").replaceAll("\\d\\d\\d\\d",""))){
-		
-      out.write("<meta name=\"robots\" content=\"index,follow\" />\r\n");
- 		} else {
+ } else if (originalurl.contains("/wine2")){
 		
       out.write("<meta name=\"robots\" content=\"noindex,nofollow\" />\r\n");
-		}
-   	} else if (originalurl.contains("topwines")) {
+	} else if (originalurl.contains("topwines")) {
 
       out.write("<meta name=\"robots\" content=\"noindex,follow\" />\r\n");
 	} else {	
@@ -277,8 +297,12 @@
       out.write("<meta name=\"robots\" content=\"index,follow\" />\r\n");
  } 
       out.write("\r\n");
-      out.write("<link rel=\"icon\" type=\"image/png\" href=\"/favicon.png\" />\r\n");
-      out.write("<script type=\"text/javascript\" src=\"/js/combinedjs.js?version=2\"></script>\r\n");
+      out.write("<link rel=\"icon\" type=\"image/png\" href=\"");
+      out.print(Configuration.staticprefix );
+      out.write("/favicon.png\" /> \r\n");
+      out.write("<script type=\"text/javascript\" src=\"");
+      out.print(Configuration.staticprefix);
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
       out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
       out.write('\r');
       out.write('\n');
@@ -288,7 +312,9 @@
       out.write('\n');
       out.write('\r');
       out.write('\n');
-      out.write("<script type=\"text/javascript\" src=\"/js/combinedjs.js?version=2\"></script>\r\n");
+      out.write("<script type=\"text/javascript\" src=\"");
+      out.print(Configuration.staticprefix);
+      out.write("/js/combinedjs.js?version=14\"></script>\r\n");
       out.write("<script type=\"text/javascript\">function doonload(){document.getElementById('name').focus();}</script>\r\n");
       out.write("\r\n");
       out.write("</head>\r\n");
@@ -300,30 +326,36 @@
       out.write('\n');
  //PageHandler p=(PageHandler)request.getAttribute("pagehandler");
       out.write("\r\n");
-      out.write("<div class='topbar'>\r\n");
-      out.write("<div class='topbarcontent'>\r\n");
-      out.write("<div id='mobile'><a href='");
+      out.write(" \r\n");
+      out.write("<div class='topbar spriter spriter-refine'>\r\n");
+      out.write("<div class='topbarcontent'><img src='");
+      out.print(Configuration.staticprefix );
+      out.write("/css/sprite.png' style='display:none;width:1px;height:1px' alt=''/><img src='");
+      out.print(Configuration.cdnprefix );
+      out.write("/css/spriter.png' style='display:none;width:1px;height:1px' alt=''/>\r\n");
+      out.write("<div id='mobile'><a rel='nofollow' href='/nf");
       out.print((PageHandler.getInstance(request,response).s!=null&&PageHandler.getInstance(request,response).s.wineset.knownwineid>0)?"/mwine/":"/m"+(PageHandler.getInstance(request,response).searchdata.getName().length()>2?"?name=":""));
-      out.print((PageHandler.getInstance(request,response).searchdata.getName().length()>2?Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName())+" "+PageHandler.getInstance(request,response).searchdata.getVintage():"").trim());
-      out.write("'>Mobile access</a><a href='/settings/index.jsp'>PriceAlerts</a><a href='/retailers.jsp'>Getting listed</a><a href='/support.jsp'>Support us</a><a href='/links.jsp'>Links</a><a href='/publishers.jsp'>For web site owners</a>");
+      out.print((PageHandler.getInstance(request,response).searchdata.getName().length()>2?Webroutines.URLEncode(Webroutines.removeAccents(PageHandler.getInstance(request,response).searchdata.getName()))+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage="+PageHandler.getInstance(request,response).searchdata.getVintage():"").trim():""));
+      out.write("'>Mobile access</a><a href='/nf/wine-guide/' rel='nofollow'>Wine Guide</a><a href='/settings/index.jsp' rel='nofollow'>PriceAlerts</a><a href='/retailers.jsp' rel='nofollow'>Getting listed</a><a href='/about.jsp' rel='nofollow'>About us</a><a href='/links.jsp' rel='nofollow'>Links</a><a href='/publishers.jsp' rel='nofollow'>For web site owners</a>");
 if (request.getRemoteUser()!=null) {
       out.write("<a href='/settings/index.jsp?logoff=true'>Log off</a>");
 } 
       out.write("</div>\r\n");
+      out.write("<!-- \r\n");
       out.write("<div id='language'>");
       out.print(PageHandler.getInstance(request,response).t.get("language"));
-      out.write(": <a href='/lang-EN/wine/");
-      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'",
-							"&apos;")
-							+ " " + PageHandler.getInstance(request,response).searchdata.getVintage()));
-      out.write("'><img src=\"/images/flags/english.gif\" alt=\"English\" /></a>&nbsp;<a href='/lang-FR/wine/");
-      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'",
-							"&apos;")) + " " + PageHandler.getInstance(request,response).searchdata.getVintage());
-      out.write("'><img src=\"/images/flags/french.gif\" alt=\"Français\" /></a>&nbsp;<a href='/lang-NL/wine/");
-      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'",
-							"&apos;")
-							+ " " + PageHandler.getInstance(request,response).searchdata.getVintage()));
-      out.write("'><img src=\"/images/flags/dutch.gif\" alt=\"Nederlands\" /></a></div>\r\n");
+      out.write(": \r\n");
+      out.write("<a href='/lang-EN/wine/");
+      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'","&apos;")+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage=" + PageHandler.getInstance(request,response).searchdata.getVintage():"")));
+      out.write("'><img alt='English' src='/images/transparent.gif' class='sprite sprite-language sprite-english'/></a>\r\n");
+      out.write("<a href='/lang-FR/wine/");
+      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'","&apos;")+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage=" + PageHandler.getInstance(request,response).searchdata.getVintage():"")));
+      out.write("'><img alt='Français' src='/images/transparent.gif' class='sprite sprite-language sprite-french'/></a>\r\n");
+      out.write("<a href='/lang-NL/wine/");
+      out.print((Webroutines.URLEncode(PageHandler.getInstance(request,response).searchdata.getName()).replace("'","&apos;")+(PageHandler.getInstance(request,response).searchdata.getVintage().length()>3?"?vintage=" + PageHandler.getInstance(request,response).searchdata.getVintage():"")));
+      out.write("'><img alt='Nederlands' src='/images/transparent.gif' class='sprite sprite-language sprite-dutch'/></a>\r\n");
+      out.write("</div>\r\n");
+      out.write(" -->\r\n");
       out.write("&nbsp;\r\n");
       out.write("</div>\r\n");
       out.write("</div>");
@@ -347,10 +379,13 @@
       out.write("\t\t");
       out.write("\r\n");
       out.write("\r\n");
+      out.write("\r\n");
       out.write("<div class='container'>\r\n");
       out.write("\t");
 if (!request.getServerName().contains("searcher")&&(session.getAttribute("fws")==null||!((String)session.getAttribute("fws")).equals("true"))){ 
-      out.write("<div class='logo'><a href=\"/\"><img src='/css2/logo.png' alt='Home page'/></a>");
+      out.write("<div class='logo'><a href=\"/\"><img src='");
+      out.print(Configuration.cdnprefix);
+      out.write("/css2/logo.png' alt='Home page'/></a>");
 } else {session.removeAttribute("fws");	
       out.write("<div class='logofws'><a href=\"https://www.vinopedia.com\"><img src='/css/FWSisnowvinopedia.png' alt='To vinopedia'/></a>");
 } 
@@ -359,18 +394,16 @@
       out.write("</div>\r\n");
       out.write("<div class=\"bigsearchbackground\">\r\n");
       out.write("<div class=\"bigsearch\">\r\n");
-      out.write("\t\t<h1>Find your favorite wine for the best price</h1>\r\n");
+      out.write("\t\t<h1>The world's most powerful search engine for wine</h1>\r\n");
       out.write("\t\t<form action='");
       out.print(PageHandler.getInstance(request,response).searchpage);
-      out.write("' method=\"post\" id=\"searchform\" name=\"searchform\"><input type=\"hidden\" name=\"dosearch\" value=\"true\" /><input class='searchinput' id='name' type='text' autocomplete=\"off\" name=\"name\" value=\"");
+      out.write("' method=\"post\" id=\"searchform\" name=\"searchform\"><input type=\"hidden\" name=\"dosearch\" value=\"true\" /><input class='searchinput' id='name' type='text' name=\"name\" value=\"");
       out.print(Webroutines.escape(PageHandler.getInstance(request,response).searchdata.getName()));
       out.write("\" size=\"25\"  /></form>\r\n");
-      out.write("\t\t<div class='explanation'>Enter (part of) a wine name or producer, e.g. <a href='");
-      out.print(PageHandler.getInstance(request,response).searchpage);
-      out.write("?name=Rieussec'>Rieussec</a> or <a href='");
-      out.print(PageHandler.getInstance(request,response).searchpage);
-      out.write("?name=Gigondas+Guigal'>Gigondas Guigal</a></div>\r\n");
-      out.write("\t\t<input type='image' class='searchgo' src='/css2/searchgo.png' onclick='document.getElementById(\"searchform\").submit()' alt='Search'/>\r\n");
+      out.write("\t\t<div class='explanation'>Enter a wine, store, region or producer name and search in ");
+      out.print(Dbutil.readIntValueFromDB("Select count(*) as thecount from wines","thecount"));
+      out.write(" wine offers, or try our <a style='text-decoration:underline;' href='/wine-guide/'>wine guide</a>.</div>\r\n");
+      out.write("\t\t<input type='image' class='sprite sprite-searchgo searchgo' src='/images/transparent.gif' onclick='document.getElementById(\"searchform\").submit()' alt='Search'/>\r\n");
       out.write("</div>\r\n");
       out.write("</div>\r\n");
       out.write("\r\n");
@@ -386,29 +419,25 @@
       out.write("\r\n");
       out.write("\t\t\t\t");
       out.write("\r\n");
-      out.write("<div class='tips'>\r\n");
+      out.write("<a name=\"tips\"></a><div class='tips'>\r\n");
       out.write("<h2>");
       out.print(PageHandler.getInstance(request,response).t.get("todaystips"));
 if (!PageHandler.getInstance(request,response).thispage.contains("/tips.jsp")) {
-      out.write("  <span class='small'>(<a href='/tips.jsp'>more tips here</a>)</span>");
+      out.write("  <span class='small'>(view <a href='/tips.jsp'>all price drops</a> here)</span>");
 } 
       out.write("</h2>\r\n");
- if (PageHandler.getInstance(request,response).thispage.contains("/tips.jsp")){
-      out.write("\r\n");
       out.write("<p>");
       out.print(PageHandler.getInstance(request,response).t.get("tiptext"));
       out.write("</p>\r\n");
-} 
-      out.write("\r\n");
       out.write("\t\t\t");
 
-			String tips=(Webroutines.getTipsHTML3("", 6,PageHandler.getInstance(request,response).searchdata));
+			String tips=(Webroutines.getTipsHTML3("", 8,PageHandler.getInstance(request,response).searchdata));
 			out.print(tips.equals("") ? ("<br />" + PageHandler.getInstance(request,response).t.get("notips")):(tips));
       out.write('\r');
       out.write('\n');
  if (!PageHandler.getInstance(request,response).thispage.contains("/tips.jsp")){
-      out.write("\r\n");
-      out.write("<div class='tipslink'></div>\r\n");
+      out.write('\r');
+      out.write('\n');
 } 
       out.write("\r\n");
       out.write("</div>\r\n");
@@ -476,6 +505,16 @@
       out.write("\r\n");
       out.write("\t\t<div class='main'>");
       out.write("\r\n");
+      out.write("\r\n");
+ 
+	PageHandler.getInstance(request,response).getLogger().logaction();
+	session.setAttribute("lasturl",PageHandler.getInstance(request,response).thispage);
+	String canonicallink=(String)request.getAttribute("canonicallink");
+	String regionlink=(String)request.getAttribute("regionlink");
+	if (regionlink==null) regionlink="<a href='/region/'>Wines by region</a>";
+
+      out.write("\r\n");
+      out.write("\r\n");
       out.write("<div class='footer'>\r\n");
       out.write("<div id='links'>\r\n");
       out.write("\t\t<a href='/' rel='nofollow'>Home</a>\r\n");
@@ -483,7 +522,10 @@
       out.write("\t\t<a href='/contact.jsp' rel='nofollow'>Contact</a>\r\n");
       out.write("\t\t<a href='/about.jsp' rel='nofollow'>About us</a>\r\n");
       out.write("\t\t<a href='/termsofuse.jsp' rel='nofollow'>Terms of use</a>\r\n");
-      out.write("\t\t<a href='/topwinesindex.jsp' rel='nofollow'>Wine index</a>\r\n");
+      out.print(regionlink);
+      out.write('\r');
+      out.write('\n');
+ if (canonicallink!=null) out.write("<br/>"+canonicallink); 
       out.write("</div>\r\n");
       out.write("\r\n");
       out.write("<div class='clear'></div>\r\n");
@@ -491,13 +533,6 @@
       out.print(java.util.GregorianCalendar.getInstance().get(java.util.GregorianCalendar.YEAR));
       out.write(" Vinopedia.com</div>\r\n");
       out.write("</div>\t\t\t\r\n");
- 
-	PageHandler.getInstance(request,response).getLogger().logaction();
-	PageHandler.getInstance(request,response).firstrequest=false;
-	PageHandler.getInstance(request,response).cleanup();
-	session.setAttribute("lasturl",PageHandler.getInstance(request,response).thispage);
-
-      out.write("\r\n");
       out.write("<script type=\"text/javascript\">\r\n");
       out.write("var gaJsHost = ((\"https:\" == document.location.protocol) ? \"https://ssl.\" : \"http://www.\");\r\n");
       out.write("document.write(unescape(\"%3Cscript src='\" + gaJsHost + \"google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E\"));\r\n");
@@ -505,8 +540,20 @@
       out.write("<script type=\"text/javascript\">\r\n");
       out.write("var pageTracker = _gat._getTracker(\"UA-1788182-2\");\r\n");
       out.write("window.google_analytics_uacct = \"UA-1788182-2\";\r\n");
+      out.print(PageHandler.getInstance(request,response).GAtracking);
+      out.write("\r\n");
+      out.write("pageTracker._setDomainName('");
+      out.print(("DEV".equals(Configuration.serverrole)?"test":"www"));
+      out.write(".vinopedia.com');\r\n");
       out.write("pageTracker._trackPageview();\r\n");
-      out.write("</script>\t\t\t\t");
+      out.write("</script>\t\t\t\r\n");
+PageHandler.getInstance(request,response).firstrequest=false;
+PageHandler.getInstance(request,response).cleanup();
+//for (Cookie cookie:request.getCookies()) {
+//	if (cookie.getName().equals("wineid")||cookie.getName().equals("sort")||cookie.getName().equals("vintage")) {cookie.setMaxAge(0);response.addCookie(cookie);}
+//}
+ 
+      out.write('	');
       out.write("</div>\t\r\n");
 } else { 
 		//Show search results
@@ -516,20 +563,22 @@
       out.write("\r\n");
       out.write("\r\n");
       out.write("<div class='logoandsearch' id='logoandsearch'>\r\n");
-      out.write("\t\t<div class='logo'><a href=\"/\"><img src='/css2/logo.png' alt='Home page'/></a></div>\r\n");
+      out.write("\t\t<div class='logo'><a href=\"/\"><img src='");
+      out.print(Configuration.cdnprefix);
+      out.write("/css2/logo.png' alt='Home page'/></a></div>\r\n");
       out.write("\t\t<div class='search'>\r\n");
       out.write("\t\t<div class='findwine'>");
       out.print(PageHandler.getInstance(request,response).t.get("searchwine"));
       out.write("</div>\r\n");
       out.write("\t\t\t");
-// <img class='searchgosmall' src='/css2/gosmall.jpg' onclick='document.getElementById("searchform").submit()' alt='Search'/>
+// <img class='searchgosmall' alt='Search' src='/css2/gosmall.jpg' onclick='document.getElementById("searchform").submit()' />
       out.write("\r\n");
       out.write("\t\t\t<form action='");
       out.print(PageHandler.getInstance(request,response).searchpage);
-      out.write("' method=\"post\" id=\"searchform\" name=\"searchform\"><input type=\"hidden\" name=\"dosearch\" value=\"true\" /><input class='searchinput' id='name' type='text' autocomplete=\"off\" name=\"name\" value=\"");
+      out.write("' method=\"post\" id=\"searchform\" name=\"searchform\"><input type=\"hidden\" name=\"dosearch\" value=\"true\" /><input class='searchinput' id='name' type='text' name=\"name\" value=\"");
       out.print(Webroutines.escape((PageHandler.getInstance(request,response).searchdata.getName()+" "+PageHandler.getInstance(request,response).searchdata.getVintage()).trim()));
       out.write("\" size=\"25\" /></form>\r\n");
-      out.write("\t\t\t<div class='sprite sprite-gosmall searchgosmall' onclick='document.getElementById(\"searchform\").submit()' alt='Search'></div>\r\n");
+      out.write("\t\t\t<div class='sprite sprite-gosmall searchgosmall' onclick='document.getElementById(\"searchform\").submit()' ></div>\r\n");
       out.write("\t\t</div>\r\n");
       out.write("</div>\r\n");
       out.write('\r');
@@ -552,18 +601,18 @@
 	ArrayList<String> countries = Webroutines.getCountries();
 	if (PageHandler.getInstance(request,response).s.wineset.records>0){
  	
-      out.write("\r\n");
-      out.write("\t<h2 class='refine'>");
+      out.write("<div class='refineheader'>");
       out.print(PageHandler.getInstance(request,response).t.get("refineresults"));
-      out.write("</h2>\r\n");
-      out.write("<div class='refine'>\r\n");
-      out.write("\t<div class='refinel'></div>\r\n");
+      out.write("</div>\r\n");
+      out.write("\t\r\n");
+      out.write("\t<div class='refine spriter-refine spriter'>\r\n");
+      out.write("\t<div class='refinel sprite-refinel sprite'></div>\r\n");
       out.write("\t<div class='refinewines' onclick='javascript:show(\"refinelist\");' onmouseout='javascript:hide(\"refinelist\");'>\r\n");
       out.write("\t\t<div id='refinelist' class='refinelist' onmouseover='show(\"refinelist\");' onmouseout='hide(\"refinelist\");'>");
       out.print(refineHTML );
       out.write("</div>\r\n");
       out.write("\t\t");
-if(!"".equals(refineHTML)) out.write(PageHandler.getInstance(request,response).t.get("wines")+"<img src='/css2/arrowgreen.jpg' alt='refine'/>");
+if(!"".equals(refineHTML)) out.write(PageHandler.getInstance(request,response).t.get("wines")+"<img src='"+Configuration.cdnprefix+"/css2/arrowgreen.jpg' alt='refine'/>");
       out.write("</div>\r\n");
       out.write("\t");
 if(!"".equals(suggestionHTML)){
@@ -573,7 +622,7 @@
       out.print(suggestionHTML );
       out.write("</div>\r\n");
       out.write("\t\t");
-      out.print(PageHandler.getInstance(request,response).t.get("suggestions")+"<img src='/css2/arrowgreen.jpg' alt='suggestions'/>");
+      out.print(PageHandler.getInstance(request,response).t.get("suggestions")+"<img src='"+Configuration.cdnprefix+"/css2/arrowgreen.jpg' alt='suggestions'/>");
       out.write("</div>");
 } 
       out.write("\r\n");
@@ -667,8 +716,10 @@
       out.write("\t\t</div>\r\n");
       out.write("\t\t<input type='hidden' name='keepdata' value='true'/>\t\r\n");
       out.write("\t</form>\t\t\t\t\t\r\n");
-      out.write("\t<div class='refiner'></div>\r\n");
-      out.write("\t<img class='greengo' src='/css2/greengo.jpg' onclick='document.getElementById(\"refineform\").submit()' alt='Go'/>\r\n");
+      out.write("\t<div class='refiner sprite-refiner sprite'></div>\r\n");
+      out.write("\t<img class='greengo' src='");
+      out.print(Configuration.cdnprefix);
+      out.write("/css2/greengo.jpg' onclick='document.getElementById(\"refineform\").submit()' alt='Go'/>\r\n");
       out.write("</div>\r\n");
 } 
       out.write("\r\n");
@@ -697,6 +748,16 @@
       out.write("\r\n");
       out.write("\t\t\t");
       out.write("\r\n");
+      out.write("\r\n");
+ 
+	PageHandler.getInstance(request,response).getLogger().logaction();
+	session.setAttribute("lasturl",PageHandler.getInstance(request,response).thispage);
+	String canonicallink=(String)request.getAttribute("canonicallink");
+	String regionlink=(String)request.getAttribute("regionlink");
+	if (regionlink==null) regionlink="<a href='/region/'>Wines by region</a>";
+
+      out.write("\r\n");
+      out.write("\r\n");
       out.write("<div class='footer'>\r\n");
       out.write("<div id='links'>\r\n");
       out.write("\t\t<a href='/' rel='nofollow'>Home</a>\r\n");
@@ -704,7 +765,10 @@
       out.write("\t\t<a href='/contact.jsp' rel='nofollow'>Contact</a>\r\n");
       out.write("\t\t<a href='/about.jsp' rel='nofollow'>About us</a>\r\n");
       out.write("\t\t<a href='/termsofuse.jsp' rel='nofollow'>Terms of use</a>\r\n");
-      out.write("\t\t<a href='/topwinesindex.jsp' rel='nofollow'>Wine index</a>\r\n");
+      out.print(regionlink);
+      out.write('\r');
+      out.write('\n');
+ if (canonicallink!=null) out.write("<br/>"+canonicallink); 
       out.write("</div>\r\n");
       out.write("\r\n");
       out.write("<div class='clear'></div>\r\n");
@@ -712,13 +776,6 @@
       out.print(java.util.GregorianCalendar.getInstance().get(java.util.GregorianCalendar.YEAR));
       out.write(" Vinopedia.com</div>\r\n");
       out.write("</div>\t\t\t\r\n");
- 
-	PageHandler.getInstance(request,response).getLogger().logaction();
-	PageHandler.getInstance(request,response).firstrequest=false;
-	PageHandler.getInstance(request,response).cleanup();
-	session.setAttribute("lasturl",PageHandler.getInstance(request,response).thispage);
-
-      out.write("\r\n");
       out.write("<script type=\"text/javascript\">\r\n");
       out.write("var gaJsHost = ((\"https:\" == document.location.protocol) ? \"https://ssl.\" : \"http://www.\");\r\n");
       out.write("document.write(unescape(\"%3Cscript src='\" + gaJsHost + \"google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E\"));\r\n");
@@ -726,8 +783,20 @@
       out.write("<script type=\"text/javascript\">\r\n");
       out.write("var pageTracker = _gat._getTracker(\"UA-1788182-2\");\r\n");
       out.write("window.google_analytics_uacct = \"UA-1788182-2\";\r\n");
+      out.print(PageHandler.getInstance(request,response).GAtracking);
+      out.write("\r\n");
+      out.write("pageTracker._setDomainName('");
+      out.print(("DEV".equals(Configuration.serverrole)?"test":"www"));
+      out.write(".vinopedia.com');\r\n");
       out.write("pageTracker._trackPageview();\r\n");
-      out.write("</script>\t\t\t\t");
+      out.write("</script>\t\t\t\r\n");
+PageHandler.getInstance(request,response).firstrequest=false;
+PageHandler.getInstance(request,response).cleanup();
+//for (Cookie cookie:request.getCookies()) {
+//	if (cookie.getName().equals("wineid")||cookie.getName().equals("sort")||cookie.getName().equals("vintage")) {cookie.setMaxAge(0);response.addCookie(cookie);}
+//}
+ 
+      out.write('	');
       out.write("\t\r\n");
       out.write("\t\t\t</div>\r\n");
       out.write("\t\t</div> <!--  main-->\r\n");

=== modified file 'work/org/apache/jsp/moderator/xpathparser_jsp.class'
Binary files work/org/apache/jsp/moderator/xpathparser_jsp.class	2009-09-29 10:20:01 +0000 and work/org/apache/jsp/moderator/xpathparser_jsp.class	2010-09-29 10:08:23 +0000 differ
=== modified file 'work/org/apache/jsp/moderator/xpathparser_jsp.java'
--- work/org/apache/jsp/moderator/xpathparser_jsp.java	2009-08-01 13:25:27 +0000
+++ work/org/apache/jsp/moderator/xpathparser_jsp.java	2010-09-28 10:13:53 +0000
@@ -81,8 +81,8 @@
 				}
 			} else {
 				session.setAttribute("savexp",true);
-				out.write("not yet saved");
-				Dbutil.logger.info("notsaved");
+				out.write("notsaved");
+				//Dbutil.logger.info("notsaved");
 				
 			}
 		}

=== modified file 'work/org/apache/jsp/region/index_jsp.java'
--- work/org/apache/jsp/region/index_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/region/index_jsp.java	2010-09-23 09:57:42 +0000
@@ -187,6 +187,7 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {

=== modified file 'work/org/apache/jsp/settings/login_jsp.java'
--- work/org/apache/jsp/settings/login_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/settings/login_jsp.java	2010-09-29 10:08:23 +0000
@@ -130,6 +130,7 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {

=== modified file 'work/org/apache/jsp/store/index_jsp.java'
--- work/org/apache/jsp/store/index_jsp.java	2010-09-21 09:04:18 +0000
+++ work/org/apache/jsp/store/index_jsp.java	2010-09-23 12:33:21 +0000
@@ -217,6 +217,7 @@
 	if (originalurl==null) originalurl="";	
  
 	String querystring=(String)request.getAttribute("originalQueryString");
+	
 	if (querystring==null||querystring.equals("")) {
 		querystring="";	
 	} else {

=== modified file 'work/org/apache/jsp/testshop_jsp.class'
Binary files work/org/apache/jsp/testshop_jsp.class	2009-09-29 10:20:01 +0000 and work/org/apache/jsp/testshop_jsp.class	2010-09-29 10:08:23 +0000 differ
=== modified file 'work/org/apache/jsp/testshop_jsp.java'
--- work/org/apache/jsp/testshop_jsp.java	2009-08-01 13:25:27 +0000
+++ work/org/apache/jsp/testshop_jsp.java	2010-09-27 16:47:18 +0000
@@ -78,7 +78,7 @@
       out.write("\r\n");
       out.write("<tr><td><a href=\"https://www.vinopedia.com/wine/leoville las cases\">Leoville las Cases</a></td><td>1990</td><td>St. Julien</td><td>120,00</td></tr>\r\n");
       out.write("<tr><td><a href=\"/wine/leoville las cases\">Leoville las Cases</a></td><td>1991</td><td>St. Julien</td><td>40,00</td></tr>\r\n");
-      out.write("<tr><td>Rieussec</td><td>2001</td><td>Sauternes</td><td>150,00</td></tr>\r\n");
+      out.write("<tr><td>Rieussec</td><td>2001</td><td>Sauternes</td><td>&euro; 150,00</td></tr>\r\n");
       out.write("<tr><td>Leoville las Cases</td><td>1993</td><td>St. Julien</td><td>300,00</td></tr>\r\n");
       out.write("<tr><td>Leoville las Cases</td><td>1994</td><td>St. Julien</td><td>500,00</td></tr>\r\n");
       out.write("</table></body></html>");

